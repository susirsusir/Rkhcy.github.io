<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="Less is more">
<meta property="og:type" content="website">
<meta property="og:title" content="HuYounger&#39;s Note">
<meta property="og:url" content="http://rkhcy.github.io/page/2/index.html">
<meta property="og:site_name" content="HuYounger&#39;s Note">
<meta property="og:description" content="Less is more">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HuYounger&#39;s Note">
<meta name="twitter:description" content="Less is more">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rkhcy.github.io/page/2/"/>





  <title>HuYounger's Note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuYounger's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/20/Android DecorView绘制源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/20/Android DecorView绘制源码分析/" itemprop="url">Android DecorView绘制源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-20T00:00:00+08:00">
                2017-05-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/20/Android DecorView绘制源码分析/" class="leancloud_visitors" data-flag-title="Android DecorView绘制源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>通过前面的分析，在Activity中执行setContentView方法后会执行PhoneWindow的setContentView，在该方法中会生成DecorView 组件作为应用窗口的顶层视图，DecorView 是PhoneWindow的内部类，继承至FrameLayout，DecorView 会添加一个id为content的FrameLayout作为根布局，Activity的xml文件通过LayoutInflater的inflate方法解析成View树添加到id为content的FrameLayout中，那么这里的DecorView是怎么被添加到窗口并显示出来的呢？</p>
<h2 id="ActivityThread-handleResumeActivity"><a href="#ActivityThread-handleResumeActivity" class="headerlink" title="ActivityThread handleResumeActivity()"></a>ActivityThread handleResumeActivity()</h2><p>Activity的启动流程学习作为将来的TODO项目，在ActivityThread中，当activity对象被创建完毕后，会调用handleResumeActivity方法将顶层视图DecorView添加到PhoneWindow窗口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line">源码路径：SDK/sources/android-24/android/app/ActivityThread.java</div><div class="line">    final void handleResumeActivity(IBinder token,</div><div class="line">            boolean clearHide, boolean isForward, boolean reallyResume, int seq, String reason) &#123;</div><div class="line">        //ActivityClientRecord对象保存了Activity的信息</div><div class="line">        ActivityClientRecord r = mActivities.get(token);</div><div class="line">        if (!checkAndUpdateLifecycleSeq(seq, r, &quot;resumeActivity&quot;)) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If we are getting ready to gc after going to the background, well</div><div class="line">        // we are back active so skip it.</div><div class="line">        unscheduleGcIdler();</div><div class="line">        mSomeActivitiesChanged = true;</div><div class="line"></div><div class="line">        // TODO Push resumeArgs into the activity for consideration</div><div class="line">        r = performResumeActivity(token, clearHide, reason);</div><div class="line"></div><div class="line">        if (r != null) &#123;</div><div class="line">            //获取Activity对象</div><div class="line">            final Activity a = r.activity;</div><div class="line"></div><div class="line">            final int forwardBit = isForward ?</div><div class="line">                    WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : 0;</div><div class="line"></div><div class="line">            // If the window hasn&apos;t yet been added to the window manager,</div><div class="line">            // and this guy didn&apos;t finish itself or start another activity,</div><div class="line">            // then go ahead and add the window.</div><div class="line">            boolean willBeVisible = !a.mStartedActivity;</div><div class="line">            if (!willBeVisible) &#123;</div><div class="line">                try &#123;</div><div class="line">                    willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(</div><div class="line">                            a.getActivityToken());</div><div class="line">                &#125; catch (RemoteException e) &#123;</div><div class="line">                    throw e.rethrowFromSystemServer();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</div><div class="line">                //获取Activity对应的PhoneWindow对象</div><div class="line">                r.window = r.activity.getWindow();</div><div class="line">                //获取顶层布局DecorView对象</div><div class="line">                View decor = r.window.getDecorView();</div><div class="line">                //设为不可见</div><div class="line">                decor.setVisibility(View.INVISIBLE);</div><div class="line">                //获取WindowManager</div><div class="line">                ViewManager wm = a.getWindowManager();</div><div class="line">                //获取PhoneWindow的LayoutParams</div><div class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">                a.mDecor = decor;</div><div class="line">                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</div><div class="line">                l.softInputMode |= forwardBit;</div><div class="line">                if (r.mPreserveWindow) &#123;</div><div class="line">                    a.mWindowAdded = true;</div><div class="line">                    r.mPreserveWindow = false;</div><div class="line">                    // Normally the ViewRoot sets up callbacks with the Activity</div><div class="line">                    // in addView-&gt;ViewRootImpl#setView. If we are instead reusing</div><div class="line">                    // the decor view we have to notify the view root that the</div><div class="line">                    // callbacks may have changed.</div><div class="line">                    ViewRootImpl impl = decor.getViewRootImpl();</div><div class="line">                    if (impl != null) &#123;</div><div class="line">                        impl.notifyChildRebuilt();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                if (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</div><div class="line">                    //DecorView已经添加到窗口</div><div class="line">                    a.mWindowAdded = true;</div><div class="line">                    //将顶层布局DecorView添加到窗口中</div><div class="line">                    wm.addView(decor, l);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            // If the window has already been added, but during resume</div><div class="line">            // we started another activity, then don&apos;t yet make the</div><div class="line">            // window visible.</div><div class="line">            &#125; else if (!willBeVisible) &#123;</div><div class="line">                r.hideForNow = true;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Get rid of anything left hanging around.</div><div class="line">            cleanUpPendingRemoveWindows(r, false /* force */);</div><div class="line"></div><div class="line">            // The window is now visible if it has been added, we are not</div><div class="line">            // simply finishing, and we are not starting another activity.</div><div class="line">            if (!r.activity.mFinished &amp;&amp; willBeVisible</div><div class="line">                    &amp;&amp; r.activity.mDecor != null &amp;&amp; !r.hideForNow) &#123;</div><div class="line">                if (r.newConfig != null) &#123;</div><div class="line">                    performConfigurationChangedForActivity(r, r.newConfig, REPORT_TO_ACTIVITY);</div><div class="line">                    r.newConfig = null;</div><div class="line">                &#125;</div><div class="line">                WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">                if ((l.softInputMode</div><div class="line">                        &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</div><div class="line">                        != forwardBit) &#123;</div><div class="line">                    l.softInputMode = (l.softInputMode</div><div class="line">                            &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</div><div class="line">                            | forwardBit;</div><div class="line">                    if (r.activity.mVisibleFromClient) &#123;</div><div class="line">                        ViewManager wm = a.getWindowManager();</div><div class="line">                        View decor = r.window.getDecorView();</div><div class="line">                        wm.updateViewLayout(decor, l);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                r.activity.mVisibleFromServer = true;</div><div class="line">                mNumVisibleActivities++;</div><div class="line">                if (r.activity.mVisibleFromClient) &#123;</div><div class="line">                    //设置顶层布局DecorView可见</div><div class="line">                    r.activity.makeVisible();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (!r.onlyLocalRequest) &#123;</div><div class="line">                r.nextIdle = mNewActivities;</div><div class="line">                mNewActivities = r;</div><div class="line">                Looper.myQueue().addIdleHandler(new Idler());</div><div class="line">            &#125;</div><div class="line">            r.onlyLocalRequest = false;</div><div class="line"></div><div class="line">            // Tell the activity manager we have resumed.</div><div class="line">            if (reallyResume) &#123;</div><div class="line">                try &#123;</div><div class="line">                    ActivityManagerNative.getDefault().activityResumed(token);</div><div class="line">                &#125; catch (RemoteException ex) &#123;</div><div class="line">                    throw ex.rethrowFromSystemServer();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; else &#123;</div><div class="line">            // If an exception was thrown when trying to resume, then</div><div class="line">            // just end this activity.</div><div class="line">            try &#123;</div><div class="line">                ActivityManagerNative.getDefault()</div><div class="line">                    .finishActivity(token, Activity.RESULT_CANCELED, null,</div><div class="line">                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</div><div class="line">            &#125; catch (RemoteException ex) &#123;</div><div class="line">                throw ex.rethrowFromSystemServer();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="WindowManagerImpl-addView"><a href="#WindowManagerImpl-addView" class="headerlink" title="WindowManagerImpl addView()"></a>WindowManagerImpl addView()</h2><p>通过wm的addView方法，传入顶层视图DecorView和LayoutParams，将顶层布局DecorView添加到窗口中。这里的vm是ViewManager，具体实现是WindowManagerImpl类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">关系:</div><div class="line">public interface WindowManager extends ViewManager </div><div class="line">public final class WindowManagerImpl implements WindowManager</div><div class="line"></div><div class="line">源码路径: SDK/sources/android-24/android/view/WindowManagerImpl.java</div><div class="line">    public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) &#123;</div><div class="line">        applyDefaultToken(params);</div><div class="line">        mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里直接调用了mGlobal的addView方法，继续跟进去看下</p>
<h2 id="WindowManagerGlobal-addView"><a href="#WindowManagerGlobal-addView" class="headerlink" title="WindowManagerGlobal addView()"></a>WindowManagerGlobal addView()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">源码路径: SDK/sources/android-24/android/view/WindowManagerGlobal.java</div><div class="line"></div><div class="line">    public void addView(View view, ViewGroup.LayoutParams params,</div><div class="line">            Display display, Window parentWindow) &#123;</div><div class="line"></div><div class="line">        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">        if (parentWindow != null) &#123;</div><div class="line">            parentWindow.adjustLayoutParamsForSubWindow(wparams);</div><div class="line">        &#125; else &#123;</div><div class="line">            // If there&apos;s no parent, then hardware acceleration for this view is</div><div class="line">            // set from the application&apos;s hardware acceleration setting.</div><div class="line">            final Context context = view.getContext();</div><div class="line">            if (context != null</div><div class="line">                    &amp;&amp; (context.getApplicationInfo().flags</div><div class="line">                            &amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) &#123;</div><div class="line">                wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ViewRootImpl root;</div><div class="line">        View panelParentView = null;</div><div class="line"></div><div class="line">        synchronized (mLock) &#123;</div><div class="line">            // Start watching for system property changes.</div><div class="line">            if (mSystemPropertyUpdater == null) &#123;</div><div class="line">                mSystemPropertyUpdater = new Runnable() &#123;</div><div class="line">                    @Override public void run() &#123;</div><div class="line">                        synchronized (mLock) &#123;</div><div class="line">                            for (int i = mRoots.size() - 1; i &gt;= 0; --i) &#123;</div><div class="line">                                mRoots.get(i).loadSystemProperties();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line">                SystemProperties.addChangeCallback(mSystemPropertyUpdater);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            int index = findViewLocked(view, false);</div><div class="line">            if (index &gt;= 0) &#123;</div><div class="line">                if (mDyingViews.contains(view)) &#123;</div><div class="line">                    // Don&apos;t wait for MSG_DIE to make it&apos;s way through root&apos;s queue.</div><div class="line">                    mRoots.get(index).doDie();</div><div class="line">                &#125; else &#123;</div><div class="line">                    throw new IllegalStateException(&quot;View &quot; + view</div><div class="line">                            + &quot; has already been added to the window manager.&quot;);</div><div class="line">                &#125;</div><div class="line">                // The previous removeView() had not completed executing. Now it has.</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // If this is a panel window, then find the window it is being</div><div class="line">            // attached to for future reference.</div><div class="line">            if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</div><div class="line">                    wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) &#123;</div><div class="line">                final int count = mViews.size();</div><div class="line">                for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">                    if (mRoots.get(i).mWindow.asBinder() == wparams.token) &#123;</div><div class="line">                        panelParentView = mViews.get(i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //实例化ViewRootImpl对象</div><div class="line">            root = new ViewRootImpl(view.getContext(), display);</div><div class="line">            //顶层视图DecorView设置LayoutParams</div><div class="line">            view.setLayoutParams(wparams);</div><div class="line"></div><div class="line">            mViews.add(view);</div><div class="line">            mRoots.add(root);</div><div class="line">            mParams.add(wparams);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // do this last because it fires off messages to start doing things</div><div class="line">        try &#123;</div><div class="line">            //将顶层视图DecorView添加到root中</div><div class="line">            root.setView(view, wparams, panelParentView);</div><div class="line">        &#125; catch (RuntimeException e) &#123;</div><div class="line">            // BadTokenException or InvalidDisplayException, clean up.</div><div class="line">            synchronized (mLock) &#123;</div><div class="line">                final int index = findViewLocked(view, false);</div><div class="line">                if (index &gt;= 0) &#123;</div><div class="line">                    removeViewLocked(index, true);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            throw e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="ViewRootImpl-setView"><a href="#ViewRootImpl-setView" class="headerlink" title="ViewRootImpl setView()"></a>ViewRootImpl setView()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">源码路径: SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    /**</div><div class="line">     * We have one child</div><div class="line">     */</div><div class="line">        public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123;</div><div class="line">        synchronized (this) &#123;</div><div class="line">            if (mView == null) &#123;</div><div class="line">                mView = view;</div><div class="line">                ......</div><div class="line">                mAdded = true;</div><div class="line">                ......</div><div class="line">                // Schedule the first layout -before- adding to the window</div><div class="line">                // manager, to make sure we do the relayout before receiving</div><div class="line">                // any other events from the system.</div><div class="line">                requestLayout();</div><div class="line">                ......</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>该方法代码有点长，将DecorView赋给这里的View，并标记DecorView已添加到ViewRootImpl，之后调用requestLayout请求布局。</p>
<h2 id="ViewRootImpl-requestLayout"><a href="#ViewRootImpl-requestLayout" class="headerlink" title="ViewRootImpl requestLayout()"></a>ViewRootImpl requestLayout()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void requestLayout() &#123;</div><div class="line">    if (!mHandlingLayoutInLayoutRequest) &#123;</div><div class="line">        checkThread();</div><div class="line">        mLayoutRequested = true;</div><div class="line">        scheduleTraversals();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ViewRootImpl-scheduleTraversals"><a href="#ViewRootImpl-scheduleTraversals" class="headerlink" title="ViewRootImpl scheduleTraversals()"></a>ViewRootImpl scheduleTraversals()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">void scheduleTraversals() &#123;</div><div class="line">    if (!mTraversalScheduled) &#123;</div><div class="line">        mTraversalScheduled = true;</div><div class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</div><div class="line">        mChoreographer.postCallback(</div><div class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);</div><div class="line">        if (!mUnbufferedInputDispatch) &#123;</div><div class="line">            scheduleConsumeBatchedInput();</div><div class="line">        &#125;</div><div class="line">        notifyRendererOfFramePending();</div><div class="line">        pokeDrawLockIfNeeded();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在该方法中把mTraversalRunnable post到消息队列中，查看Choreographer的postCallback方法，最终会调用到postCallbackDelayedInternal，实质还是通过Handler来处理，查看下mTraversalRunnable 做了什么</p>
<h2 id="ViewRootImpl-TraversalRunnable"><a href="#ViewRootImpl-TraversalRunnable" class="headerlink" title="ViewRootImpl TraversalRunnable"></a>ViewRootImpl TraversalRunnable</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">final class TraversalRunnable implements Runnable &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        doTraversal();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ViewRootImpl-doTraversal"><a href="#ViewRootImpl-doTraversal" class="headerlink" title="ViewRootImpl doTraversal()"></a>ViewRootImpl doTraversal()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">void doTraversal() &#123;</div><div class="line">    if (mTraversalScheduled) &#123;</div><div class="line">        mTraversalScheduled = false;</div><div class="line">        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</div><div class="line"></div><div class="line">        if (mProfile) &#123;</div><div class="line">            Debug.startMethodTracing(&quot;ViewAncestor&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        performTraversals();</div><div class="line"></div><div class="line">        if (mProfile) &#123;</div><div class="line">            Debug.stopMethodTracing();</div><div class="line">            mProfile = false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里会调用performTraversals()，performTraversals()负责整个View树的绘制流程，是很关键的一步，之后结合自定义View分析。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上面的分析，在ActivityThread中，当activity对象创建完毕后，会将DecorView添加到Window中，同时会创建 ViewRootImpl 对象，并将 ViewRootImpl 对象和 DecorView 建立关联，最终由ViewRootImpl负责整个View树的绘制。</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/DecorView.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/DecorView.png" alt="img"></a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/17/Android LayoutInflater源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/17/Android LayoutInflater源码分析/" itemprop="url">Android LayoutInflater源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-17T00:00:00+08:00">
                2017-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/17/Android LayoutInflater源码分析/" class="leancloud_visitors" data-flag-title="Android LayoutInflater源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在初学Android的时候LayoutInflater是经常用到的一个类，例如在ListView的getView方法，LayoutInflater的作用主要是用来加载布局。上篇在介绍到Activity通过调用setContentView加载布局，通过阅读源码发现其内部还是调用LayoutInflater的inflate方法，继续阅读源码看看内部具体的实现原理。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line">    private ListView mListView;</div><div class="line">    private MyAdapter mMyAdapter;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        mListView = (ListView) findViewById(R.id.listview);</div><div class="line">        mMyAdapter = new MyAdapter(this);</div><div class="line">        mListView.setAdapter(mMyAdapter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyAdapter.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class MyAdapter extends BaseAdapter &#123;</div><div class="line">    private LayoutInflater mLayoutInflater;</div><div class="line">    public MyAdapter(Context context)&#123;</div><div class="line">        mLayoutInflater = LayoutInflater.from(context);</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public int getCount() &#123;</div><div class="line">        return 8;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Object getItem(int position) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public long getItemId(int position) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public View getView(int position, View convertView, ViewGroup parent) &#123;</div><div class="line">        View v0 = mLayoutInflater.inflate(R.layout.item_listview, null);</div><div class="line">        View v1 = mLayoutInflater.inflate(R.layout.item_listview, null, false);</div><div class="line">        View v2 = mLayoutInflater.inflate(R.layout.item_listview, null, true);</div><div class="line">        //View v3 = mLayoutInflater.inflate(R.layout.item_listview, parent);</div><div class="line">        View v3 = mLayoutInflater.inflate(R.layout.item_listview, parent, false);</div><div class="line">        //View v3 = mLayoutInflater.inflate(R.layout.item_listview, parent, true);</div><div class="line"></div><div class="line">        View v4 = mLayoutInflater.inflate(R.layout.item_listview_parent, null);</div><div class="line">        View v5 = mLayoutInflater.inflate(R.layout.item_listview_parent, null, false);</div><div class="line">        View v6 = mLayoutInflater.inflate(R.layout.item_listview_parent, null, true);</div><div class="line">        //View v7 = mLayoutInflater.inflate(R.layout.item_listview_parent, parent);</div><div class="line">        View v7 = mLayoutInflater.inflate(R.layout.item_listview_parent, parent, false);</div><div class="line">        //View v7 = mLayoutInflater.inflate(R.layout.item_listview_parent, parent, true);</div><div class="line">        View[] viewLists = &#123;v0, v1, v2, v3, v4, v5, v6, v7&#125;;</div><div class="line">        convertView = viewLists[position];</div><div class="line">        ViewGroup.LayoutParams layoutParams = convertView.getLayoutParams();</div><div class="line">        if (layoutParams == null) &#123;</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;position &quot; + position + &quot; layoutParams is null&quot; );</div><div class="line">        &#125; else &#123;</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;position &quot; + position + &quot; layoutParams.width is: &quot; + layoutParams.width + &quot; layoutParams.height is: &quot; + layoutParams.height);</div><div class="line">        &#125;</div><div class="line">        return convertView;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;android.support.constraint.ConstraintLayout</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.hcy.layoutinflaterdemo.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ListView</div><div class="line">        android:id=&quot;@+id/listview&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">&lt;/android.support.constraint.ConstraintLayout&gt;</div></pre></td></tr></table></figure>
<p>item_listview.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;TextView android:id=&quot;@+id/list_item&quot;</div><div class="line">    android:layout_width=&quot;100dp&quot;</div><div class="line">    android:layout_height=&quot;50dp&quot;</div><div class="line">    android:text=&quot;Hello World&quot;</div><div class="line">    android:background=&quot;@android:color/holo_purple&quot;</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; /&gt;</div></pre></td></tr></table></figure>
<p>item_listview_parent.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:background=&quot;@android:color/holo_purple&quot;&gt;</div><div class="line">    &lt;TextView</div><div class="line">        android:id=&quot;@+id/text&quot;</div><div class="line">        android:layout_height=&quot;50dp&quot;</div><div class="line">        android:layout_width=&quot;100dp&quot;</div><div class="line">        android:text=&quot;Hello World&quot;</div><div class="line">        android:background=&quot;@android:color/holo_orange_dark&quot;/&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>该Demo比较简单，写这个Demo的主要目的是要搞清楚inflate方法的参数设置给布局带来的影响，这也是自己一直没记清楚的地方。</p>
<p>运行结果</p>
<p>​    <img src="http://7xjvg5.com1.z0.glb.clouddn.com/LayoutInflater2.png" style="zoom:25%"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>显示的结果很奇怪，疑问如下：</p>
<ul>
<li>position0-2item我明明指定的width和height分别是100dp和50dp，为什么width显示成match_parent，高度也不对？而且第三个参数有没有好像不影响显示</li>
<li>position4-6item的LinearLayout的width和height分别是wrap_content，为什么宽显示成match_parent</li>
<li>在调试的时候若把MyAdapter中注释的几行打开会报错<code>Caused by: java.lang.UnsupportedOperationException: addView(View, LayoutParams) is not supported in AdapterView</code></li>
</ul>
<p>Why?</p>
<h2 id="LayoutInflater源码分析"><a href="#LayoutInflater源码分析" class="headerlink" title="LayoutInflater源码分析"></a>LayoutInflater源码分析</h2><p>首先看下获取LayoutInflater实例的地方，在MyAdapter中通过<br>LayoutInflater.from(context)获取，那这里的from方法具体又干了什么?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">源码路径：sdk/sources/android-25/android/view/LayoutInflater.java</div><div class="line">    /**</div><div class="line">     * Obtains the LayoutInflater from the given context.</div><div class="line">     */</div><div class="line">    public static LayoutInflater from(Context context) &#123;</div><div class="line">        LayoutInflater LayoutInflater =</div><div class="line">                (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">        if (LayoutInflater == null) &#123;</div><div class="line">            throw new AssertionError(&quot;LayoutInflater not found.&quot;);</div><div class="line">        &#125;</div><div class="line">        return LayoutInflater;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从这里的源码看到获取LayoutInflater实例的另外一种写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LayoutInflater LayoutInflater =</div><div class="line">                (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div></pre></td></tr></table></figure>
<p>获取实例之后调用inflate方法，传入xml布局让它帮忙加载，inflate方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root) &#123;</div><div class="line">    return inflate(resource, root, root != null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发现该方法会调用包含3个参数的方法，第三个参数的值取决于第二参数root是否为null</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) &#123;</div><div class="line">    final Resources res = getContext().getResources();</div><div class="line">    if (DEBUG) &#123;</div><div class="line">        Log.d(TAG, &quot;INFLATING from resource: \&quot;&quot; + res.getResourceName(resource) + &quot;\&quot; (&quot;</div><div class="line">                + Integer.toHexString(resource) + &quot;)&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final XmlResourceParser parser = res.getLayout(resource);</div><div class="line">    try &#123;</div><div class="line">        return inflate(parser, root, attachToRoot);</div><div class="line">    &#125; finally &#123;</div><div class="line">        parser.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过Resources获取一个XmlResourceParser(LayoutInflater是使用pull解析方式来解析xml)，接着又把第一个参数由int改成XmlResourceParser，继续调用inflate方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</div><div class="line">    synchronized (mConstructorArgs) &#123;</div><div class="line"></div><div class="line">        final Context inflaterContext = mContext;</div><div class="line">        final AttributeSet attrs = Xml.asAttributeSet(parser);</div><div class="line">        Context lastContext = (Context) mConstructorArgs[0];</div><div class="line">        mConstructorArgs[0] = inflaterContext;</div><div class="line">        //该方法的返回值，初始化为我们传入的第二个参数root</div><div class="line">        View result = root;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            // Look for the root node.</div><div class="line">            int type;</div><div class="line">            while ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</div><div class="line">                    type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">                // Empty</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (type != XmlPullParser.START_TAG) &#123;</div><div class="line">                throw new InflateException(parser.getPositionDescription()</div><div class="line">                        + &quot;: No start tag found!&quot;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final String name = parser.getName();</div><div class="line"></div><div class="line">            if (TAG_MERGE.equals(name)) &#123;</div><div class="line">            	//如果标签是merge则root不能为空且attachToRoot必须为true，否则会抛异常(merge标签用于xml性能优化)</div><div class="line">                if (root == null || !attachToRoot) &#123;</div><div class="line">                    throw new InflateException(&quot;&lt;merge /&gt; can be used only with a valid &quot;</div><div class="line">                            + &quot;ViewGroup root and attachToRoot=true&quot;);</div><div class="line">                &#125;</div><div class="line">                //遍历加载子元素view</div><div class="line">                rInflate(parser, root, inflaterContext, attrs, false);</div><div class="line">            &#125; else &#123;</div><div class="line">                // Temp is the root view that was found in the xml</div><div class="line">                //根据tag名称生成xml中的root View对象</div><div class="line">                final View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line"></div><div class="line">                ViewGroup.LayoutParams params = null;</div><div class="line"></div><div class="line">                if (root != null) &#123;</div><div class="line">                    // Create layout params that match root, if supplied</div><div class="line">                    //生成root的LayoutParams</div><div class="line">                    params = root.generateLayoutParams(attrs);</div><div class="line">                    if (!attachToRoot) &#123;</div><div class="line">                        // Set the layout params for temp if we are not</div><div class="line">                        // attaching. (If we are, we use addView, below)</div><div class="line">                        //第三个参数attachToRoot为false时执行View的setLayoutParams</div><div class="line">                        temp.setLayoutParams(params);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Inflate all children under temp against its context.</div><div class="line">                //遍历解析temp下的子View</div><div class="line">                rInflateChildren(parser, temp, attrs, true);</div><div class="line"></div><div class="line">                // We are supposed to attach all the views we found (int temp)</div><div class="line">                // to root. Do that now.</div><div class="line">                if (root != null &amp;&amp; attachToRoot) &#123;</div><div class="line">                //第二个参数root非空且第三个参数attachToRoot为true则把xml解析完成的view添加到root中</div><div class="line">                    root.addView(temp, params);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Decide whether to return the root that was passed in or the</div><div class="line">                // top view found in xml.</div><div class="line">                if (root == null || !attachToRoot) &#123;</div><div class="line">                    //第二个参数root为空或第三个参数attachToRoot为false时返回xml中解析的root view</div><div class="line">                    result = temp;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; catch (XmlPullParserException e) &#123;</div><div class="line">            final InflateException ie = new InflateException(e.getMessage(), e);</div><div class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</div><div class="line">            throw ie;</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            final InflateException ie = new InflateException(parser.getPositionDescription()</div><div class="line">                    + &quot;: &quot; + e.getMessage(), e);</div><div class="line">            ie.setStackTrace(EMPTY_STACK_TRACE);</div><div class="line">            throw ie;</div><div class="line">        &#125; finally &#123;</div><div class="line">            // Don&apos;t retain static reference on context.</div><div class="line">            mConstructorArgs[0] = lastContext;</div><div class="line">            mConstructorArgs[1] = null;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>删掉一些不影响阅读的DEBUG日志后开始分析该方法，在37行传入节点名称通过createViewFromTag方法生成根布局的实例，createViewFromTag()方法内部又会去调用createView()方法，然后通过反射的方式创建出View的实例并返回。根布局解析完成后，55行调用rInflateChildren方法解析根布局下的子View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">final void rInflateChildren(XmlPullParser parser, View parent, AttributeSet attrs,</div><div class="line">        boolean finishInflate) throws XmlPullParserException, IOException &#123;</div><div class="line">    rInflate(parser, parent, parent.getContext(), attrs, finishInflate);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void rInflate(XmlPullParser parser, View parent, Context context,</div><div class="line">        AttributeSet attrs, boolean finishInflate) throws XmlPullParserException, IOException &#123;</div><div class="line"></div><div class="line">    final int depth = parser.getDepth();</div><div class="line">    int type;</div><div class="line"></div><div class="line">    while (((type = parser.next()) != XmlPullParser.END_TAG ||</div><div class="line">            parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line"></div><div class="line">        if (type != XmlPullParser.START_TAG) &#123;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final String name = parser.getName();</div><div class="line">        </div><div class="line">        if (TAG_REQUEST_FOCUS.equals(name)) &#123;</div><div class="line">            parseRequestFocus(parser, parent);</div><div class="line">        &#125; else if (TAG_TAG.equals(name)) &#123;</div><div class="line">            parseViewTag(parser, parent, attrs);</div><div class="line">        &#125; else if (TAG_INCLUDE.equals(name)) &#123;</div><div class="line">            if (parser.getDepth() == 0) &#123;</div><div class="line">                throw new InflateException(&quot;&lt;include /&gt; cannot be the root element&quot;);</div><div class="line">            &#125;</div><div class="line">            parseInclude(parser, context, parent, attrs);</div><div class="line">        &#125; else if (TAG_MERGE.equals(name)) &#123;</div><div class="line">            throw new InflateException(&quot;&lt;merge /&gt; must be the root element&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            final View view = createViewFromTag(parent, name, context, attrs);</div><div class="line">            final ViewGroup viewGroup = (ViewGroup) parent;</div><div class="line">            final ViewGroup.LayoutParams params = viewGroup.generateLayoutParams(attrs);</div><div class="line">            rInflateChildren(parser, view, attrs, true);</div><div class="line">            viewGroup.addView(view, params);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (finishInflate) &#123;</div><div class="line">        parent.onFinishInflate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据不同的tag做不同的解析，如果不是requestFocus 、tag 、include、merge就调用 createViewFromTag()方法，然后循环rInflateChildren()，直到解析出所有View，最后会把最顶层的根布局返回，至此inflate()完成。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>源码也看完了，现在回头来看下我们的例子显示的原因。</p>
<p>分析1：position0-2item的布局是一个TextView，inflate方法的第二个参数为null，根据上面的分析，可以简化成下面的代码流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final View temp = createViewFromTag(root, name, inflaterContext, attrs)；</div><div class="line">if (root == null || !attachToRoot) &#123;</div><div class="line">    result = temp;</div><div class="line">&#125;</div><div class="line">return result;</div></pre></td></tr></table></figure>
<p>这里temp的LayoutParams并没有实例化，所以为null，因此不管设置宽高为多少都不能正常显示，那为什么它默认显示宽为match_parent呢？<br>ListView extends AbsListView，AbsListView extends AdapterView，在AbsListView 中有这几个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Get a view and have it show the data associated with the specified</div><div class="line"> * position. This is called when we have already discovered that the view is</div><div class="line"> * not available for reuse in the recycle bin. The only choices left are</div><div class="line"> * converting an old view or making a new one.</div><div class="line"> *</div><div class="line"> * @param position The position to display</div><div class="line"> * @param isScrap Array of at least 1 boolean, the first entry will become true if</div><div class="line"> *                the returned view was taken from the &quot;temporary detached&quot; scrap heap, false if</div><div class="line"> *                otherwise.</div><div class="line"> *</div><div class="line"> * @return A view displaying the data associated with the specified position</div><div class="line"> */</div><div class="line">View obtainView(int position, boolean[] isScrap) &#123;</div><div class="line">    ......</div><div class="line">    setItemViewLayoutParams(child, position);</div><div class="line">    ......</div><div class="line">    return child;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void setItemViewLayoutParams(View child, int position) &#123;</div><div class="line">    final ViewGroup.LayoutParams vlp = child.getLayoutParams();</div><div class="line">    LayoutParams lp;</div><div class="line">    if (vlp == null) &#123;</div><div class="line">        lp = (LayoutParams) generateDefaultLayoutParams();</div><div class="line">    &#125; else if (!checkLayoutParams(vlp)) &#123;</div><div class="line">        lp = (LayoutParams) generateLayoutParams(vlp);</div><div class="line">    &#125; else &#123;</div><div class="line">        lp = (LayoutParams) vlp;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (mAdapterHasStableIds) &#123;</div><div class="line">        lp.itemId = mAdapter.getItemId(position);</div><div class="line">    &#125;</div><div class="line">    lp.viewType = mAdapter.getItemViewType(position);</div><div class="line">    lp.isEnabled = mAdapter.isEnabled(position);</div><div class="line">    if (lp != vlp) &#123;</div><div class="line">      child.setLayoutParams(lp);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected ViewGroup.LayoutParams generateDefaultLayoutParams() &#123;</div><div class="line">    return new AbsListView.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT,</div><div class="line">            ViewGroup.LayoutParams.WRAP_CONTENT, 0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过这里的代码发现如果Item的layoutParams属性为null，默认为其设置一个宽度为match_parent，高度为wrap_content的layoutParams属性，因此position0-2item显示成那样就说得通了。</p>
<p>分析2：position3item布局是一个TextView，第二个参数root不为null，第三个参数为false，可以简化成下面的代码流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">final View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line">ViewGroup.LayoutParams params = null;</div><div class="line">if (root != null) &#123;</div><div class="line">    // Create layout params that match root, if supplied</div><div class="line">    params = root.generateLayoutParams(attrs);</div><div class="line">    if (!attachToRoot) &#123;</div><div class="line">        // Set the layout params for temp if we are not</div><div class="line">        // attaching. (If we are, we use addView, below)</div><div class="line">        temp.setLayoutParams(params);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的root就是ListView，在它的父类AbsListView中找到generateLayoutParams方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected ViewGroup.LayoutParams generateLayoutParams(ViewGroup.LayoutParams p) &#123;</div><div class="line">    return new LayoutParams(p);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实就是对LayoutParams初始化，后面temp再根据这里的LayoutParams加载布局，因此能够正常显示。</p>
<p>分析3：position4-6item由LinearLayout包裹TextView组成，同样第二个参数root为null，与上面0-2item一样，LayoutParams没有实例化，所以最外层的layout_width、layout_height属性失效，但是它内部的TextView的属性是有效的，从图显示也可以看出TextView大小符合我们设置的大小。<br>分析4：position7item由LinearLayout包裹TextView组成，第二个参数root不为null，第三个参数为false，与上面分析2相同，设置了LayoutParams，宽高取决于TextView的layout_width、layout_height大小<br>分析5：打开注释会报错分析，这种情况是第二个参数不为null，第三个参数为true，可以简化成下面的流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">final View temp = createViewFromTag(root, name, inflaterContext, attrs);</div><div class="line">ViewGroup.LayoutParams params = root.generateLayoutParams(attrs);</div><div class="line">if (root != null &amp;&amp; attachToRoot) &#123;</div><div class="line">    root.addView(temp, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的root就是ListView，在它里面没有找到addView方法，再向上找，在AdapterView中的addView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void addView(View child, LayoutParams params) &#123;</div><div class="line">    throw new UnsupportedOperationException(&quot;addView(View, LayoutParams) &quot;</div><div class="line">            + &quot;is not supported in AdapterView&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以会报错</p>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>程序中的日志如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">05-17 00:15:55.504 18458 18458 D hcy     : position 0 layoutParams is null</div><div class="line">05-17 00:15:55.516 18458 18458 D hcy     : position 1 layoutParams is null</div><div class="line">05-17 00:15:55.522 18458 18458 D hcy     : position 2 layoutParams is null</div><div class="line">05-17 00:15:55.525 18458 18458 D hcy     : position 3 layoutParams.width is: 263 layoutParams.height is: 131</div><div class="line">05-17 00:15:55.534 18458 18458 D hcy     : position 4 layoutParams is null</div><div class="line">05-17 00:15:55.538 18458 18458 D hcy     : position 5 layoutParams is null</div><div class="line">05-17 00:15:55.542 18458 18458 D hcy     : position 6 layoutParams is null</div><div class="line">05-17 00:15:55.544 18458 18458 D hcy     : position 7 layoutParams.width is: -2 layoutParams.height is: -2</div></pre></td></tr></table></figure>
<p>这也印证了当第二个参数为null时，layoutParams为null，其次item3的宽高根据不同设备显示值也有所不同，最后item7显示-2是几个意思？在ViewGroup中定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static final int WRAP_CONTENT = -2;</div></pre></td></tr></table></figure>
<h2 id="随便提一下"><a href="#随便提一下" class="headerlink" title="随便提一下"></a>随便提一下</h2><p>在Activity中指定布局文件的时候，最外层的那个布局是可以指定大小的，layout_width和layout_height都是有作用的，根据上一篇的分析知道Android会自动在布局文件的最外层再嵌套一个FrameLayout，代码其实是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mLayoutInflater.inflate(layoutResID, mContentParent);</div></pre></td></tr></table></figure>
<p>这里的mContentParent是FrameLayout不为null，又回到上面的分析，那它为啥不报错呢？<br>在FrameLayout中没找到addView方法，继续向上查找，在它爹ViewGroup中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public void addView(View child) &#123;</div><div class="line">    addView(child, -1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void addView(View child, int index) &#123;</div><div class="line">    if (child == null) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;Cannot add a null child view to a ViewGroup&quot;);</div><div class="line">    &#125;</div><div class="line">    LayoutParams params = child.getLayoutParams();</div><div class="line">    if (params == null) &#123;</div><div class="line">        params = generateDefaultLayoutParams();</div><div class="line">        if (params == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;generateDefaultLayoutParams() cannot return null&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    addView(child, index, params);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以不会报错。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>如果root为null，attachToRoot将失去作用，设置任何值都没有意义，加载的布局文件最外层的所有layout属性会失效，由父布局来默认指定.</li>
<li>如果root不为null，未设置attachToRoot，attachToRoot默认为true</li>
<li>如果root不为null，attachToRoot为true，会调用root的addView方法并返回root；attachToRoot为false，则根据传入的root为根标签temp设置LayoutParams并返回temp；</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/16/Android setContentView源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/16/Android setContentView源码分析/" itemprop="url">Android setContentView源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T00:00:00+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/16/Android setContentView源码分析/" class="leancloud_visitors" data-flag-title="Android setContentView源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>还记得初学Android的时候啥也不做,点击“Run”就可以看到程序跑起来,不一会界面就显示了”Hello World”。作为初学者只记得通过setContentView把布局文件和MainActivity关联起来,而具体是怎样实现的没有深究,后面在平常开发的时候经常会遇到疑问,例如使用hierarchyviewer工具查看布局层级发现在我们指定的布局外又包裹着其他父布局、经常看到其他地方说到PhoneWindow是个什么结构？带着这些疑问从头再跟下源码。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>Activity、Window、PhoneWindow、DecorView之间的关系</li>
<li>hierarchyviewer布局分析</li>
<li>setContentView方法分析</li>
<li>installDecor方法分析</li>
<li>generateDecor方法分析</li>
<li>generateLayout方法分析</li>
</ul>
<h2 id="hierarchyviewer"><a href="#hierarchyviewer" class="headerlink" title="hierarchyviewer"></a>hierarchyviewer</h2><p>先看下最常见的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends Activity &#123;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_main&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:paddingBottom=&quot;@dimen/activity_vertical_margin&quot;</div><div class="line">    android:paddingLeft=&quot;@dimen/activity_horizontal_margin&quot;</div><div class="line">    android:paddingRight=&quot;@dimen/activity_horizontal_margin&quot;</div><div class="line">    android:paddingTop=&quot;@dimen/activity_vertical_margin&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.handlerdemo.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;TextView</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Hello World!&quot; /&gt;</div><div class="line">&lt;/RelativeLayout&gt;</div></pre></td></tr></table></figure>
<p>运行如下</p>
<p>   <img src="http://7xjvg5.com1.z0.glb.clouddn.com/989851-0157baf37c6fa96a.png" style="zoom:25%"></p>
<p>打开SDK中的hierarchyviewer工具查看层级结构如下</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer.png" alt="img"></a></p>
<p>可以看到除了最右边的RelativeLayout,外层还包裹了其他的布局,为啥会出现这种情况呢？</p>
<h2 id="setContentView"><a href="#setContentView" class="headerlink" title="setContentView"></a>setContentView</h2><p>在MainActivity中调用setContentView(R.layout.activity_main)，会走到Activity的setContentView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/android/app/Activity.java</div><div class="line"></div><div class="line">    public void setContentView(@LayoutRes int layoutResID) &#123;</div><div class="line">        getWindow().setContentView(layoutResID);</div><div class="line">        initWindowDecorActionBar();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setContentView(View view) &#123;</div><div class="line">        getWindow().setContentView(view);</div><div class="line">        initWindowDecorActionBar();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setContentView(View view, ViewGroup.LayoutParams params) &#123;</div><div class="line">        getWindow().setContentView(view, params);</div><div class="line">        initWindowDecorActionBar();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Activity中三个方法都会执行getWindow()的setContentView方法，这里的getWindow()的返回的是Window实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public Window getWindow() &#123;</div><div class="line">    return mWindow;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Activity的attach方法中实例化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mWindow = new PhoneWindow(this, window);</div></pre></td></tr></table></figure>
<p>查看PhoneWindow中的setContentView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/com/android/internal/policy/PhoneWindow.java</div><div class="line"></div><div class="line">    public void setContentView(int layoutResID) &#123;</div><div class="line">        // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</div><div class="line">        // decor, when theme attributes and the like are crystalized. Do not check the feature</div><div class="line">        // before this happens.</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            //第一次调用时mContentParent为null，通过installDecor实例化。</div><div class="line">            installDecor();</div><div class="line">        &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;  //是否设置了窗口过渡标识，默认为false</div><div class="line">            //移除mContentParent中所有的子View</div><div class="line">            mContentParent.removeAllViews();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">            //设置了窗口过渡标识的情况</div><div class="line">            final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</div><div class="line">                    getContext());</div><div class="line">            //使用TransitionManager进行过渡的处理</div><div class="line">            transitionTo(newScene);</div><div class="line">        &#125; else &#123;</div><div class="line">            //不需要过渡时，通过LayoutInflater的inflate将资源文件转换为View树，并添加至mContentParent中</div><div class="line">            mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line">        &#125;</div><div class="line">        //请求设置Window内容的属性值，将其写入一个WindowInsets类中</div><div class="line">        mContentParent.requestApplyInsets();</div><div class="line">        final Callback cb = getCallback();</div><div class="line">        if (cb != null &amp;&amp; !isDestroyed()) &#123;</div><div class="line">            cb.onContentChanged();</div><div class="line">        &#125;</div><div class="line">        //已设置content View</div><div class="line">        mContentParentExplicitlySet = true;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>同样PhoneWindow还有另外两个对应Activity中的setContentView方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void setContentView(View view) &#123;</div><div class="line">    setContentView(view, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public void setContentView(View view, ViewGroup.LayoutParams params) &#123;</div><div class="line">    // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</div><div class="line">    // decor, when theme attributes and the like are crystalized. Do not check the feature</div><div class="line">    // before this happens.</div><div class="line">    if (mContentParent == null) &#123;</div><div class="line">        installDecor();</div><div class="line">    &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        mContentParent.removeAllViews();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        view.setLayoutParams(params);</div><div class="line">        final Scene newScene = new Scene(mContentParent, view);</div><div class="line">        transitionTo(newScene);</div><div class="line">    &#125; else &#123;</div><div class="line">        mContentParent.addView(view, params);</div><div class="line">    &#125;</div><div class="line">    mContentParent.requestApplyInsets();</div><div class="line">    final Callback cb = getCallback();</div><div class="line">    if (cb != null &amp;&amp; !isDestroyed()) &#123;</div><div class="line">        cb.onContentChanged();</div><div class="line">    &#125;</div><div class="line">    mContentParentExplicitlySet = true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，当调用 setContentView(View view)时，其内部会调用setContentView(View view, ViewGroup.LayoutParams params)，只是LayoutParams 值为MATCH_PARENT， 与setContentView(int layoutResID)相比，由使用LayoutInflater的inflate解析换成了mContentParent的addView。</p>
<h3 id="小节"><a href="#小节" class="headerlink" title="小节"></a>小节</h3><ul>
<li>如果第一次调用setContentView，执行installDecor()；</li>
<li>如果不是第一次调用setContentView，且未设置窗口过渡标志，调用removeAllViews将窗口中所有子View移除(所以在程序中若多次调用setContentView方法显示界面不会有影响)</li>
<li>如果设置了窗口过渡标志，使用TransitionManager进行过渡的处理，否则选择合适的方式将View添加到mContentParent中</li>
</ul>
<h2 id="installDecor方法分析"><a href="#installDecor方法分析" class="headerlink" title="installDecor方法分析"></a>installDecor方法分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/com/android/internal/policy/PhoneWindow.java</div><div class="line">   private void installDecor() &#123;</div><div class="line">        mForceDecorInstall = false;</div><div class="line">        if (mDecor == null) &#123;</div><div class="line">            //如果mDecor为null则通过generateDecor初始化</div><div class="line">            mDecor = generateDecor(-1);</div><div class="line">            //设置mDecor中子View焦点获取关系,FOCUS_AFTER_DESCENDANTS指定只有mDecor中所有子View</div><div class="line">            //都不获取焦点时才让mDecor获得焦点</div><div class="line">            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</div><div class="line">            //设置mDecor为整个Activity窗口的根节点</div><div class="line">            mDecor.setIsRootNamespace(true);</div><div class="line">            if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != 0) &#123;</div><div class="line">                //将Runnable跑在用户界面线程</div><div class="line">                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            //mDecor不为null设置当前窗口上下文为PhoneWindow</div><div class="line">            mDecor.setWindow(this);</div><div class="line">        &#125;</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            //如果mContentParent为null则通过generateLayout初始化</div><div class="line">            mContentParent = generateLayout(mDecor);</div><div class="line"></div><div class="line">            // Set up decor part of UI to ignore fitsSystemWindows if appropriate.</div><div class="line">            mDecor.makeOptionalFitsSystemWindows();</div><div class="line">            //DecorContentParent位于com.android.internal.widget中，</div><div class="line">            //是一个接口由应用程序窗口的顶层Decor实现，该类主要为mDecor提供了许多标题/窗口装饰功能</div><div class="line">            final DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</div><div class="line">                    R.id.decor_content_parent);</div><div class="line"></div><div class="line">            if (decorContentParent != null) &#123;</div><div class="line">                mDecorContentParent = decorContentParent;</div><div class="line">                mDecorContentParent.setWindowCallback(getCallback());</div><div class="line">                if (mDecorContentParent.getTitle() == null) &#123;</div><div class="line">                    //设置窗口标题</div><div class="line">                    mDecorContentParent.setWindowTitle(mTitle);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                final int localFeatures = getLocalFeatures();</div><div class="line">                for (int i = 0; i &lt; FEATURE_MAX; i++) &#123;</div><div class="line">                    if ((localFeatures &amp; (1 &lt;&lt; i)) != 0) &#123;</div><div class="line">                        mDecorContentParent.initFeature(i);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                mDecorContentParent.setUiOptions(mUiOptions);</div><div class="line"></div><div class="line">                //mDecorContentParent设置图标和Logo的判断</div><div class="line">                if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) != 0 ||</div><div class="line">                        (mIconRes != 0 &amp;&amp; !mDecorContentParent.hasIcon())) &#123;</div><div class="line">                    mDecorContentParent.setIcon(mIconRes);</div><div class="line">                &#125; else if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) == 0 &amp;&amp;</div><div class="line">                        mIconRes == 0 &amp;&amp; !mDecorContentParent.hasIcon()) &#123;</div><div class="line">                    mDecorContentParent.setIcon(</div><div class="line">                            getContext().getPackageManager().getDefaultActivityIcon());</div><div class="line">                    mResourcesSetFlags |= FLAG_RESOURCE_SET_ICON_FALLBACK;</div><div class="line">                &#125;</div><div class="line">                if ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_LOGO) != 0 ||</div><div class="line">                        (mLogoRes != 0 &amp;&amp; !mDecorContentParent.hasLogo())) &#123;</div><div class="line">                    mDecorContentParent.setLogo(mLogoRes);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                // Invalidate if the panel menu hasn&apos;t been created before this.</div><div class="line">                // Panel menu invalidation is deferred avoiding application onCreateOptionsMenu</div><div class="line">                // being called in the middle of onCreate or similar.</div><div class="line">                // A pending invalidation will typically be resolved before the posted message</div><div class="line">                // would run normally in order to satisfy instance state restoration.</div><div class="line">                PanelFeatureState st = getPanelState(FEATURE_OPTIONS_PANEL, false);</div><div class="line">                if (!isDestroyed() &amp;&amp; (st == null || st.menu == null) &amp;&amp; !mIsStartingWindow) &#123;</div><div class="line">                    //使面板菜单失效</div><div class="line">                    invalidatePanelMenu(FEATURE_ACTION_BAR);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                //若decorContentParent为null,根据窗口是否为一个包含Title的窗口决定是否显示title</div><div class="line">                //如果窗口包含特征FEATURE_NO_TITLE，则隐藏窗口的title view 否则设置窗口的title</div><div class="line">                mTitleView = (TextView) findViewById(R.id.title);</div><div class="line">                if (mTitleView != null) &#123;</div><div class="line">                    if ((getLocalFeatures() &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) != 0) &#123;</div><div class="line">                        final View titleContainer = findViewById(R.id.title_container);</div><div class="line">                        if (titleContainer != null) &#123;</div><div class="line">                            titleContainer.setVisibility(View.GONE);</div><div class="line">                        &#125; else &#123;</div><div class="line">                            mTitleView.setVisibility(View.GONE);</div><div class="line">                        &#125;</div><div class="line">                        mContentParent.setForeground(null);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        mTitleView.setText(mTitle);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (mDecor.getBackground() == null &amp;&amp; mBackgroundFallbackResource != 0) &#123;</div><div class="line">                //设置背景</div><div class="line">                mDecor.setBackgroundFallback(mBackgroundFallbackResource);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Only inflate or create a new TransitionManager if the caller hasn&apos;t</div><div class="line">            // already set a custom one.</div><div class="line">            if (hasFeature(FEATURE_ACTIVITY_TRANSITIONS)) &#123;</div><div class="line">                //设置了窗口过渡标识的情况</div><div class="line">                if (mTransitionManager == null) &#123;</div><div class="line">                    //TransitionManager为空的时先初始化</div><div class="line">                    final int transitionRes = getWindowStyle().getResourceId(</div><div class="line">                            R.styleable.Window_windowContentTransitionManager,</div><div class="line">                            0);</div><div class="line">                    if (transitionRes != 0) &#123;</div><div class="line">                        final TransitionInflater inflater = TransitionInflater.from(getContext());</div><div class="line">                        mTransitionManager = inflater.inflateTransitionManager(transitionRes,</div><div class="line">                                mContentParent);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        mTransitionManager = new TransitionManager();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                //实例化各种过渡动画效果、进入、退出。。。</div><div class="line">                mEnterTransition = getTransition(mEnterTransition, null,</div><div class="line">                        R.styleable.Window_windowEnterTransition);</div><div class="line">                mReturnTransition = getTransition(mReturnTransition, USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowReturnTransition);</div><div class="line">                mExitTransition = getTransition(mExitTransition, null,</div><div class="line">                        R.styleable.Window_windowExitTransition);</div><div class="line">                mReenterTransition = getTransition(mReenterTransition, USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowReenterTransition);</div><div class="line">                mSharedElementEnterTransition = getTransition(mSharedElementEnterTransition, null,</div><div class="line">                        R.styleable.Window_windowSharedElementEnterTransition);</div><div class="line">                mSharedElementReturnTransition = getTransition(mSharedElementReturnTransition,</div><div class="line">                        USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowSharedElementReturnTransition);</div><div class="line">                mSharedElementExitTransition = getTransition(mSharedElementExitTransition, null,</div><div class="line">                        R.styleable.Window_windowSharedElementExitTransition);</div><div class="line">                mSharedElementReenterTransition = getTransition(mSharedElementReenterTransition,</div><div class="line">                        USE_DEFAULT_TRANSITION,</div><div class="line">                        R.styleable.Window_windowSharedElementReenterTransition);</div><div class="line">                if (mAllowEnterTransitionOverlap == null) &#123;</div><div class="line">                    //是否允许进入过渡动画重叠</div><div class="line">                    mAllowEnterTransitionOverlap = getWindowStyle().getBoolean(</div><div class="line">                            R.styleable.Window_windowAllowEnterTransitionOverlap, true);</div><div class="line">                &#125;</div><div class="line">                if (mAllowReturnTransitionOverlap == null) &#123;</div><div class="line">                    //是否允许返回过渡动画重叠</div><div class="line">                    mAllowReturnTransitionOverlap = getWindowStyle().getBoolean(</div><div class="line">                            R.styleable.Window_windowAllowReturnTransitionOverlap, true);</div><div class="line">                &#125;</div><div class="line">                if (mBackgroundFadeDurationMillis &lt; 0) &#123;</div><div class="line">                    //背景消失的持续时间</div><div class="line">                    mBackgroundFadeDurationMillis = getWindowStyle().getInteger(</div><div class="line">                            R.styleable.Window_windowTransitionBackgroundFadeDuration,</div><div class="line">                            DEFAULT_BACKGROUND_FADE_DURATION_MS);</div><div class="line">                &#125;</div><div class="line">                if (mSharedElementsUseOverlay == null) &#123;</div><div class="line">                    //另一种过渡效果</div><div class="line">                    mSharedElementsUseOverlay = getWindowStyle().getBoolean(</div><div class="line">                            R.styleable.Window_windowSharedElementsUseOverlay, true);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="generateDecor方法分析"><a href="#generateDecor方法分析" class="headerlink" title="generateDecor方法分析"></a>generateDecor方法分析</h2><p>在installDecor中如果判断为null则通过generateDecor初始化，方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">源码路径：android-24/com/android/internal/policy/PhoneWindow.java</div><div class="line">    protected DecorView generateDecor(int featureId) &#123;</div><div class="line">        // System process doesn&apos;t have application context and in that case we need to directly use</div><div class="line">        // the context we have. Otherwise we want the application context, so we don&apos;t cling to the</div><div class="line">        // activity.</div><div class="line">        Context context;</div><div class="line">        if (mUseDecorContext) &#123;</div><div class="line">            Context applicationContext = getContext().getApplicationContext();</div><div class="line">            if (applicationContext == null) &#123;</div><div class="line">                context = getContext();</div><div class="line">            &#125; else &#123;</div><div class="line">                context = new DecorContext(applicationContext, getContext().getResources());</div><div class="line">                if (mTheme != -1) &#123;</div><div class="line">                    context.setTheme(mTheme);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            context = getContext();</div><div class="line">        &#125;</div><div class="line">        return new DecorView(context, featureId, this, getAttributes());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里根据上下文生成一个DecorView对象，DecorView是PhoneWindow类的内部类，继承自FrameLayout</p>
<h2 id="generateLayout方法分析"><a href="#generateLayout方法分析" class="headerlink" title="generateLayout方法分析"></a>generateLayout方法分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div></pre></td><td class="code"><pre><div class="line">protected ViewGroup generateLayout(DecorView decor) &#123;</div><div class="line">    // Apply data from current theme.</div><div class="line">    //从当前Window的Theme中获取一组属性值，赋给a</div><div class="line">    TypedArray a = getWindowStyle();</div><div class="line">    //窗口是否浮动</div><div class="line">    mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, false);</div><div class="line">    int flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR)</div><div class="line">            &amp; (~getForcedWindowFlags());</div><div class="line">    if (mIsFloating) &#123;</div><div class="line">        setLayout(WRAP_CONTENT, WRAP_CONTENT);</div><div class="line">        setFlags(0, flagsToUpdate);</div><div class="line">    &#125; else &#123;</div><div class="line">        setFlags(FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR, flagsToUpdate);</div><div class="line">    &#125;</div><div class="line">    //窗口是否支持标题栏，隐藏显示标题栏操作在此处。</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowNoTitle, false)) &#123;</div><div class="line">        requestFeature(FEATURE_NO_TITLE);</div><div class="line">    &#125; else if (a.getBoolean(R.styleable.Window_windowActionBar, false)) &#123;</div><div class="line">        // Don&apos;t allow an action bar if there is no title.</div><div class="line">        requestFeature(FEATURE_ACTION_BAR);</div><div class="line">    &#125;</div><div class="line">    //ActionBar导航栏是否不占布局空间叠加显示在当前窗口之上。</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowActionBarOverlay, false)) &#123;</div><div class="line">        requestFeature(FEATURE_ACTION_BAR_OVERLAY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (a.getBoolean(R.styleable.Window_windowActionModeOverlay, false)) &#123;</div><div class="line">        requestFeature(FEATURE_ACTION_MODE_OVERLAY);</div><div class="line">    &#125;</div><div class="line">    //是否设置从左边滑动消失</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowSwipeToDismiss, false)) &#123;</div><div class="line">        requestFeature(FEATURE_SWIPE_TO_DISMISS);</div><div class="line">    &#125;</div><div class="line">    //当前Activity是否支持全屏</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowFullscreen, false)) &#123;</div><div class="line">        setFlags(FLAG_FULLSCREEN, FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //透明状态栏标志位设置</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowTranslucentStatus,</div><div class="line">            false)) &#123;</div><div class="line">        setFlags(FLAG_TRANSLUCENT_STATUS, FLAG_TRANSLUCENT_STATUS</div><div class="line">                &amp; (~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //透明导航栏标志位设置</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowTranslucentNavigation,</div><div class="line">            false)) &#123;</div><div class="line">        setFlags(FLAG_TRANSLUCENT_NAVIGATION, FLAG_TRANSLUCENT_NAVIGATION</div><div class="line">                &amp; (~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (a.getBoolean(R.styleable.Window_windowOverscan, false)) &#123;</div><div class="line">        setFlags(FLAG_LAYOUT_IN_OVERSCAN, FLAG_LAYOUT_IN_OVERSCAN&amp;(~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //是否允许系统壁纸显示在窗口后面</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowShowWallpaper, false)) &#123;</div><div class="line">        setFlags(FLAG_SHOW_WALLPAPER, FLAG_SHOW_WALLPAPER&amp;(~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line">    //窗口触摸事件标志位</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowEnableSplitTouch,</div><div class="line">            getContext().getApplicationInfo().targetSdkVersion</div><div class="line">                    &gt;= android.os.Build.VERSION_CODES.HONEYCOMB)) &#123;</div><div class="line">        setFlags(FLAG_SPLIT_TOUCH, FLAG_SPLIT_TOUCH&amp;(~getForcedWindowFlags()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    a.getValue(R.styleable.Window_windowMinWidthMajor, mMinWidthMajor);</div><div class="line">    a.getValue(R.styleable.Window_windowMinWidthMinor, mMinWidthMinor);</div><div class="line"></div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedWidthMajor)) &#123;</div><div class="line">        if (mFixedWidthMajor == null) mFixedWidthMajor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedWidthMajor,</div><div class="line">                mFixedWidthMajor);</div><div class="line">    &#125;</div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedWidthMinor)) &#123;</div><div class="line">        if (mFixedWidthMinor == null) mFixedWidthMinor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedWidthMinor,</div><div class="line">                mFixedWidthMinor);</div><div class="line">    &#125;</div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedHeightMajor)) &#123;</div><div class="line">        if (mFixedHeightMajor == null) mFixedHeightMajor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedHeightMajor,</div><div class="line">                mFixedHeightMajor);</div><div class="line">    &#125;</div><div class="line">    if (a.hasValue(R.styleable.Window_windowFixedHeightMinor)) &#123;</div><div class="line">        if (mFixedHeightMinor == null) mFixedHeightMinor = new TypedValue();</div><div class="line">        a.getValue(R.styleable.Window_windowFixedHeightMinor,</div><div class="line">                mFixedHeightMinor);</div><div class="line">    &#125;</div><div class="line">    //是否使用窗口过渡动画，使用TransitionManager</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowContentTransitions, false)) &#123;</div><div class="line">        requestFeature(FEATURE_CONTENT_TRANSITIONS);</div><div class="line">    &#125;</div><div class="line">    //是否运行Activity过渡动画</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowActivityTransitions, false)) &#123;</div><div class="line">        requestFeature(FEATURE_ACTIVITY_TRANSITIONS);</div><div class="line">    &#125;</div><div class="line">    //窗口是否透明</div><div class="line">    mIsTranslucent = a.getBoolean(R.styleable.Window_windowIsTranslucent, false);</div><div class="line"></div><div class="line">    final Context context = getContext();</div><div class="line">    //获取当前应用的目标sdk版本号</div><div class="line">    final int targetSdk = context.getApplicationInfo().targetSdkVersion;</div><div class="line">    //当前目标sdk版本号是否小于11</div><div class="line">    final boolean targetPreHoneycomb = targetSdk &lt; android.os.Build.VERSION_CODES.HONEYCOMB;</div><div class="line">    //当前目标sdk版本号是否小于14</div><div class="line">    final boolean targetPreIcs = targetSdk &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH;</div><div class="line">    //当前目标sdk版本号是否小于21</div><div class="line">    final boolean targetPreL = targetSdk &lt; android.os.Build.VERSION_CODES.LOLLIPOP;</div><div class="line">    //是否需要菜单选项</div><div class="line">    final boolean targetHcNeedsOptions = context.getResources().getBoolean(</div><div class="line">            R.bool.target_honeycomb_needs_options_menu);</div><div class="line">    //是否有ActionBar</div><div class="line">    final boolean noActionBar = !hasFeature(FEATURE_ACTION_BAR) || hasFeature(FEATURE_NO_TITLE);</div><div class="line"></div><div class="line">    if (targetPreHoneycomb || (targetPreIcs &amp;&amp; targetHcNeedsOptions &amp;&amp; noActionBar)) &#123;</div><div class="line">        //目标版本号小于11或者满足小于14且需要菜单选项且无ActionBar，则设置需要菜单选项</div><div class="line">        setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_TRUE);</div><div class="line">    &#125; else &#123;</div><div class="line">        //设置不需要菜单选项</div><div class="line">        setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_FALSE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!mForcedStatusBarColor) &#123;</div><div class="line">        //设置状态栏颜色</div><div class="line">        mStatusBarColor = a.getColor(R.styleable.Window_statusBarColor, 0xFF000000);</div><div class="line">    &#125;</div><div class="line">    if (!mForcedNavigationBarColor) &#123;</div><div class="line">        //设置导航栏颜色</div><div class="line">        mNavigationBarColor = a.getColor(R.styleable.Window_navigationBarColor, 0xFF000000);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    WindowManager.LayoutParams params = getAttributes();</div><div class="line"></div><div class="line">    // Non-floating windows on high end devices must put up decor beneath the system bars and</div><div class="line">    // therefore must know about visibility changes of those.</div><div class="line">    if (!mIsFloating &amp;&amp; ActivityManager.isHighEndGfx()) &#123;</div><div class="line">        if (!targetPreL &amp;&amp; a.getBoolean(</div><div class="line">                R.styleable.Window_windowDrawsSystemBarBackgrounds,</div><div class="line">                false)) &#123;</div><div class="line">            //高版本对System bar的处理</div><div class="line">            setFlags(FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS,</div><div class="line">                    FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS &amp; ~getForcedWindowFlags());</div><div class="line">        &#125;</div><div class="line">        if (mDecor.mForceWindowDrawsStatusBarBackground) &#123;</div><div class="line">            params.privateFlags |= PRIVATE_FLAG_FORCE_DRAW_STATUS_BAR_BACKGROUND;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //是否设置状态栏可见</div><div class="line">    if (a.getBoolean(R.styleable.Window_windowLightStatusBar, false)) &#123;</div><div class="line">        decor.setSystemUiVisibility(</div><div class="line">                decor.getSystemUiVisibility() | View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (mAlwaysReadCloseOnTouchAttr || getContext().getApplicationInfo().targetSdkVersion</div><div class="line">            &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">        if (a.getBoolean(</div><div class="line">                R.styleable.Window_windowCloseOnTouchOutside,</div><div class="line">                false)) &#123;</div><div class="line">            setCloseOnTouchOutsideIfNotSet(true);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">     //设置输入法的状态</div><div class="line">    if (!hasSoftInputMode()) &#123;</div><div class="line">        params.softInputMode = a.getInt(</div><div class="line">                R.styleable.Window_windowSoftInputMode,</div><div class="line">                params.softInputMode);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (a.getBoolean(R.styleable.Window_backgroundDimEnabled,</div><div class="line">            mIsFloating)) &#123;</div><div class="line">        /* All dialogs should have the window dimmed */</div><div class="line">        //dialog出现时窗口状态</div><div class="line">        if ((getForcedWindowFlags()&amp;WindowManager.LayoutParams.FLAG_DIM_BEHIND) == 0) &#123;</div><div class="line">            params.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</div><div class="line">        &#125;</div><div class="line">        if (!haveDimAmount()) &#123;</div><div class="line">            params.dimAmount = a.getFloat(</div><div class="line">                    android.R.styleable.Window_backgroundDimAmount, 0.5f);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //设置当前Activity的出现动画效果</div><div class="line">    if (params.windowAnimations == 0) &#123;</div><div class="line">        params.windowAnimations = a.getResourceId(</div><div class="line">                R.styleable.Window_windowAnimationStyle, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // The rest are only done if this window is not embedded; otherwise,</div><div class="line">    // the values are inherited from our container.</div><div class="line">    if (getContainer() == null) &#123;</div><div class="line">        if (mBackgroundDrawable == null) &#123;</div><div class="line">            if (mBackgroundResource == 0) &#123;</div><div class="line">                mBackgroundResource = a.getResourceId(</div><div class="line">                        R.styleable.Window_windowBackground, 0);</div><div class="line">            &#125;</div><div class="line">            if (mFrameResource == 0) &#123;</div><div class="line">                mFrameResource = a.getResourceId(R.styleable.Window_windowFrame, 0);</div><div class="line">            &#125;</div><div class="line">            mBackgroundFallbackResource = a.getResourceId(</div><div class="line">                    R.styleable.Window_windowBackgroundFallback, 0);</div><div class="line">        &#125;</div><div class="line">        if (mLoadElevation) &#123;</div><div class="line">            mElevation = a.getDimension(R.styleable.Window_windowElevation, 0);</div><div class="line">        &#125;</div><div class="line">        mClipToOutline = a.getBoolean(R.styleable.Window_windowClipToOutline, false);</div><div class="line">        mTextColor = a.getColor(R.styleable.Window_textColor, Color.TRANSPARENT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Inflate the window decor.</div><div class="line"></div><div class="line">    int layoutResource;</div><div class="line">    //返回一个用于描述当前Window特征的整数值</div><div class="line">    int features = getLocalFeatures();</div><div class="line">    // System.out.println(&quot;Features: 0x&quot; + Integer.toHexString(features));</div><div class="line">    //下面一大段判断根据features值选定窗口资源文件id</div><div class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</div><div class="line">        layoutResource = R.layout.screen_swipe_dismiss;</div><div class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_LEFT_ICON) | (1 &lt;&lt; FEATURE_RIGHT_ICON))) != 0) &#123;</div><div class="line">        if (mIsFloating) &#123;</div><div class="line">            TypedValue res = new TypedValue();</div><div class="line">            getContext().getTheme().resolveAttribute(</div><div class="line">                    R.attr.dialogTitleIconsDecorLayout, res, true);</div><div class="line">            layoutResource = res.resourceId;</div><div class="line">        &#125; else &#123;</div><div class="line">            layoutResource = R.layout.screen_title_icons;</div><div class="line">        &#125;</div><div class="line">        // XXX Remove this once action bar supports these features.</div><div class="line">        removeFeature(FEATURE_ACTION_BAR);</div><div class="line">        // System.out.println(&quot;Title Icons!&quot;);</div><div class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_PROGRESS) | (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != 0</div><div class="line">            &amp;&amp; (features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) == 0) &#123;</div><div class="line">        // Special case for a window with only a progress bar (and title).</div><div class="line">        // XXX Need to have a no-title version of embedded windows.</div><div class="line">        layoutResource = R.layout.screen_progress;</div><div class="line">        // System.out.println(&quot;Progress!&quot;);</div><div class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_CUSTOM_TITLE)) != 0) &#123;</div><div class="line">        // Special case for a window with a custom title.</div><div class="line">        // If the window is floating, we need a dialog layout</div><div class="line">        if (mIsFloating) &#123;</div><div class="line">            TypedValue res = new TypedValue();</div><div class="line">            getContext().getTheme().resolveAttribute(</div><div class="line">                    R.attr.dialogCustomTitleDecorLayout, res, true);</div><div class="line">            layoutResource = res.resourceId;</div><div class="line">        &#125; else &#123;</div><div class="line">            layoutResource = R.layout.screen_custom_title;</div><div class="line">        &#125;</div><div class="line">        // XXX Remove this once action bar supports these features.</div><div class="line">        removeFeature(FEATURE_ACTION_BAR);</div><div class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) == 0) &#123;</div><div class="line">        // If no other features and not embedded, only need a title.</div><div class="line">        // If the window is floating, we need a dialog layout</div><div class="line">        if (mIsFloating) &#123;</div><div class="line">            TypedValue res = new TypedValue();</div><div class="line">            getContext().getTheme().resolveAttribute(</div><div class="line">                    R.attr.dialogTitleDecorLayout, res, true);</div><div class="line">            layoutResource = res.resourceId;</div><div class="line">        &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) != 0) &#123;</div><div class="line">            layoutResource = a.getResourceId(</div><div class="line">                    R.styleable.Window_windowActionBarFullscreenDecorLayout,</div><div class="line">                    R.layout.screen_action_bar);</div><div class="line">        &#125; else &#123;</div><div class="line">            //最常用的Activity窗口修饰布局文件，有title</div><div class="line">            layoutResource = R.layout.screen_title;</div><div class="line">        &#125;</div><div class="line">        // System.out.println(&quot;Title!&quot;);</div><div class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != 0) &#123;</div><div class="line">        layoutResource = R.layout.screen_simple_overlay_action_mode;</div><div class="line">    &#125; else &#123;</div><div class="line">        // Embedded, so no decoration is needed.</div><div class="line">        //最简单的Activity窗口修饰布局文件，无title</div><div class="line">        layoutResource = R.layout.screen_simple;</div><div class="line">        // System.out.println(&quot;Simple!&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mDecor.startChanging();</div><div class="line">    //该步骤很重要，将layoutResource资源文件包含的View树添加到decor中</div><div class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</div><div class="line">    //寻找com.android.internal.R.id.content节点</div><div class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</div><div class="line">    if (contentParent == null) &#123;</div><div class="line">        throw new RuntimeException(&quot;Window couldn&apos;t find content container view&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != 0) &#123;</div><div class="line">        ProgressBar progress = getCircularProgressBar(false);</div><div class="line">        if (progress != null) &#123;</div><div class="line">            //设置进度条模式为indeterminate，</div><div class="line">            //该模式下进度不显示进度，只显示无限动画</div><div class="line">            progress.setIndeterminate(true);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</div><div class="line">        //对于选择R.layout.screen_swipe_dismiss布局注册回调</div><div class="line">        registerSwipeCallbacks();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Remaining setup -- of background and title -- that only applies</div><div class="line">    // to top-level windows.</div><div class="line">    if (getContainer() == null) &#123;</div><div class="line">        final Drawable background;</div><div class="line">        if (mBackgroundResource != 0) &#123;</div><div class="line">            background = getContext().getDrawable(mBackgroundResource);</div><div class="line">        &#125; else &#123;</div><div class="line">            background = mBackgroundDrawable;</div><div class="line">        &#125;</div><div class="line">        //设置背景</div><div class="line">        mDecor.setWindowBackground(background);</div><div class="line"></div><div class="line">        final Drawable frame;</div><div class="line">        if (mFrameResource != 0) &#123;</div><div class="line">            frame = getContext().getDrawable(mFrameResource);</div><div class="line">        &#125; else &#123;</div><div class="line">            frame = null;</div><div class="line">        &#125;</div><div class="line">        mDecor.setWindowFrame(frame);</div><div class="line"></div><div class="line">        mDecor.setElevation(mElevation);</div><div class="line">        mDecor.setClipToOutline(mClipToOutline);</div><div class="line"></div><div class="line">        if (mTitle != null) &#123;</div><div class="line">            //设置标题</div><div class="line">            setTitle(mTitle);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mTitleColor == 0) &#123;</div><div class="line">            //设置标题颜色</div><div class="line">            mTitleColor = mTextColor;</div><div class="line">        &#125;</div><div class="line">        setTitleColor(mTitleColor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mDecor.finishChanging();</div><div class="line"></div><div class="line">    return contentParent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法代码量较多，主要是做了如下操作：</p>
<ul>
<li>Step1：从第4行到第205行，获取窗口style配置，并根据配置里的值判断是否显示标题栏，是否全屏，是否支持ActionBar浮动，动画效果等等</li>
<li>Step2：从209行到271行，获取窗口的features，根据features值给容器DecorView添加id为layoutResource布局的根布局</li>
<li>Step3：从273行到275行，传入LayoutInflater和指定的布局文件，通过inflate方法将布局文件解析成View，并添加到DecorView根布局当中</li>
<li>Step4：277行，从根布局中查找id为com.android.internal.R.id.content的ViewGroup，也就是整个方法的返回值。</li>
<li>Step5：278-333行，后续一系列操作，包括设置背景，标题，标题颜色等。</li>
</ul>
<p>看下Step2中比较重要的一步操作mDecor.onResourcesLoaded(mLayoutInflater, layoutResource)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">void onResourcesLoaded(LayoutInflater inflater, int layoutResource) &#123;</div><div class="line">        mStackId = getStackId();</div><div class="line"></div><div class="line">        if (mBackdropFrameRenderer != null) &#123;</div><div class="line">            loadBackgroundDrawablesIfNeeded();</div><div class="line">            mBackdropFrameRenderer.onResourcesLoaded(</div><div class="line">                    this, mResizingBackgroundDrawable, mCaptionBackgroundDrawable,</div><div class="line">                    mUserCaptionBackgroundDrawable, getCurrentColor(mStatusColorViewState),</div><div class="line">                    getCurrentColor(mNavigationColorViewState));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mDecorCaptionView = createDecorCaptionView(inflater);</div><div class="line">        final View root = inflater.inflate(layoutResource, null);</div><div class="line">        if (mDecorCaptionView != null) &#123;</div><div class="line">            if (mDecorCaptionView.getParent() == null) &#123;</div><div class="line">                addView(mDecorCaptionView,</div><div class="line">                        new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">            &#125;</div><div class="line">            mDecorCaptionView.addView(root,</div><div class="line">                    new ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">        &#125; else &#123;</div><div class="line"></div><div class="line">            // Put it below the color views.</div><div class="line">            addView(root, 0, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">        &#125;</div><div class="line">        mContentRoot = (ViewGroup) root;</div><div class="line">        initializeElevation();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>12行判断是否是浮动的窗口创建一个mDecorCaptionView ，13行将资源文件解析成View，之后指定布局的宽高为MATCH_PARENT，26行再把View赋给mContentRoot 。接下来，看看 id为layoutResource的布局到底实现了什么？以我们的代码为例，无标题，资源文件为R.layout.screen_simple(源码路径:platforms/android-24/data/res/layout/R.layout.screen_simple)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;!--</div><div class="line">/* //device/apps/common/assets/res/layout/screen_simple.xml</div><div class="line">**</div><div class="line">** Copyright 2006, The Android Open Source Project</div><div class="line">**</div><div class="line">** Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); </div><div class="line">** you may not use this file except in compliance with the License. </div><div class="line">** You may obtain a copy of the License at </div><div class="line">**</div><div class="line">**     http://www.apache.org/licenses/LICENSE-2.0 </div><div class="line">**</div><div class="line">** Unless required by applicable law or agreed to in writing, software </div><div class="line">** distributed under the License is distributed on an &quot;AS IS&quot; BASIS, </div><div class="line">** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. </div><div class="line">** See the License for the specific language governing permissions and </div><div class="line">** limitations under the License.</div><div class="line">*/</div><div class="line"></div><div class="line">This is an optimized layout for a screen, with the minimum set of features</div><div class="line">enabled.</div><div class="line">--&gt;</div><div class="line"></div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:fitsSystemWindows=&quot;true&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line">    &lt;ViewStub android:id=&quot;@+id/action_mode_bar_stub&quot;</div><div class="line">              android:inflatedId=&quot;@+id/action_mode_bar&quot;</div><div class="line">              android:layout=&quot;@layout/action_mode_bar&quot;</div><div class="line">              android:layout_width=&quot;match_parent&quot;</div><div class="line">              android:layout_height=&quot;wrap_content&quot;</div><div class="line">              android:theme=&quot;?attr/actionBarTheme&quot; /&gt;</div><div class="line">    &lt;FrameLayout</div><div class="line">         android:id=&quot;@android:id/content&quot;</div><div class="line">         android:layout_width=&quot;match_parent&quot;</div><div class="line">         android:layout_height=&quot;match_parent&quot;</div><div class="line">         android:foregroundInsidePadding=&quot;false&quot;</div><div class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</div><div class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>结合hierarchyviewer图正好可以对应上面的布局</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer2.jpg" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/hierarchyviewer2.jpg" alt="img"></a></p>
<p>可以看到，我们啥也不干的情况下在我们的布局外面包裹着另外一层布局，一个LinearLayout包含了ViewStub 和FrameLayout，ViewStub 为懒加载默认不显示，id为content的FrameLayout作为我们布局文件的父布局，上面Step4查找该布局，之后作为整个generateLayout方法的返回值，而这里的mContentParent又在PhoneWindow的setContentView方法中作为布局填充的父容器，伪代码记忆如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public void setContentView(int layoutResID) &#123;</div><div class="line">        ......</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            installDecor();</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">        mLayoutInflater.inflate(layoutResID, mContentParent); </div><div class="line"></div><div class="line">    &#125;</div><div class="line">   private void installDecor() &#123;</div><div class="line">        ......</div><div class="line">        if (mDecor == null) &#123;</div><div class="line">            mDecor = generateDecor(-1);</div><div class="line">        &#125;</div><div class="line">        if (mContentParent == null) &#123;</div><div class="line">            mContentParent = generateLayout(mDecor);</div><div class="line">            ......</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h2><p>在PhoneWindow的setContentView方法最后会执行回调</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void setContentView(int layoutResID) &#123;</div><div class="line">       ......</div><div class="line">        final Callback cb = getCallback();</div><div class="line">        if (cb != null &amp;&amp; !isDestroyed()) &#123;</div><div class="line">            cb.onContentChanged();</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里的cb位于Windows.java中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private Callback mCallback;</div><div class="line"></div><div class="line">public final Callback getCallback() &#123;</div><div class="line">    return mCallback;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void setCallback(Callback callback) &#123;</div><div class="line">    mCallback = callback;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Activity的attach方法中看到进行了设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">final void attach(Context context, ActivityThread aThread,</div><div class="line">    ......</div><div class="line">    mWindow.setCallback(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明Activity中实现了该方法，onContentChanged方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public void onContentChanged() &#123;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>竟然是个空方法，setContentView走完会执行该方法，因此我们可以把Activity的各种View的findViewById()方法等都可以放到该方法中，系统会帮忙回调。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>创建根视图DecorView对象mDecor</li>
<li>根据程序中选择的Activity的Theme/Style等属性值为窗口添加布局属性和相应的修饰文件</li>
<li>通过findViewById方法获取对应的根布局文件添加到mDecor</li>
<li>通过inflate（加载xml文件）或addView（加载View）方法将Activity的布局文件添加到mContentParent区域(id为content的FrameLayout)</li>
<li>回调Activity的onContentChanged方法</li>
</ul>
<h2 id="关系图"><a href="#关系图" class="headerlink" title="关系图"></a>关系图</h2><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/relationship.jpg" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/05/2017 movie list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/05/2017 movie list/" itemprop="url">2017 movie list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-05T00:00:00+08:00">
                2017-05-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/05/2017 movie list/" class="leancloud_visitors" data-flag-title="2017 movie list">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>记忆大师</li>
<li>春娇救志明</li>
<li>看不见的客人</li>
<li>消失的爱人</li>
<li>沉默的羔羊</li>
<li>逃出绝命镇</li>
<li>窃听风暴</li>
<li>美丽人生</li>
<li>恐怖游轮</li>
<li>宿醉1-3</li>
<li>玩命记忆</li>
<li>迷雾</li>
<li>致命ID</li>
<li>空中营救</li>
<li>摔跤吧爸爸</li>
<li>黄海</li>
<li>我是谁：没有绝对安全的系统</li>
<li>非凡任务</li>
<li>汉江怪物</li>
<li>龙之吻</li>
<li>敢死队1-2</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/04/30/2017 book list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/30/2017 book list/" itemprop="url">2017 book list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-30T00:00:00+08:00">
                2017-04-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/30/2017 book list/" class="leancloud_visitors" data-flag-title="2017 book list">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>明朝那些事(1-7)(Done)</li>
<li>网络是怎样连接的(Pending)</li>
<li>Android高级进阶(Pending)</li>
<li>Zero To One(Done)</li>
<li>算法图解(Done)</li>
<li>Android源码设计模式解析与实战(Pending)</li>
<li>腾讯传(Done)</li>
<li>追风筝的人(Done)</li>
<li>月亮和六便士(Done)</li>
<li>活着回来的男人(Pending)</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/04/28/Android Activity事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/28/Android Activity事件分发机制/" itemprop="url">Android Activity事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-28T00:00:00+08:00">
                2017-04-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/28/Android Activity事件分发机制/" class="leancloud_visitors" data-flag-title="Android Activity事件分发机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>平时使用的ViewGroup或View等控件都是包含在Activity中，那么它们三者事件分发顺序又是怎样的？</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity implements View.OnClickListener,View.OnTouchListener &#123;</div><div class="line"></div><div class="line">    private MyLayout myLayout;</div><div class="line">    private MyView myView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        myLayout = (MyLayout) findViewById(R.id.my_layout);</div><div class="line">        myView = (MyView) findViewById(R.id.my_view);</div><div class="line"></div><div class="line">        myLayout.setOnClickListener(this);</div><div class="line">        myLayout.setOnTouchListener(this);</div><div class="line"></div><div class="line">        myView.setOnClickListener(this);</div><div class="line">        myView.setOnTouchListener(this);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_layout:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onClick&quot;);</div><div class="line">                break;</div><div class="line">            case R.id.my_view:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onClick&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;Activity dispatchTouchEvent ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;Activity dispatchTouchEvent ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;Activity dispatchTouchEvent ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onUserInteraction() &#123;</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;Activity onUserInteraction run&quot;);</div><div class="line">        super.onUserInteraction();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouch(View v, MotionEvent event) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_layout:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyLayout onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyLayout onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyLayout onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case R.id.my_view:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyLayout.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by hcy on 17-4-26.</div><div class="line"> */</div><div class="line"></div><div class="line">public class MyLayout extends LinearLayout &#123;</div><div class="line">    public MyLayout(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyLayout(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyLayout(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onInterceptTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onInterceptTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onInterceptTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyLayout dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MyView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by hcy on 17-4-26.</div><div class="line"> */</div><div class="line"></div><div class="line">public class MyView extends TextView &#123;</div><div class="line">    public MyView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;com.example.hcy.activityevent.MyLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/my_layout&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.activityevent.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.example.hcy.activityevent.MyView</div><div class="line">        android:id=&quot;@+id/my_view&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Hello World!&quot; /&gt;</div><div class="line">&lt;/com.example.hcy.activityevent.MyLayout&gt;</div></pre></td></tr></table></figure>
<p>代码很简单，运行点击MyView，log打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">03-02 00:18:04.596 15312 15312 D hcy     : Activity dispatchTouchEvent ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : Activity onUserInteraction run</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyLayout dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyLayout onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyView onTouch ACTION_DOWN</div><div class="line">03-02 00:18:04.597 15312 15312 D hcy     : MyView onTouchEvent: ACTION_DOWN</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : Activity dispatchTouchEvent ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyLayout dispatchTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyLayout onInterceptTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyView dispatchTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyView onTouch ACTION_UP</div><div class="line">03-02 00:18:04.645 15312 15312 D hcy     : MyView onTouchEvent: ACTION_UP</div><div class="line">03-02 00:18:04.647 15312 15312 D hcy     : MyView onClick</div></pre></td></tr></table></figure>
<p>发现DOWN事件触发后最先经过Activity的dispatchTouchEvent方法，再由ViewGroup到View派发，ViewGroup到View的那一套流程之前已经分析过了，这里在DOWN的时候还调用了onUserInteraction 方法，而UP的时候并没有调用</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>查看Activity的dispatchTouchEvent 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called to process touch screen events.  You can override this to</div><div class="line"> * intercept all touch screen events before they are dispatched to the</div><div class="line"> * window.  Be sure to call this implementation for touch screen events</div><div class="line"> * that should be handled normally.</div><div class="line"> *</div><div class="line"> * @param ev The touch screen event.</div><div class="line"> *</div><div class="line"> * @return boolean Return true if this event was consumed.</div><div class="line"> */</div><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">    if (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        onUserInteraction();</div><div class="line">    &#125;</div><div class="line">    if (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">    return onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里看到第一个语句如果是DOWN事件，会执行onUserInteraction()方法，查看onUserInteraction方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called whenever a key, touch, or trackball event is dispatched to the</div><div class="line"> * activity.  Implement this method if you wish to know that the user has</div><div class="line"> * interacted with the device in some way while your activity is running.</div><div class="line"> * This callback and &#123;@link #onUserLeaveHint&#125; are intended to help</div><div class="line"> * activities manage status bar notifications intelligently; specifically,</div><div class="line"> * for helping activities determine the proper time to cancel a notfication.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;All calls to your activity&apos;s &#123;@link #onUserLeaveHint&#125; callback will</div><div class="line"> * be accompanied by calls to &#123;@link #onUserInteraction&#125;.  This</div><div class="line"> * ensures that your activity will be told of relevant user activity such</div><div class="line"> * as pulling down the notification pane and touching an item there.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that this callback will be invoked for the touch down action</div><div class="line"> * that begins a touch gesture, but may not be invoked for the touch-moved</div><div class="line"> * and touch-up actions that follow.</div><div class="line"> *</div><div class="line"> * @see #onUserLeaveHint()</div><div class="line"> */</div><div class="line">public void onUserInteraction() &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法是个空方法，没用过暂时还不清楚是干嘛的，从注释大致介绍该方法可以帮助activity智能管理状态栏上的通知，例如在适当的时候删除通知。</p>
<p>继续回到前面分析，第二个if判断语句判断getWindow().superDispatchTouchEvent(ev)的返回值，若为true则返回true，反正返回activity自身的onTouchEvent(ev)。<br>Activity中的getWindow()方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Retrieve the current &#123;@link android.view.Window&#125; for the activity.</div><div class="line"> * This can be used to directly access parts of the Window API that</div><div class="line"> * are not available through Activity/Screen.</div><div class="line"> *</div><div class="line"> * @return Window The current window, or null if the activity is not</div><div class="line"> *         visual.</div><div class="line"> */</div><div class="line">public Window getWindow() &#123;</div><div class="line">    return mWindow;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的mWindow是Window的一个实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private Window mWindow;</div></pre></td></tr></table></figure>
<p>而它的实例化是在Activity的attach方法中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">final void attach(Context context, ActivityThread aThread,</div><div class="line">        Instrumentation instr, IBinder token, int ident,</div><div class="line">        Application application, Intent intent, ActivityInfo info,</div><div class="line">        CharSequence title, Activity parent, String id,</div><div class="line">        NonConfigurationInstances lastNonConfigurationInstances,</div><div class="line">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">        Window window) &#123;</div><div class="line">    attachBaseContext(context);</div><div class="line"></div><div class="line">    mFragments.attachHost(null /*parent*/);</div><div class="line"></div><div class="line">    mWindow = new PhoneWindow(this, window);</div><div class="line">    mWindow.setWindowControllerCallback(this);</div><div class="line">    mWindow.setCallback(this);</div><div class="line">    mWindow.setOnWindowDismissedCallback(this);</div><div class="line">    mWindow.getLayoutInflater().setPrivateFactory(this);</div><div class="line">    if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</div><div class="line">        mWindow.setSoftInputMode(info.softInputMode);</div><div class="line">    &#125;</div><div class="line">    if (info.uiOptions != 0) &#123;</div><div class="line">        mWindow.setUiOptions(info.uiOptions);</div><div class="line">    &#125;</div><div class="line">    mUiThread = Thread.currentThread();</div><div class="line"></div><div class="line">    mMainThread = aThread;</div><div class="line">    mInstrumentation = instr;</div><div class="line">    mToken = token;</div><div class="line">    mIdent = ident;</div><div class="line">    mApplication = application;</div><div class="line">    mIntent = intent;</div><div class="line">    mReferrer = referrer;</div><div class="line">    mComponent = intent.getComponent();</div><div class="line">    mActivityInfo = info;</div><div class="line">    mTitle = title;</div><div class="line">    mParent = parent;</div><div class="line">    mEmbeddedID = id;</div><div class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</div><div class="line">    if (voiceInteractor != null) &#123;</div><div class="line">        if (lastNonConfigurationInstances != null) &#123;</div><div class="line">            mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor;</div><div class="line">        &#125; else &#123;</div><div class="line">            mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this,</div><div class="line">                    Looper.myLooper());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mWindow.setWindowManager(</div><div class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</div><div class="line">            mToken, mComponent.flattenToString(),</div><div class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0);</div><div class="line">    if (mParent != null) &#123;</div><div class="line">        mWindow.setContainer(mParent.getWindow());</div><div class="line">    &#125;</div><div class="line">    mWindowManager = mWindow.getWindowManager();</div><div class="line">    mCurrentConfig = config;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Window是个抽象类，通过new PhoneWindow实例化mWindow，因此去PhoneWindow类中查看superDispatchTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    return mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里把皮球踢给了mDecor，那mDecor又是啥呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private final class DecorView extends FrameLayout implements RootViewSurfaceTaker</div></pre></td></tr></table></figure>
<p>DecorView是PhoneWindow的一个内部类，并且是FrameLayout的子类，而FrameLayout是ViewGroup的子类，因此DecorView也是个ViewGroup，看下它里面的superDispatchTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public boolean superDispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    return super.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原来到头来是调用ViewGroup的dispatchTouchEvent方法，接下来就是ViewGroup的那一套流程，上一篇已经分析过了。<br>另外通过SDK下的hierarchyviewer工具可以查看当前进程的UI层级</p>
<p><a href="http://upload-images.jianshu.io/upload_images/989851-eafe6ca9ebbf7131.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-eafe6ca9ebbf7131.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="hierarchyviewer1.png"></a><br><a href="http://upload-images.jianshu.io/upload_images/989851-c8114f19d488bdaf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-c8114f19d488bdaf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="hierarchyviewer2.png"></a><br>可以看到自定义的LinearLayout被放在一个id为content的FrameLayout里。</p>
<p>回过头来继续看下Activity中onTouchEvent方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called when a touch screen event was not handled by any of the views</div><div class="line"> * under it.  This is most useful to process touch events that happen</div><div class="line"> * outside of your window bounds, where there is no view to receive it.</div><div class="line"> *</div><div class="line"> * @param event The touch screen event being processed.</div><div class="line"> *</div><div class="line"> * @return Return true if you have consumed the event, false if you haven&apos;t.</div><div class="line"> * The default implementation always returns false.</div><div class="line"> */</div><div class="line">public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">    if (mWindow.shouldCloseOnTouch(this, event)) &#123;</div><div class="line">        finish();</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注解可以大致了解该方法的作用：<br>该方法被调用当一个触摸屏幕的事件未被Activity下任何一个View处理，这对于处理发生在Window边界外的触摸事件是很有用的，因为没有View可以接收到事件，返回true代表消费事件，false表示未消费，默认返回false。<br>看下if判断，在PhoneWindow未中找到shouldCloseOnTouch方法，那就去它爹里面找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/** @hide */</div><div class="line">public boolean shouldCloseOnTouch(Context context, MotionEvent event) &#123;</div><div class="line">    if (mCloseOnTouchOutside &amp;&amp; event.getAction() == MotionEvent.ACTION_DOWN</div><div class="line">            &amp;&amp; isOutOfBounds(context, event) &amp;&amp; peekDecorView() != null) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面主要是判断mCloseOnTouchOutside的值，当前的是否是DOWN事件，event的坐标是否在边界内，DecorView是否为null，这些主要是对于处理边界外touch的判断。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.触摸屏幕的事件首先会经过Activity的dispatchTouchEvent方法，如果是DOWN，会调用onUserInteraction方法，Activity分发事件本质与ViewGroup相同，因为Activity的root view是一个继承自FrameLayout的ViewGroup，再调用ViewGroup的dispatchTouchEvent方法分发到处理该事件的子View。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/04/26/Android ViewGroup事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/26/Android ViewGroup事件分发机制/" itemprop="url">Android ViewGroup事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-26T00:00:00+08:00">
                2017-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/26/Android ViewGroup事件分发机制/" class="leancloud_visitors" data-flag-title="Android ViewGroup事件分发机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>接上篇继续分析Android中ViewGroup的事件分发机制,在分析之前先看一张官网ViewGroup的介绍图    <img src="http://7xjvg5.com1.z0.glb.clouddn.com/WechatIMG5.png" style="zoom:50%"></p>
<p>可以看到平时常用的那些布局如LinearLayout、FrameLayout等都是ViewGroup的子类,而ViewGroup是View的子类,API中也说了, ViewGroup是个可以包含其他View的特殊View。ViewGroup重写了dispatchTouchEvent,与View相比多了onInterceptTouchEvent方法用来判断是否拦截事件,onTouchEvent方法未重写和View保持一致。</p>
<h2 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h2><p>MainActiviy.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity implements View.OnClickListener,View.OnTouchListener&#123;</div><div class="line">    private SonView sonView;</div><div class="line">    private GrandView grandView;</div><div class="line">    private ParentView parentView;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        sonView = (SonView) findViewById(R.id.son);</div><div class="line">        parentView = (ParentView) findViewById(R.id.parent);</div><div class="line">        grandView = (GrandView) findViewById(R.id.grand);</div><div class="line"></div><div class="line">        sonView.setOnClickListener(this);</div><div class="line">        sonView.setOnTouchListener(this);</div><div class="line"></div><div class="line">        parentView.setOnClickListener(this);</div><div class="line">        parentView.setOnTouchListener(this);</div><div class="line"></div><div class="line">        grandView.setOnClickListener(this);</div><div class="line">        grandView.setOnTouchListener(this);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.grand:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onClick&quot;);</div><div class="line">                break;</div><div class="line">            case R.id.parent:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onClick&quot;);</div><div class="line">                break;</div><div class="line">            case R.id.son:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onClick&quot;);</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouch(View v, MotionEvent event) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.grand:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;GrandView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;GrandView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;GrandView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case R.id.parent:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;ParentView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;ParentView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;ParentView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case R.id.son:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;SonView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;SonView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;SonView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>GrandView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">public class GrandView extends LinearLayout &#123;</div><div class="line">    public GrandView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public GrandView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public GrandView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onInterceptTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onInterceptTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView onInterceptTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;GrandView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ParentView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">public class ParentView extends LinearLayout &#123;</div><div class="line">    public ParentView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ParentView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ParentView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onInterceptTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onInterceptTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onInterceptTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;ParentView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SonView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">public class SonView extends View &#123;</div><div class="line"></div><div class="line">    public SonView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SonView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public SonView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">        switch (event.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView onTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">        switch (ev.getAction()) &#123;</div><div class="line">            case MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView dispatchTouchEvent: ACTION_DOWN&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView dispatchTouchEvent: ACTION_MOVE&quot;);</div><div class="line">                break;</div><div class="line">            case MotionEvent.ACTION_UP:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;SonView dispatchTouchEvent: ACTION_UP&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        return super.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_main&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.event.MainActivity&quot;&gt;</div><div class="line">    &lt;com.example.hcy.event.view.GrandView</div><div class="line">        android:id=&quot;@+id/grand&quot;</div><div class="line">        android:background=&quot;@android:color/holo_orange_dark&quot;</div><div class="line">        android:gravity=&quot;center&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line">        &lt;com.example.hcy.event.view.ParentView</div><div class="line">            android:id=&quot;@+id/parent&quot;</div><div class="line">            android:background=&quot;@android:color/holo_purple&quot;</div><div class="line">            android:gravity=&quot;center&quot;</div><div class="line">            android:layout_width=&quot;300dp&quot;</div><div class="line">            android:layout_height=&quot;300dp&quot;&gt;</div><div class="line">            &lt;com.example.hcy.event.view.SonView</div><div class="line">                android:id=&quot;@+id/son&quot;</div><div class="line">                android:layout_width=&quot;200dp&quot;</div><div class="line">                android:layout_height=&quot;200dp&quot;</div><div class="line">                android:background=&quot;@android:color/holo_green_dark&quot;</div><div class="line">                android:gravity=&quot;center&quot;/&gt;</div><div class="line">        &lt;/com.example.hcy.event.view.ParentView&gt;</div><div class="line">    &lt;/com.example.hcy.event.view.GrandView&gt;</div><div class="line"></div><div class="line">&lt;/FrameLayout&gt;</div></pre></td></tr></table></figure>
<p>点击中间的SonView，log打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : ParentView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : SonView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : SonView onTouch ACTION_DOWN</div><div class="line">03-12 17:29:49.680 12809 12809 D hcy     : SonView onTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : ParentView onInterceptTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : SonView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : SonView onTouch ACTION_UP</div><div class="line">03-12 17:29:49.709 12809 12809 D hcy     : SonView onTouchEvent: ACTION_UP</div><div class="line">03-12 17:29:49.710 12809 12809 D hcy     : SonView onClick</div></pre></td></tr></table></figure>
<p>从上面的log中可以看出事件是先传递到最外层的ViewGroup，再由ViewGroup递归传递到消费事件的具体View。与ViewGroup相比，View中没有onInterceptTouchEvent方法，因此不存在拦截。</p>
<h2 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h2><p>将SonView的onTouchEvent方法返回值改为false。<br>点击SonView区域打印日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView onInterceptTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : SonView dispatchTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : SonView onTouch ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : SonView onTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView onTouch ACTION_DOWN</div><div class="line">03-12 17:43:49.257 12809 12809 D hcy     : ParentView onTouchEvent: ACTION_DOWN</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : GrandView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : GrandView onInterceptTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : ParentView dispatchTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : ParentView onTouch ACTION_UP</div><div class="line">03-12 17:43:49.278 12809 12809 D hcy     : ParentView onTouchEvent: ACTION_UP</div><div class="line">03-12 17:43:49.279 12809 12809 D hcy     : ParentView onClick</div></pre></td></tr></table></figure>
<p>对比之前的log，DOWN的时候在SonView执行完onTouchEvent方法后，又执行了ParentView 的onTouch和onTouchEvent 方法，并且在UP的时候ParentView 不再执行onInterceptTouchEvent 方法，后面SonView不再接收UP事件。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>查看ViewGroup中的dispatchTouchEvent方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">    if (mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onTouchEvent(ev, 1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // If the event targets the accessibility focused view and this is it, start</div><div class="line">    // normal event dispatch. Maybe a descendant is what will handle the click.</div><div class="line">    if (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">        ev.setTargetAccessibilityFocus(false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    boolean handled = false;</div><div class="line">    if (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">        final int action = ev.getAction();</div><div class="line">        final int actionMasked = action &amp; MotionEvent.ACTION_MASK;</div><div class="line"></div><div class="line">        // Handle an initial down.</div><div class="line">        if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            // Throw away all previous state when starting a new touch gesture.</div><div class="line">            // The framework may have dropped the up or cancel event for the previous gesture</div><div class="line">            // due to an app switch, ANR, or some other state change.</div><div class="line">            cancelAndClearTouchTargets(ev);</div><div class="line">            resetTouchState();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Check for interception.</div><div class="line">        final boolean intercepted;</div><div class="line">        if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">                || mFirstTouchTarget != null) &#123;</div><div class="line">            final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;</div><div class="line">            if (!disallowIntercept) &#123;</div><div class="line">                intercepted = onInterceptTouchEvent(ev);</div><div class="line">                ev.setAction(action); // restore action in case it was changed</div><div class="line">            &#125; else &#123;</div><div class="line">                intercepted = false;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // There are no touch targets and this action is not an initial down</div><div class="line">            // so this view group continues to intercept touches.</div><div class="line">            intercepted = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If intercepted, start normal event dispatch. Also if there is already</div><div class="line">        // a view that is handling the gesture, do normal event dispatch.</div><div class="line">        if (intercepted || mFirstTouchTarget != null) &#123;</div><div class="line">            ev.setTargetAccessibilityFocus(false);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Check for cancelation.</div><div class="line">        final boolean canceled = resetCancelNextUpFlag(this)</div><div class="line">                || actionMasked == MotionEvent.ACTION_CANCEL;</div><div class="line"></div><div class="line">        // Update list of touch targets for pointer down, if needed.</div><div class="line">        final boolean split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != 0;</div><div class="line">        TouchTarget newTouchTarget = null;</div><div class="line">        boolean alreadyDispatchedToNewTouchTarget = false;</div><div class="line">        if (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line"></div><div class="line">            // If the event is targeting accessiiblity focus we give it to the</div><div class="line">            // view that has accessibility focus and if it does not handle it</div><div class="line">            // we clear the flag and dispatch the event to all children as usual.</div><div class="line">            // We are looking up the accessibility focused host to avoid keeping</div><div class="line">            // state since these events are very rare.</div><div class="line">            View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus()</div><div class="line">                    ? findChildWithAccessibilityFocus() : null;</div><div class="line"></div><div class="line">            if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">                    || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</div><div class="line">                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">                final int actionIndex = ev.getActionIndex(); // always 0 for down</div><div class="line">                final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex)</div><div class="line">                        : TouchTarget.ALL_POINTER_IDS;</div><div class="line"></div><div class="line">                // Clean up earlier touch targets for this pointer id in case they</div><div class="line">                // have become out of sync.</div><div class="line">                removePointersFromTouchTargets(idBitsToAssign);</div><div class="line"></div><div class="line">                final int childrenCount = mChildrenCount;</div><div class="line">                if (newTouchTarget == null &amp;&amp; childrenCount != 0) &#123;</div><div class="line">                    final float x = ev.getX(actionIndex);</div><div class="line">                    final float y = ev.getY(actionIndex);</div><div class="line">                    // Find a child that can receive the event.</div><div class="line">                    // Scan children from front to back.</div><div class="line">                    final ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</div><div class="line">                    final boolean customOrder = preorderedList == null</div><div class="line">                            &amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">                    final View[] children = mChildren;</div><div class="line">                    for (int i = childrenCount - 1; i &gt;= 0; i--) &#123;</div><div class="line">                        final int childIndex = getAndVerifyPreorderedIndex(</div><div class="line">                                childrenCount, i, customOrder);</div><div class="line">                        final View child = getAndVerifyPreorderedView(</div><div class="line">                                preorderedList, children, childIndex);</div><div class="line"></div><div class="line">                        // If there is a view that has accessibility focus we want it</div><div class="line">                        // to get the event first and if not handled we will perform a</div><div class="line">                        // normal dispatch. We may do a double iteration but this is</div><div class="line">                        // safer given the timeframe.</div><div class="line">                        if (childWithAccessibilityFocus != null) &#123;</div><div class="line">                            if (childWithAccessibilityFocus != child) &#123;</div><div class="line">                                continue;</div><div class="line">                            &#125;</div><div class="line">                            childWithAccessibilityFocus = null;</div><div class="line">                            i = childrenCount - 1;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        if (!canViewReceivePointerEvents(child)</div><div class="line">                                || !isTransformedTouchPointInView(x, y, child, null)) &#123;</div><div class="line">                            ev.setTargetAccessibilityFocus(false);</div><div class="line">                            continue;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        newTouchTarget = getTouchTarget(child);</div><div class="line">                        if (newTouchTarget != null) &#123;</div><div class="line">                            // Child is already receiving touch within its bounds.</div><div class="line">                            // Give it the new pointer in addition to the ones it is handling.</div><div class="line">                            newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        resetCancelNextUpFlag(child);</div><div class="line">                        if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) &#123;</div><div class="line">                            // Child wants to receive touch within its bounds.</div><div class="line">                            mLastTouchDownTime = ev.getDownTime();</div><div class="line">                            if (preorderedList != null) &#123;</div><div class="line">                                // childIndex points into presorted list, find original index</div><div class="line">                                for (int j = 0; j &lt; childrenCount; j++) &#123;</div><div class="line">                                    if (children[childIndex] == mChildren[j]) &#123;</div><div class="line">                                        mLastTouchDownIndex = j;</div><div class="line">                                        break;</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125; else &#123;</div><div class="line">                                mLastTouchDownIndex = childIndex;</div><div class="line">                            &#125;</div><div class="line">                            mLastTouchDownX = ev.getX();</div><div class="line">                            mLastTouchDownY = ev.getY();</div><div class="line">                            newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">                            alreadyDispatchedToNewTouchTarget = true;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        // The accessibility focus didn&apos;t handle the event, so clear</div><div class="line">                        // the flag and do a normal dispatch to all children.</div><div class="line">                        ev.setTargetAccessibilityFocus(false);</div><div class="line">                    &#125;</div><div class="line">                    if (preorderedList != null) preorderedList.clear();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) &#123;</div><div class="line">                    // Did not find a child to receive the event.</div><div class="line">                    // Assign the pointer to the least recently added target.</div><div class="line">                    newTouchTarget = mFirstTouchTarget;</div><div class="line">                    while (newTouchTarget.next != null) &#123;</div><div class="line">                        newTouchTarget = newTouchTarget.next;</div><div class="line">                    &#125;</div><div class="line">                    newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Dispatch to touch targets.</div><div class="line">        if (mFirstTouchTarget == null) &#123;</div><div class="line">            // No touch targets so treat this as an ordinary view.</div><div class="line">            handled = dispatchTransformedTouchEvent(ev, canceled, null,</div><div class="line">                    TouchTarget.ALL_POINTER_IDS);</div><div class="line">        &#125; else &#123;</div><div class="line">            // Dispatch to touch targets, excluding the new touch target if we already</div><div class="line">            // dispatched to it.  Cancel touch targets if necessary.</div><div class="line">            TouchTarget predecessor = null;</div><div class="line">            TouchTarget target = mFirstTouchTarget;</div><div class="line">            while (target != null) &#123;</div><div class="line">                final TouchTarget next = target.next;</div><div class="line">                if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">                    handled = true;</div><div class="line">                &#125; else &#123;</div><div class="line">                    final boolean cancelChild = resetCancelNextUpFlag(target.child)</div><div class="line">                            || intercepted;</div><div class="line">                    if (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">                            target.child, target.pointerIdBits)) &#123;</div><div class="line">                        handled = true;</div><div class="line">                    &#125;</div><div class="line">                    if (cancelChild) &#123;</div><div class="line">                        if (predecessor == null) &#123;</div><div class="line">                            mFirstTouchTarget = next;</div><div class="line">                        &#125; else &#123;</div><div class="line">                            predecessor.next = next;</div><div class="line">                        &#125;</div><div class="line">                        target.recycle();</div><div class="line">                        target = next;</div><div class="line">                        continue;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                predecessor = target;</div><div class="line">                target = next;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Update list of touch targets for pointer up or cancel, if needed.</div><div class="line">        if (canceled</div><div class="line">                || actionMasked == MotionEvent.ACTION_UP</div><div class="line">                || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</div><div class="line">            resetTouchState();</div><div class="line">        &#125; else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</div><div class="line">            final int actionIndex = ev.getActionIndex();</div><div class="line">            final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex);</div><div class="line">            removePointersFromTouchTargets(idBitsToRemove);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1);</div><div class="line">    &#125;</div><div class="line">    return handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从第13行开始看，定义了boolean的变量handled，该值就是dispatchTouchEvent方法的返回值，14行判断当前ViewGroup是否没被遮挡，获取当前的事件action，19-25行对于事件为DOWN做了特殊处理，调用cancelAndClearTouchTargets清除所有的触摸控件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Cancels and clears all touch targets.</div><div class="line"> */</div><div class="line">private void cancelAndClearTouchTargets(MotionEvent event) &#123;</div><div class="line">    if (mFirstTouchTarget != null) &#123;</div><div class="line">        boolean syntheticEvent = false;</div><div class="line">        if (event == null) &#123;</div><div class="line">            final long now = SystemClock.uptimeMillis();</div><div class="line">            event = MotionEvent.obtain(now, now,</div><div class="line">                    MotionEvent.ACTION_CANCEL, 0.0f, 0.0f, 0);</div><div class="line">            event.setSource(InputDevice.SOURCE_TOUCHSCREEN);</div><div class="line">            syntheticEvent = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (TouchTarget target = mFirstTouchTarget; target != null; target = target.next) &#123;</div><div class="line">            resetCancelNextUpFlag(target.child);</div><div class="line">            dispatchTransformedTouchEvent(event, true, target.child, target.pointerIdBits);</div><div class="line">        &#125;</div><div class="line">        clearTouchTargets();</div><div class="line"></div><div class="line">        if (syntheticEvent) &#123;</div><div class="line">            event.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有个很重要的变量mFirstTouchTarget ，只有该实例不为空的情况下才会执行后续的操作，我们假设这里的DOWN事件是有史以来第一次，那么mFirstTouchTarget 声明后并没有赋值，因此为null，就不存在后面的一系列清除操作，同样resetTouchState方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Resets all touch state in preparation for a new cycle.</div><div class="line"> */</div><div class="line">private void resetTouchState() &#123;</div><div class="line">    clearTouchTargets();</div><div class="line">    resetCancelNextUpFlag(this);</div><div class="line">    mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;</div><div class="line">    mNestedScrollAxes = SCROLL_AXIS_NONE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Clears all touch targets.</div><div class="line"> */</div><div class="line">private void clearTouchTargets() &#123;</div><div class="line">    TouchTarget target = mFirstTouchTarget;</div><div class="line">    if (target != null) &#123;</div><div class="line">        do &#123;</div><div class="line">            TouchTarget next = target.next;</div><div class="line">            target.recycle();</div><div class="line">            target = next;</div><div class="line">        &#125; while (target != null);</div><div class="line">        mFirstTouchTarget = null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>都是因为mFirstTouchTarget为null所以不会执行，可能存在之前发生ANR等导致触摸事件未清除的情况，因此19-25行对于DOWN的操作只是确保了mFirstTouchTarget为null，为后续的操作奠定基础。</p>
<p>28-42行判断是否拦截事件取决于boolean值intercepted，如果事件为DOWN或者mFirstTouchTarget！=null，获取一个boolean的值disallowIntercept，这里的默认值为false，所以intercepted的值由onInterceptTouchEvent(ev)方法的返回值决定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public boolean onInterceptTouchEvent(MotionEvent ev) &#123;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到该方法默认返回false，即不拦截，如果是其他事件，并且mFirstTouchTarget为null，那这里的intercepted就为true。这块代码解释了例子1中的执行完dispatchTouchEvent之后马上执行onInterceptTouchEvent的原因，而例子2中UP时不执行onInterceptTouchEvent在这里看来很有可能是mFirstTouchTarget == null引起的，带着问题继续往下看。</p>
<p>51-52行判断是否为cancel<br>55行获取boolean值split默认为true，判断是否分发给子View<br>58行if (!canceled &amp;&amp; !intercepted)判断如果不是cancle事件，且ViewGroup不拦截成立，进入内部<br>68-70行开始对于DOWN事件进行的处理，首先在85行通过buildTouchDispatchChildList方法获取一个子View集合的preorderedList，89行倒序遍历子View，113行通过getTouchTarget方法判断是否找到子View在target链上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Gets the touch target for specified child view.</div><div class="line"> * Returns null if not found.</div><div class="line"> */</div><div class="line">private TouchTarget getTouchTarget(@NonNull View child) &#123;</div><div class="line">    for (TouchTarget target = mFirstTouchTarget; target != null; target = target.next) &#123;</div><div class="line">        if (target.child == child) &#123;</div><div class="line">            return target;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果匹配，则说明找到接收该事件的子View，执行114-119行代码跳出循环，这里我们仍然假设是有史以来的第一次DOWN事件，mFirstTouchTarget为null，因此不匹配，返回null，执行122行的if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) 判断<br>dispatchTransformedTouchEvent方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line"> * Transforms a motion event into the coordinate space of a particular child view,</div><div class="line"> * filters out irrelevant pointer ids, and overrides its action if necessary.</div><div class="line"> * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</div><div class="line"> */</div><div class="line">private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,</div><div class="line">        View child, int desiredPointerIdBits) &#123;</div><div class="line">    final boolean handled;</div><div class="line"></div><div class="line">    // Canceling motions is a special case.  We don&apos;t need to perform any transformations</div><div class="line">    // or filtering.  The important part is the action, not the contents.</div><div class="line">    final int oldAction = event.getAction();</div><div class="line">    if (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123;</div><div class="line">        event.setAction(MotionEvent.ACTION_CANCEL);</div><div class="line">        if (child == null) &#123;</div><div class="line">            handled = super.dispatchTouchEvent(event);</div><div class="line">        &#125; else &#123;</div><div class="line">            handled = child.dispatchTouchEvent(event);</div><div class="line">        &#125;</div><div class="line">        event.setAction(oldAction);</div><div class="line">        return handled;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Calculate the number of pointers to deliver.</div><div class="line">    final int oldPointerIdBits = event.getPointerIdBits();</div><div class="line">    final int newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</div><div class="line"></div><div class="line">    // If for some reason we ended up in an inconsistent state where it looks like we</div><div class="line">    // might produce a motion event with no pointers in it, then drop the event.</div><div class="line">    if (newPointerIdBits == 0) &#123;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // If the number of pointers is the same and we don&apos;t need to perform any fancy</div><div class="line">    // irreversible transformations, then we can reuse the motion event for this</div><div class="line">    // dispatch as long as we are careful to revert any changes we make.</div><div class="line">    // Otherwise we need to make a copy.</div><div class="line">    final MotionEvent transformedEvent;</div><div class="line">    if (newPointerIdBits == oldPointerIdBits) &#123;</div><div class="line">        if (child == null || child.hasIdentityMatrix()) &#123;</div><div class="line">            if (child == null) &#123;</div><div class="line">                handled = super.dispatchTouchEvent(event);</div><div class="line">            &#125; else &#123;</div><div class="line">                final float offsetX = mScrollX - child.mLeft;</div><div class="line">                final float offsetY = mScrollY - child.mTop;</div><div class="line">                event.offsetLocation(offsetX, offsetY);</div><div class="line"></div><div class="line">                handled = child.dispatchTouchEvent(event);</div><div class="line"></div><div class="line">                event.offsetLocation(-offsetX, -offsetY);</div><div class="line">            &#125;</div><div class="line">            return handled;</div><div class="line">        &#125;</div><div class="line">        transformedEvent = MotionEvent.obtain(event);</div><div class="line">    &#125; else &#123;</div><div class="line">        transformedEvent = event.split(newPointerIdBits);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Perform any necessary transformations and dispatch.</div><div class="line">    if (child == null) &#123;</div><div class="line">        handled = super.dispatchTouchEvent(transformedEvent);</div><div class="line">    &#125; else &#123;</div><div class="line">        final float offsetX = mScrollX - child.mLeft;</div><div class="line">        final float offsetY = mScrollY - child.mTop;</div><div class="line">        transformedEvent.offsetLocation(offsetX, offsetY);</div><div class="line">        if (! child.hasIdentityMatrix()) &#123;</div><div class="line">            transformedEvent.transform(child.getInverseMatrix());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        handled = child.dispatchTouchEvent(transformedEvent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Done.</div><div class="line">    transformedEvent.recycle();</div><div class="line">    return handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据注解大概分析，如果这里的child为null，事件会交给ViewGroup处理。该方法的第三个参数为空则调用super.dispatchTouchEvent(event)，不为空则调用child.dispatchTouchEvent(event);如果子View是个ViewGroup并且未对Touch事件拦截(onInterceptTouchEvent方法为false)，则递归调用dispatchTouchEvent；如果子View是个View，就调用其onTouchEvent()方法。最后，如果dispatchTransformedTouchEvent返回true，说明子View消费了该事件，122-141行中将addTouchTarget方法的返回值赋给newTouchTarget，将alreadyDispatchedToNewTouchTarget标志位置为true，同时跳出循环，查看addTouchTarget方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) &#123;</div><div class="line">    final TouchTarget target = TouchTarget.obtain(child, pointerIdBits);</div><div class="line">    target.next = mFirstTouchTarget;</div><div class="line">    mFirstTouchTarget = target;</div><div class="line">    return target;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>找了一圈终于看到在这里对mFirstTouchTarget 进行赋值了。<br>如果这里的if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign))判断为false，说明子View的未消费该事件，就不会执行addTouchTarget给mFirstTouchTarget 赋值，这就是例子2中UP的时候ParentView的onInterceptTouchEvent方法不执行的原因。</p>
<p>163行判断mFirstTouchTarget 是否为null，<br>如果当前事件为DOWN，在122行判断中返回false，即子View不消费事件，那么mFirstTouchTarget 未赋值为null成立，也就是例子2的情况，调用dispatchTransformedTouchEvent方法，第三个参数传入null，此时对于ParentView而言，会执行super.dispatchTouchEvent(event)，也就是View的dispatchTouchEvent方法，又因为ParentView复写了onTouch和onTouchEvent方法，所以看到log中打出了ParentView这两个方法的打印。之后UP事件过来，前面29-30行的判断都不满足，所以ParentView的onInterceptTouchEvent方法不执行，41行对intercepted赋值为true，即拦截事件，那么从58-160都不满足了，回到163行，同理执行super.dispatchTouchEvent(event)。</p>
<p>如果mFirstTouchTarget不为null，174行有个判断，之前DOWN事件时alreadyDispatchedToNewTouchTarget置为true，并且也给newTouchTarget赋值为target，这里判断成立，handled返回true说明已经处理了DOWN事件。对于MOVE或者UP事件，会走到179-182行中，同样是调用dispatchTransformedTouchEvent，handled值返回true。<br>203行对于UP执行完后调用resetTouchState()方法清除触摸状态，将mFirstTouchTarget 再次置为null，算是收尾工作。</p>
<h2 id="缩减版"><a href="#缩减版" class="headerlink" title="缩减版"></a>缩减版</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">    //如果是DOWN，确保mFirstTouchTarget 为null</div><div class="line">    if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        mFirstTouchTarget == null;</div><div class="line">    &#125;</div><div class="line">    //判断是否拦截</div><div class="line">    final boolean intercepted;</div><div class="line">    if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">            || mFirstTouchTarget != null) &#123;</div><div class="line">        //Down或者mFirstTouchTarget!=null时将onInterceptTouchEvent值赋给intercepted，默认为false</div><div class="line">        intercepted = onInterceptTouchEvent(ev);</div><div class="line">    &#125; else &#123;</div><div class="line">        //除了Down,如果mFirstTouchTarget为null,则拦截</div><div class="line">        intercepted = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //不拦截的情况下</div><div class="line">    if(!intercepted)&#123;</div><div class="line">        if(actionMasked == MotionEvent.ACTION_DOWN)&#123;</div><div class="line">            //如果是Down，判断子View是否消费</div><div class="line">            if(dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign))&#123;</div><div class="line">                //如果子Viwe消费,给mFirstTouchTarget赋值</div><div class="line">                mFirstTouchTarget = target</div><div class="line">            &#125;else&#123;</div><div class="line">                //如果子Viwe不消费mFirstTouchTarget未赋值仍为null</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if(mFirstTouchTarget == null)&#123;</div><div class="line">        //子View不消费，调用自身的super.dispatchTouchEvent(event)</div><div class="line">        handled = dispatchTransformedTouchEvent(ev, canceled, null,</div><div class="line">                    TouchTarget.ALL_POINTER_IDS);</div><div class="line">    &#125;else&#123;</div><div class="line">        //子View消费，递归调用child.dispatchTouchEvent(event)分发事件给具体的View</div><div class="line">        handled = dispatchTransformedTouchEvent(ev, cancelChild,target.child,</div><div class="line">                    target.pointerIdBits);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.Android的事件分发是先通过最外层的ViewGroup再传递到内部具体的View<br>2.如果ViewGroup的onInterceptTouchEvent返回false，接收到DOWN事件处理完成，之后的MOVE,UP等事件会继续先传递给该ViewGroup，再传递给目标View的onTouchEvent处理。如果ViewGroup的onInterceptTouchEvent返回true，那么接收到DOWN事件处理完成，之后的MOVE,UP等事件只会传递给该ViewGroup的onTouchEvent()处理，目标View接收不到任何事件；<br>3.如果最终需要处理事件的view的onTouchEvent()返回了false，那么该事件将被传递至其上一层次的view的onTouchEvent()处理；<br>4.如果最终需要处理事件的view 的onTouchEvent()返回了true，那么后续事件将可以继续传递给该view的onTouchEvent()处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/04/20/Android View事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/20/Android View事件分发机制/" itemprop="url">Android View事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-20T00:00:00+08:00">
                2017-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/04/20/Android View事件分发机制/" class="leancloud_visitors" data-flag-title="Android View事件分发机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>事件分发一直是一知半解的状态，最近在复习Launcher的拖拽机制，其中很多地方都涉及到事件分发，索性把事件分发这一块拿出来再学一遍。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity implements View.OnTouchListener,View.OnClickListener&#123;</div><div class="line"></div><div class="line">    private MyTextView myTextView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        myTextView = (MyTextView) findViewById(R.id.my_textview);</div><div class="line">        myTextView.setOnClickListener(this);</div><div class="line">        myTextView.setOnTouchListener(this);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onClick(View v) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_textview:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;MyTextView onClick&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onTouch(View v, MotionEvent event) &#123;</div><div class="line">        switch (v.getId()) &#123;</div><div class="line">            case R.id.my_textview:</div><div class="line">                switch (event.getAction()) &#123;</div><div class="line">                    case MotionEvent.ACTION_DOWN:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyTextView onTouch ACTION_DOWN&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_MOVE:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyTextView onTouch ACTION_MOVE&quot;);</div><div class="line">                        break;</div><div class="line">                    case MotionEvent.ACTION_UP:</div><div class="line">                        Log.d(&quot;hcy&quot;, &quot;MyTextView onTouch ACTION_UP&quot;);</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        break;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_main&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    tools:context=&quot;com.example.hcy.viewevent.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.example.hcy.viewevent.MyTextView</div><div class="line">        android:id=&quot;@+id/my_textview&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Hello World!&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>MyTextView.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class MyTextView extends TextView &#123;</div><div class="line">    public MyTextView(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public MyTextView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码很简单，点击下MyTextView 打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">03-01 00:07:19.369 11770 11770 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:07:19.417 11770 11770 D hcy     : MyTextView onTouch ACTION_UP</div><div class="line">03-01 00:07:19.422 11770 11770 D hcy     : MyTextView onClick</div></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从上面的日志来看onTouch先于onClick 执行，onTouch方法执行了两次，对应手指的DOWN和UP，之后才执行onClick，onTouch有返回值，默认为false，onClick无返回值。</p>
<p>将onTouch的返回值改为true，点击下MyTextView 打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">03-01 00:20:52.987 11770 11770 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:20:53.052 11770 11770 D hcy     : MyTextView onTouch ACTION_UP</div></pre></td></tr></table></figure>
<p>发现当把onTouch的返回值改为true后，onTouch的Down和UP照样执行而onClick方法不会执行。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>1.onTouch方法先于onClick方法执行<br>2.onTouch方法的返回true会阻止事件继续向下传递</p>
<p>View中有dispatchTouchEvent和onTouchEvent方法，所有的触摸事件都是通过dispatchTouchEvent方法来分发的，onTouchEvent对应事件的消费，在MyTextView方法中加上这两个方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean dispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    switch (event.getAction())&#123;</div><div class="line">        case MotionEvent.ACTION_DOWN:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView dispatchTouchEvent ACTION_DOWN&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_MOVE:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView dispatchTouchEvent ACTION_MOVE&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_UP:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView dispatchTouchEvent ACTION_UP&quot;);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return super.dispatchTouchEvent(event);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">    switch (event.getAction())&#123;</div><div class="line">        case MotionEvent.ACTION_DOWN:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView onTouchEvent: ACTION_DOWN&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_MOVE:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView onTouchEvent: ACTION_MOVE&quot;);</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_UP:</div><div class="line">            Log.d(&quot;hcy&quot;, &quot;MyTextView onTouchEvent: ACTION_UP&quot;);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return super.onTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把MainActivity中onTouch的返回值改回默认的false，运行程序，点击MyTextView，打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">03-01 00:27:45.802 12338 12338 D hcy     : MyTextView dispatchTouchEvent ACTION_DOWN</div><div class="line">03-01 00:27:45.803 12338 12338 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:27:45.803 12338 12338 D hcy     : MyTextView onTouchEvent: ACTION_DOWN</div><div class="line">03-01 00:27:45.833 12338 12338 D hcy     : MyTextView dispatchTouchEvent ACTION_UP</div><div class="line">03-01 00:27:45.833 12338 12338 D hcy     : MyTextView onTouch ACTION_UP</div><div class="line">03-01 00:27:45.833 12338 12338 D hcy     : MyTextView onTouchEvent: ACTION_UP</div><div class="line">03-01 00:27:45.838 12338 12338 D hcy     : MyTextView onClick</div></pre></td></tr></table></figure>
<p>发现onClick的地位更低了，前面方法执行了一圈才轮到它。<br>把MainActivity中onTouch的返回值改成true，运行程序，点击MyTextView，打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">03-01 00:03:34.836 10473 10473 D hcy     : MyTextView dispatchTouchEvent ACTION_DOWN</div><div class="line">03-01 00:03:34.837 10473 10473 D hcy     : MyTextView onTouch ACTION_DOWN</div><div class="line">03-01 00:03:34.885 10473 10473 D hcy     : MyTextView dispatchTouchEvent ACTION_UP</div><div class="line">03-01 00:03:34.885 10473 10473 D hcy     : MyTextView onTouch ACTION_UP</div></pre></td></tr></table></figure>
<p>发现onTouchEvent和onClick都不执行了</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>既然对View所有的触摸事件都会通过dispatchTouchEvent分发，那就看下这个方法具体做了什么，查看View中该方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line"> * Pass the touch screen motion event down to the target view, or this</div><div class="line"> * view if it is the target.</div><div class="line"> *</div><div class="line"> * @param event The motion event to be dispatched.</div><div class="line"> * @return True if the event was handled by the view, false otherwise.</div><div class="line"> */</div><div class="line">public boolean dispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">    // If the event should be handled by accessibility focus first.</div><div class="line">    if (event.isTargetAccessibilityFocus()) &#123;</div><div class="line">        // We don&apos;t have focus or no virtual descendant has it, do not handle the event.</div><div class="line">        if (!isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        // We have focus and got the event, then use normal event dispatch.</div><div class="line">        event.setTargetAccessibilityFocus(false);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    boolean result = false;</div><div class="line"></div><div class="line">    if (mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onTouchEvent(event, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final int actionMasked = event.getActionMasked();</div><div class="line">    if (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        // Defensive cleanup for new gesture</div><div class="line">        stopNestedScroll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">        if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</div><div class="line">            result = true;</div><div class="line">        &#125;</div><div class="line">        //noinspection SimplifiableIfStatement</div><div class="line">        ListenerInfo li = mListenerInfo;</div><div class="line">        if (li != null &amp;&amp; li.mOnTouchListener != null</div><div class="line">                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">                &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</div><div class="line">            result = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">            result = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!result &amp;&amp; mInputEventConsistencyVerifier != null) &#123;</div><div class="line">        mInputEventConsistencyVerifier.onUnhandledEvent(event, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Clean up after nested scrolls if this is the end of a gesture;</div><div class="line">    // also cancel it if we tried an ACTION_DOWN but we didn&apos;t want the rest</div><div class="line">    // of the gesture.</div><div class="line">    if (actionMasked == MotionEvent.ACTION_UP ||</div><div class="line">            actionMasked == MotionEvent.ACTION_CANCEL ||</div><div class="line">            (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) &#123;</div><div class="line">        stopNestedScroll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注解的意思说明了该方法的作用：将触摸屏幕的事件分发给目标View，如果当前View是目标View就分发给当前View，若目标View处理了该事件则返回True，否则返回false。<br>挑重点看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">if (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">    if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</div><div class="line">        result = true;</div><div class="line">    &#125;</div><div class="line">    //noinspection SimplifiableIfStatement</div><div class="line">    ListenerInfo li = mListenerInfo;</div><div class="line">    if (li != null &amp;&amp; li.mOnTouchListener != null</div><div class="line">            &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">            &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</div><div class="line">        result = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">        result = true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先判断onFilterTouchEventForSecurity方法的返回值，查看该方法的注解，主要是判断当前View是否被遮挡，如果事件可以被分发则返回true，接着将mListenerInfo赋给ListenerInfo实例进入if判断语句，这里li不为null成立，li.mOnTouchListener不为null取决于我们是否给View设置了OnTouchListener监听，可以调用View中setOnTouchListener方法设置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void setOnTouchListener(OnTouchListener l) &#123;</div><div class="line">     getListenerInfo().mOnTouchListener = l;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>前面在MainActivity中调用了setOnTouchListener，因此成立，TextView默认是ENABLED，因此成立，取决于最后一个条件li.mOnTouchListener.onTouch(this, event)的返回值，这里的返回值就是MainActivity中onTouch的返回值，如果返回为true，那么result为true，下面的if判断不满足，因此onTouchEvent也不会执行，反之result值为false，onTouchEvent方法执行，之后再将result值赋为true。这就解释了上面onTouch返回true后onTouchEvent不执行的原因，那么onClick为啥也不执行呢，十有八九跟onTouchEvent有关，查看View中的onTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">  * Implement this method to handle touch screen motion events.</div><div class="line">  * &lt;p&gt;</div><div class="line">  * If this method is used to detect click actions, it is recommended that</div><div class="line">  * the actions be performed by implementing and calling</div><div class="line">  * &#123;@link #performClick()&#125;. This will ensure consistent system behavior,</div><div class="line">  * including:</div><div class="line">  * &lt;ul&gt;</div><div class="line">  * &lt;li&gt;obeying click sound preferences</div><div class="line">  * &lt;li&gt;dispatching OnClickListener calls</div><div class="line">  * &lt;li&gt;handling &#123;@link AccessibilityNodeInfo#ACTION_CLICK ACTION_CLICK&#125; when</div><div class="line">  * accessibility features are enabled</div><div class="line">  * &lt;/ul&gt;</div><div class="line">  *</div><div class="line">  * @param event The motion event.</div><div class="line">  * @return True if the event was handled, false otherwise.</div><div class="line">  */</div><div class="line"> public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">     final float x = event.getX();</div><div class="line">     final float y = event.getY();</div><div class="line">     final int viewFlags = mViewFlags;</div><div class="line">     final int action = event.getAction();</div><div class="line"></div><div class="line">     if ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">         if (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123;</div><div class="line">             setPressed(false);</div><div class="line">         &#125;</div><div class="line">         // A disabled view that is clickable still consumes the touch</div><div class="line">         // events, it just doesn&apos;t respond to them.</div><div class="line">         return (((viewFlags &amp; CLICKABLE) == CLICKABLE</div><div class="line">                 || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</div><div class="line">                 || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);</div><div class="line">     &#125;</div><div class="line">     if (mTouchDelegate != null) &#123;</div><div class="line">         if (mTouchDelegate.onTouchEvent(event)) &#123;</div><div class="line">             return true;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     if (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">             (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</div><div class="line">             (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</div><div class="line">         switch (action) &#123;</div><div class="line">             case MotionEvent.ACTION_UP:</div><div class="line">                 boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0;</div><div class="line">                 if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) &#123;</div><div class="line">                     // take focus if we don&apos;t have it already and we should in</div><div class="line">                     // touch mode.</div><div class="line">                     boolean focusTaken = false;</div><div class="line">                     if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) &#123;</div><div class="line">                         focusTaken = requestFocus();</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     if (prepressed) &#123;</div><div class="line">                         // The button is being released before we actually</div><div class="line">                         // showed it as pressed.  Make it show the pressed</div><div class="line">                         // state now (before scheduling the click) to ensure</div><div class="line">                         // the user sees it.</div><div class="line">                         setPressed(true, x, y);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                     if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) &#123;</div><div class="line">                         // This is a tap, so remove the longpress check</div><div class="line">                         removeLongPressCallback();</div><div class="line"></div><div class="line">                         // Only perform take click actions if we were in the pressed state</div><div class="line">                         if (!focusTaken) &#123;</div><div class="line">                             // Use a Runnable and post this rather than calling</div><div class="line">                             // performClick directly. This lets other visual state</div><div class="line">                             // of the view update before click actions start.</div><div class="line">                             if (mPerformClick == null) &#123;</div><div class="line">                                 mPerformClick = new PerformClick();</div><div class="line">                             &#125;</div><div class="line">                             if (!post(mPerformClick)) &#123;</div><div class="line">                                 performClick();</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     if (mUnsetPressedState == null) &#123;</div><div class="line">                         mUnsetPressedState = new UnsetPressedState();</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     if (prepressed) &#123;</div><div class="line">                         postDelayed(mUnsetPressedState,</div><div class="line">                                 ViewConfiguration.getPressedStateDuration());</div><div class="line">                     &#125; else if (!post(mUnsetPressedState)) &#123;</div><div class="line">                         // If the post failed, unpress right now</div><div class="line">                         mUnsetPressedState.run();</div><div class="line">                     &#125;</div><div class="line"></div><div class="line">                     removeTapCallback();</div><div class="line">                 &#125;</div><div class="line">                 mIgnoreNextUpEvent = false;</div><div class="line">                 break;</div><div class="line"></div><div class="line">             case MotionEvent.ACTION_DOWN:</div><div class="line">                 mHasPerformedLongPress = false;</div><div class="line"></div><div class="line">                 if (performButtonActionOnTouchDown(event)) &#123;</div><div class="line">                     break;</div><div class="line">                 &#125;</div><div class="line"></div><div class="line">                 // Walk up the hierarchy to determine if we&apos;re inside a scrolling container.</div><div class="line">                 boolean isInScrollingContainer = isInScrollingContainer();</div><div class="line"></div><div class="line">                 // For views inside a scrolling container, delay the pressed feedback for</div><div class="line">                 // a short period in case this is a scroll.</div><div class="line">                 if (isInScrollingContainer) &#123;</div><div class="line">                     mPrivateFlags |= PFLAG_PREPRESSED;</div><div class="line">                     if (mPendingCheckForTap == null) &#123;</div><div class="line">                         mPendingCheckForTap = new CheckForTap();</div><div class="line">                     &#125;</div><div class="line">                     mPendingCheckForTap.x = event.getX();</div><div class="line">                     mPendingCheckForTap.y = event.getY();</div><div class="line">                     postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout());</div><div class="line">                 &#125; else &#123;</div><div class="line">                     // Not inside a scrolling container, so show the feedback right away</div><div class="line">                     setPressed(true, x, y);</div><div class="line">                     checkForLongClick(0, x, y);</div><div class="line">                 &#125;</div><div class="line">                 break;</div><div class="line"></div><div class="line">             case MotionEvent.ACTION_CANCEL:</div><div class="line">                 setPressed(false);</div><div class="line">                 removeTapCallback();</div><div class="line">                 removeLongPressCallback();</div><div class="line">                 mInContextButtonPress = false;</div><div class="line">                 mHasPerformedLongPress = false;</div><div class="line">                 mIgnoreNextUpEvent = false;</div><div class="line">                 break;</div><div class="line"></div><div class="line">             case MotionEvent.ACTION_MOVE:</div><div class="line">                 drawableHotspotChanged(x, y);</div><div class="line"></div><div class="line">                 // Be lenient about moving outside of buttons</div><div class="line">                 if (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">                     // Outside button</div><div class="line">                     removeTapCallback();</div><div class="line">                     if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) &#123;</div><div class="line">                         // Remove any future long press/tap checks</div><div class="line">                         removeLongPressCallback();</div><div class="line"></div><div class="line">                         setPressed(false);</div><div class="line">                     &#125;</div><div class="line">                 &#125;</div><div class="line">                 break;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         return true;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     return false;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>代码有点长，先看注解，大概意思就是说可以实现这个方法去处理触摸事件，消费了事件返回true，否则返回false。并且如果要监测点击事件最好实现performClick方法，分析该方法。这里分为几种情况，首先判断viewFlags：<br>1.如果该控件是DISABLED且是CLICKABLE或者LONG_CLICKABLE中的一种，则返回true，同样消费掉该事件；<br>2.如果该控件是DISABLED且不是CLICKABLE或者LONG_CLICKABLE中的一种，那啥也别说了，下面一大段代码都跟它没关系，直接返回最后那个大大的false，不消费事件。<br>3.如果该控件是ENABLED且满足CLICKABLE或者LONG_CLICKABLE中的一种，就走下面的switch判断，也就是我们例子的情况，如果是这个情况，最后会return true，所以如果子类中默认调用super.onTouchEvent方法也是返回true。<br>事件都是从DOWN开始，MotionEvent.ACTION_DOWN中主要判断当前控件是否在可滚动的区域内，如果不在就设置点击为true，同时检查是否是长按，主要根据这里X，Y坐标轴判断。再看MotionEvent.ACTION_UP，在这里会判断是否之前是否按下过并且获取焦点，再创建一个mPerformClick的Runnable，通过post在UI线程中执行performClick()方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private final class PerformClick implements Runnable &#123;</div><div class="line">    @Override</div><div class="line">    public void run() &#123;</div><div class="line">        performClick();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>查看performClick()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public boolean performClick() &#123;</div><div class="line">    final boolean result;</div><div class="line">    final ListenerInfo li = mListenerInfo;</div><div class="line">    if (li != null &amp;&amp; li.mOnClickListener != null) &#123;</div><div class="line">        playSoundEffect(SoundEffectConstants.CLICK);</div><div class="line">        li.mOnClickListener.onClick(this);</div><div class="line">        result = true;</div><div class="line">    &#125; else &#123;</div><div class="line">        result = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED);</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法的返回值取决于中间那个if判断，首先li经过mListenerInfo赋值所以不为null成立，li.mOnClickListener != null取决于我们是否为控件设置了OnClickListener 监听，View提供了方法setOnClickListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public void setOnClickListener(@Nullable OnClickListener l) &#123;</div><div class="line">    if (!isClickable()) &#123;</div><div class="line">        setClickable(true);</div><div class="line">    &#125;</div><div class="line">    getListenerInfo().mOnClickListener = l;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在MainActivity中设置了监听，因此成立，所以会调用li.mOnClickListener.onClick(this)，即我们在MainActivity中实现的onClick方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>onTouch方法先于onClick方法执行，onClick方法是在onTouchEvent的UP事件触发的。</li>
<li>View的触摸事件会先调用dispatchTouchEvent方法分发事件，dispatchTouchEvent首先调用onTouch方法，如果onTouch返回true，onTouchEvent不执行，dispatchTouchEvent直接返回true；如果onTouch返回false，onTouchEvent执行，onClick方法执行，dispatchTouchEvent的返回值与onTouchEvent一致。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/03/30/Launcher3 M屏幕适配/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/30/Launcher3 M屏幕适配/" itemprop="url">Launcher3 M屏幕适配</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-30T00:00:00+08:00">
                2017-03-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/30/Launcher3 M屏幕适配/" class="leancloud_visitors" data-flag-title="Launcher3 M屏幕适配">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>安卓的碎片化非常严重，如果适配工作没做好的话，经常会出现这种情况，你写的APP在大屏的手机上显示正常，在小屏的手机上显示就不那么尽如人意了。Launcher3作为手机的门面，我们发现在不同屏幕大小的设备上，适配工作都做的挺好的，该文就探究下它是如何实现的。</p>
<h3 id="猜想"><a href="#猜想" class="headerlink" title="猜想"></a>猜想</h3><p>要适配不同大小的屏幕，屏幕的大小当然是设备自己最清楚了，因此设备把自身的屏幕宽高告诉给launcher，然后launcher再根据宽高再选择怎样的显示？</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>查看Launcher3的onCreate()方法，省略掉部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        ......</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        LauncherAppState.setApplicationContext(getApplicationContext());</div><div class="line">        LauncherAppState app = LauncherAppState.getInstance();</div><div class="line"></div><div class="line">        // Load configuration-specific DeviceProfile</div><div class="line">        mDeviceProfile = getResources().getConfiguration().orientation</div><div class="line">                == Configuration.ORIENTATION_LANDSCAPE ?</div><div class="line">                        app.getInvariantDeviceProfile().landscapeProfile</div><div class="line">                            : app.getInvariantDeviceProfile().portraitProfile;</div><div class="line">        ......</div><div class="line">        setContentView(R.layout.launcher);</div><div class="line"></div><div class="line">        setupViews();</div><div class="line">        mDeviceProfile.layout(this);</div><div class="line">        ......</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里看到在初始化的时候会判断当前屏幕是水平显示还是竖直显示，获得一个DeviceProfile实例，从名字看，这个就是我们寻觅已久的设备配置，先看下它是怎么实例化的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">代码路径：/packages/apps/Launcher3/src/com/android/launcher3/InvariantDeviceProfile.java</div><div class="line">    InvariantDeviceProfile(Context context) &#123;</div><div class="line">        ......</div><div class="line">        landscapeProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">                largeSide, smallSide, true /* isLandscape */);</div><div class="line">        portraitProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">                smallSide, largeSide, false /* isLandscape */);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>DeviceProfile的初始化是在InvariantDeviceProfile的构造函数中，这里注意第二个参数，传进去的就是InvariantDeviceProfile本身，继续查看DeviceProfile的构造函数我们可以发现配置里的很多值都是从InvariantDeviceProfile获取的，如图标大小，字体大小等，所以我们来看下这个InvariantDeviceProfile是个什么东东。</p>
<h3 id="InvariantDeviceProfile"><a href="#InvariantDeviceProfile" class="headerlink" title="InvariantDeviceProfile"></a>InvariantDeviceProfile</h3><p>从字面翻译上看，它表示不变的设备配置。啥意思？先看下它是怎样初始化的。在Launcher的onCreate中获取LauncherAppState 的时候做了一些初始化工作，其中就包括初始化InvariantDeviceProfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">代码路径：packages/apps/Launcher3/src/com/android/launcher3/LauncherAppState.java</div><div class="line">    private LauncherAppState() &#123;</div><div class="line">        .......</div><div class="line">        mInvariantDeviceProfile = new InvariantDeviceProfile(sContext);</div><div class="line">        .......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>再看下InvariantDeviceProfile的构造函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile(Context context) &#123;</div><div class="line">    mContext = context;</div><div class="line">    WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">    //获取设备默认的屏幕</div><div class="line">    Display display = wm.getDefaultDisplay();</div><div class="line">    DisplayMetrics dm = new DisplayMetrics();</div><div class="line">    display.getMetrics(dm);</div><div class="line"></div><div class="line">    Point smallestSize = new Point();</div><div class="line">    Point largestSize = new Point();</div><div class="line">    //确定屏幕的范围</div><div class="line">    display.getCurrentSizeRange(smallestSize, largestSize);</div><div class="line"></div><div class="line">    // This guarantees that width &lt; height</div><div class="line">    //获取最小的屏幕宽高值</div><div class="line">    minWidthDps = Utilities.dpiFromPx(Math.min(smallestSize.x, smallestSize.y), dm);</div><div class="line">    minHeightDps = Utilities.dpiFromPx(Math.min(largestSize.x, largestSize.y), dm);</div><div class="line"></div><div class="line">    //得到最接近的设置配置表集合</div><div class="line">    ArrayList&lt;InvariantDeviceProfile&gt; closestProfiles =</div><div class="line">            findClosestDeviceProfiles(minWidthDps, minHeightDps, getPredefinedDeviceProfiles());</div><div class="line">    InvariantDeviceProfile interpolatedDeviceProfileOut =</div><div class="line">            invDistWeightedInterpolate(minWidthDps,  minHeightDps, closestProfiles);</div><div class="line">    //获取设备列表集合中第一张表并对参数赋值</div><div class="line">    InvariantDeviceProfile closestProfile = closestProfiles.get(0);</div><div class="line">    numRows = closestProfile.numRows;</div><div class="line">    numColumns = closestProfile.numColumns;</div><div class="line">    numHotseatIcons = closestProfile.numHotseatIcons;</div><div class="line">    hotseatAllAppsRank = (int) (numHotseatIcons / 2);</div><div class="line">    defaultLayoutId = closestProfile.defaultLayoutId;</div><div class="line">    numFolderRows = closestProfile.numFolderRows;</div><div class="line">    numFolderColumns = closestProfile.numFolderColumns;</div><div class="line">    minAllAppsPredictionColumns = closestProfile.minAllAppsPredictionColumns;</div><div class="line"></div><div class="line">    iconSize = interpolatedDeviceProfileOut.iconSize;</div><div class="line">    iconBitmapSize = Utilities.pxFromDp(iconSize, dm);</div><div class="line">    iconTextSize = interpolatedDeviceProfileOut.iconTextSize;</div><div class="line"></div><div class="line">    fillResIconDpi = getLauncherIconDensity(iconBitmapSize);</div><div class="line"></div><div class="line">    // If the partner customization apk contains any grid overrides, apply them</div><div class="line">    // Supported overrides: numRows, numColumns, iconSize</div><div class="line">    applyPartnerDeviceProfileOverrides(context, dm);</div><div class="line"></div><div class="line">    Point realSize = new Point();</div><div class="line">    display.getRealSize(realSize);</div><div class="line">    // The real size never changes. smallSide and largeSide will remain the</div><div class="line">    // same in any orientation.</div><div class="line">    int smallSide = Math.min(realSize.x, realSize.y);</div><div class="line">    int largeSide = Math.max(realSize.x, realSize.y);</div><div class="line"></div><div class="line">    landscapeProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">            largeSide, smallSide, true /* isLandscape */);</div><div class="line">    portraitProfile = new DeviceProfile(context, this, smallestSize, largestSize,</div><div class="line">            smallSide, largeSide, false /* isLandscape */);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码中首先获取WindowManger服务，根据该服务获取最小屏幕宽高值，然后通过findClosestDeviceProfiles方法返回最接近的设备配置集合。findClosestDeviceProfiles()方法的第三个参数getPredefinedDeviceProfiles()如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">ArrayList&lt;InvariantDeviceProfile&gt; getPredefinedDeviceProfiles() &#123;</div><div class="line">    ArrayList&lt;InvariantDeviceProfile&gt; predefinedDeviceProfiles = new ArrayList&lt;&gt;();</div><div class="line">    // width, height, #rows, #columns, #folder rows, #folder columns,</div><div class="line">    // iconSize, iconTextSize, #hotseat, #hotseatIconSize, defaultLayoutId.</div><div class="line">    int fourByFourDefaultLayout = R.xml.default_workspace_4x4;</div><div class="line">    if (mContext.getResources().getBoolean(</div><div class="line">            R.bool.config_launcher_customWorkspace))&#123;</div><div class="line">        fourByFourDefaultLayout = R.xml.custom_workspace_4x4;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Super Short Stubby&quot;,</div><div class="line">            255, 300, 2, 3, 2, 3, 3, 48, 13, 3, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Shorter Stubby&quot;,</div><div class="line">            255, 400, 3, 3, 3, 3, 3, 48, 13, 3, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Short Stubby&quot;,</div><div class="line">            275, 420, 3, 4, 3, 4, 4, 48, 13, 5, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Stubby&quot;,</div><div class="line">            255, 450, 3, 4, 3, 4, 4, 48, 13, 5, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus S&quot;,</div><div class="line">            296, 491.33f, 4, 4, 4, 4, 4, 48, 13, 5, 48, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 4&quot;,</div><div class="line">            335, 567, 4, 4, 4, 4, 4, DEFAULT_ICON_SIZE_DP, 13, 5, 56, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 5&quot;,</div><div class="line">            359, 567, 4, 4, 4, 4, 4, DEFAULT_ICON_SIZE_DP, 13, 5, 56, fourByFourDefaultLayout));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Large Phone&quot;,</div><div class="line">            406, 694, 5, 5, 4, 4, 4, 64, 14.4f,  5, 56, R.xml.default_workspace_5x5));</div><div class="line">    // The tablet profile is odd in that the landscape orientation</div><div class="line">    // also includes the nav bar on the side</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 7&quot;,</div><div class="line">            575, 904, 5, 6, 4, 5, 4, 72, 14.4f,  7, 60, R.xml.default_workspace_5x6));</div><div class="line">    // Larger tablet profiles always have system bars on the top &amp; bottom</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;Nexus 10&quot;,</div><div class="line">            727, 1207, 5, 6, 4, 5, 4, 76, 14.4f,  7, 64, R.xml.default_workspace_5x6));</div><div class="line">    predefinedDeviceProfiles.add(new InvariantDeviceProfile(&quot;20-inch Tablet&quot;,</div><div class="line">            1527, 2527,7, 7, 6, 6, 4, 100, 20,  7, 72, fourByFourDefaultLayout));</div><div class="line"></div><div class="line">    return predefinedDeviceProfiles;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>市面上屏幕那么多，不可能雨露均沾，Google在这里预制一些主流的屏幕所对应的的launcher配置信息，以Nexus 5为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile(&quot;Nexus 5&quot;,</div><div class="line">                359, 567, 4, 4, 4, 4, 4, DEFAULT_ICON_SIZE_DP, 13, 5, 56, fourByFourDefaultLayout));</div></pre></td></tr></table></figure>
<p>参数依次代表的含义为：最小宽359，高567，桌面布局显示为4<em>4，文件夹中图标布局显示为4</em>4，桌面图标大小为DEFAULT_ICON_SIZE_DP(默认为60)，图标下的标题文本大小为13，dock栏图标数量为5，dock栏图标大小为56，默认加载的布局文件为fourByFourDefaultLayout。<br>findClosestDeviceProfiles()就是根据传的最小宽高值从launcher保存的这么多块屏幕中选择最接近的一块屏幕显示,代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Returns the closest device profiles ordered by closeness to the specified width and height</div><div class="line"> */</div><div class="line">// Package private visibility for testing.</div><div class="line">ArrayList&lt;InvariantDeviceProfile&gt; findClosestDeviceProfiles(</div><div class="line">        final float width, final float height, ArrayList&lt;InvariantDeviceProfile&gt; points) &#123;</div><div class="line"></div><div class="line">    // Sort the profiles by their closeness to the dimensions</div><div class="line">    ArrayList&lt;InvariantDeviceProfile&gt; pointsByNearness = points;</div><div class="line">    Collections.sort(pointsByNearness, new Comparator&lt;InvariantDeviceProfile&gt;() &#123;</div><div class="line">        public int compare(InvariantDeviceProfile a, InvariantDeviceProfile b) &#123;</div><div class="line">            return (int) (dist(width, height, a.minWidthDps, a.minHeightDps)</div><div class="line">                    - dist(width, height, b.minWidthDps, b.minHeightDps));</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return pointsByNearness;</div><div class="line">&#125;</div><div class="line">@Thunk float dist(float x0, float y0, float x1, float y1) &#123;</div><div class="line">    return (float) Math.hypot(x1 - x0, y1 - y0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把最小宽高值和预制的那些屏幕的最小宽高值做平方差计算，再把计算结果从小到大排序。<br>之后获取表中的第一张屏幕，然后就把该屏幕的配置赋值给当前的设备。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile closestProfile = closestProfiles.get(0);</div><div class="line">numRows = closestProfile.numRows;</div><div class="line">numColumns = closestProfile.numColumns;</div><div class="line">numHotseatIcons = closestProfile.numHotseatIcons;</div><div class="line">hotseatAllAppsRank = (int) (numHotseatIcons / 2);</div><div class="line">defaultLayoutId = closestProfile.defaultLayoutId;</div><div class="line">numFolderRows = closestProfile.numFolderRows;</div><div class="line">numFolderColumns = closestProfile.numFolderColumns;</div></pre></td></tr></table></figure>
<p>但是桌面的图标大小和标题大小以及dock栏的图标大小却是通过interpolatedDeviceProfileOut来获取的，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">iconSize = interpolatedDeviceProfileOut.iconSize;</div><div class="line">iconBitmapSize = Utilities.pxFromDp(iconSize, dm);</div><div class="line">iconTextSize = interpolatedDeviceProfileOut.iconTextSize;</div><div class="line">hotseatIconSize = interpolatedDeviceProfileOut.hotseatIconSize;</div></pre></td></tr></table></figure>
<p>interpolatedDeviceProfileOut的获取如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InvariantDeviceProfile interpolatedDeviceProfileOut =</div><div class="line">                invDistWeightedInterpolate(minWidthDps,  minHeightDps, closestProfiles);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">// Package private visibility for testing.</div><div class="line"> InvariantDeviceProfile invDistWeightedInterpolate(float width, float height,</div><div class="line">             ArrayList&lt;InvariantDeviceProfile&gt; points) &#123;</div><div class="line">     float weights = 0;</div><div class="line"></div><div class="line">     InvariantDeviceProfile p = points.get(0);</div><div class="line">     if (dist(width, height, p.minWidthDps, p.minHeightDps) == 0) &#123;</div><div class="line">         return p;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     InvariantDeviceProfile out = new InvariantDeviceProfile();</div><div class="line">     for (int i = 0; i &lt; points.size() &amp;&amp; i &lt; KNEARESTNEIGHBOR; ++i) &#123;</div><div class="line">         p = new InvariantDeviceProfile(points.get(i));</div><div class="line">         float w = weight(width, height, p.minWidthDps, p.minHeightDps, WEIGHT_POWER);</div><div class="line">         weights += w;</div><div class="line">         out.add(p.multiply(w));</div><div class="line">     &#125;</div><div class="line">     return out.multiply(1.0f/weights);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>如果设置配置集合中的第一张表刚刚好，dist(width, height, p.minWidthDps, p.minHeightDps) == 0；那就说明正好是我们找的那块屏幕，如果不是，launcher会遍历最接近的三块(KNEARESTNEIGHBOR)配置,做加权运算，之后取平均值，目的也是为了达到最佳的显示效果。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>launcher适配不同屏幕的思路就是先保存市面上常见的屏幕尺寸，并指定了这些屏幕显示的方式，几行几列，图标文本大小等，再根据当前设备的宽高选择最合适的一块屏幕。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/03/29/Java单例模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/29/Java单例模式/" itemprop="url">Java单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-29T00:00:00+08:00">
                2017-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/03/29/Java单例模式/" class="leancloud_visitors" data-flag-title="Java单例模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>一个类只有一个实例，自行实例化并提供给整个系统。</p>
<h3 id="基本思路"><a href="#基本思路" class="headerlink" title="基本思路"></a>基本思路</h3><p>将该类构造函数私有化，并通过静态方法获取一个唯一实例，获取过程保证线程安全。</p>
<h3 id="懒汉式线程不安全写法"><a href="#懒汉式线程不安全写法" class="headerlink" title="懒汉式线程不安全写法"></a>懒汉式线程不安全写法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">    public static Singleton getInstance() &#123;</div><div class="line">     if (instance == null) &#123; //分水岭</div><div class="line">         instance = new Singleton();</div><div class="line">     &#125;</div><div class="line">     return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设有A、B线程同时调用getInstance方法，在分水岭同时执行完判断后，由于CPU时间片切换，假设A线程得到执行权，继续向下执行，实例化了对象，此时instance不为空，而B线程又做了实例化工作，就会导致实例不唯一。</p>
<h3 id="懒汉式线程安全"><a href="#懒汉式线程安全" class="headerlink" title="懒汉式线程安全"></a>懒汉式线程安全</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">   public static synchronized Singleton getInstance() &#123;</div><div class="line">    if (instance == null) &#123;</div><div class="line">        instance = new Singleton();</div><div class="line">    &#125;</div><div class="line">    return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在getInstance()方法前加上synchronized，使整个方法同步，就可以保证线程安全，避免多实例的问题，但是这样并不高效，因为在第一次调用过getInstance()方法后，instance不为空，之后再调用该方法都要走同步，这样会消耗不必要的资源。</p>
<h3 id="Double-Check-Lock-双重检验锁"><a href="#Double-Check-Lock-双重检验锁" class="headerlink" title="Double Check Lock(双重检验锁)"></a>Double Check Lock(双重检验锁)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    if (instance == null) &#123;                         //Single Checked</div><div class="line">        synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                 //Double Checked</div><div class="line">                instance = new Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里为啥要做两次检验呢？我们先来看下，如果去掉第一层检验会怎样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                 </div><div class="line">                instance = new Singleton();</div><div class="line">            &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>当有两个线程同时调用getSingleton()方法时，由于同步机制的存在，假设此时A线程得到CPU的执行权，走到同步块中执行，执行了instance = new Singleton()后，退出同步语句块，此时instance已经不为null了，这时候B线程获得CPU执行权也进入同步块，就会被instance == null的判断挡在外面了。<br>所以就算不要第一层检验也是可以实现多线程安全的单例，那为毛还要写？原来这里涉及到性能问题，上面懒汉式线程安全的写法也是安全的，但是每次调用都要走同步会影响性能，这里也一样。我们希望这里的new Singleton()只执行一次，如果少了第一层的判断，每次有线程进入 getInstance()时，均会执行锁定操作来实现线程同步，这是非常耗费性能的，而多了第一层检验，只有第一次instance == null会执行锁定操作，之后的调用直接return instance就行。<br>再看如果少了第二层检验，其实这就跟第一种懒汉式线程不安全写法一样，在多线程并发的情况下不能达到保持单例的效果。<br>那么双重检验机制是否就能完美解决问题？其实不然，其原因在于instance = new Singleton();这句并非是个原子操作，当JVM运行到这一句是，分别作了如下操作<br>1.在堆中为 instance 分配内存<br>2.调用 Singleton的构造函数初始化成员变量<br>3.将instance对象指向分配的内存空间（执行完这步 instance 就为非 null 了）<br>如果上面的操作按1-2-3顺序执行，那就没啥问题，但是由于JVM的即时编译器中存在指令重排序的优化，上面的操作有可能是1-3-2。这会出现啥情况？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    if (instance == null) &#123;        //p2                 </div><div class="line">        synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                </div><div class="line">                instance = new Singleton(); //p1</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>假设线程A此时走到p1处，JVM按照1-3-2的顺序实例化instance,才执行完1-3，来不及执行2，线程B获得了CPU执行权也调用了getInstance()方法，并走到p2处，此时instance不为null,线程B就屁颠屁颠拿着得到的实例回去干活了，但是里头的成员变量还没初始化，这就尴尬了，报错也就理所当然了。</p>
<p>要解决这问题只要把instance设置成volatile，禁止重排序优化，以上面的例子，不管是1-2-3还是1-3-2，读取必须在操作完全执行完后才能进行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private volatile static Singleton instance;</div><div class="line">    private Singleton ()&#123;&#125;</div><div class="line"></div><div class="line">public static Singleton getSingleton() &#123;</div><div class="line">    if (instance == null) &#123;                         //Single Checked</div><div class="line">        synchronized (Singleton.class) &#123;</div><div class="line">            if (instance == null) &#123;                 //Double Checked</div><div class="line">                instance = new Singleton();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return instance ;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然而在Java5以前的版本使用volatile还是有问题，也不能完全避免重排序。</p>
<h3 id="恶汉式"><a href="#恶汉式" class="headerlink" title="恶汉式"></a>恶汉式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Singleton&#123;</div><div class="line">    private static final Singleton instance = new Singleton();</div><div class="line">    private Singleton()&#123;&#125;</div><div class="line"></div><div class="line">    public static Singleton getInstance()&#123;</div><div class="line">        return instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于instance被static和final修饰，在该类第一次被加载到内存中时就会对instance实例化，这样保证了单例。缺点是就算其他地方没有调用getInstance()方法，也会创建实例。</p>
<h3 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;  </div><div class="line">    private static class SingletonHolder &#123;  </div><div class="line">        private static final Singleton INSTANCE = new Singleton();  </div><div class="line">    &#125;  </div><div class="line">    private Singleton ()&#123;&#125;  </div><div class="line">    public static final Singleton getInstance() &#123;  </div><div class="line">        return SingletonHolder.INSTANCE; </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>静态内部类就比较好的弥补了恶汉式单例不足，也是比较推崇的写法。</p>
<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public enum EnumSingleton&#123;</div><div class="line">    INSTANCE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建枚举默认就是线程安全的，所以不需要担心线程同步，而且还能防止反序列化导致重新创建新的对象。通过EnumSingleton.INSTANCE来访问实例，只是平时很少看到代码中有人这么写。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg"
              alt="HuYounger" />
          
            <p class="site-author-name" itemprop="name">HuYounger</p>
            <p class="site-description motion-element" itemprop="description">Less is more</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Rkhcy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuYounger</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("rcy0CA7vKecGb0eQxcnHdO3i-gzGzoHsz", "N9PBf4dqgEeMJL7klXsAli0a");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
