<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="Less is more">
<meta property="og:type" content="website">
<meta property="og:title" content="HuYounger&#39;s Note">
<meta property="og:url" content="http://rkhcy.github.io/index.html">
<meta property="og:site_name" content="HuYounger&#39;s Note">
<meta property="og:description" content="Less is more">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HuYounger&#39;s Note">
<meta name="twitter:description" content="Less is more">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rkhcy.github.io/"/>





  <title>HuYounger's Note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuYounger's Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/09/27/TransitionNote2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/27/TransitionNote2/" itemprop="url">Transition学习笔记2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-27T00:00:00+08:00">
                2017-09-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/27/TransitionNote2/" class="leancloud_visitors" data-flag-title="Transition学习笔记2">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在<a href="http://rkhcy.github.io/2017/09/21/TransitionNote/">上篇</a>笔记中对于Transition的框架和常用的API使用进行了分析，Transition最常用的是在界面过渡方面，本文继续学习Transition在界面过渡上的使用。在界面过渡上，Transition分为不带共享元素的Content Transition和带共享元素的ShareElement Transition。</p>
<h3 id="Content-Transition"><a href="#Content-Transition" class="headerlink" title="Content Transition"></a>Content Transition</h3><p>先看下content transition的一个例子，在Google Play Games上的应用：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition2_1.gif" style="zoom:75%"></p>
<p>在经过学习后我们也可以设计出类似的效果，首先需要了解在界面过渡中涉及到的一些重要方法，从ActivtyA调用startActivity方法唤起ActivityB，到ActivityB按返回键返回ActivityA涉及到与Transition有关的方法</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition_A_to_B.png"></p>
<ul>
<li>ActivityA.exitTransition()</li>
<li>ActivityB.enterTransition()</li>
</ul>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition_B_to_A.png"></p>
<ul>
<li>ActivityB.returnTransition()</li>
<li>ActivityA.reenterTransition()</li>
</ul>
<p>因此，只要我们在对应的方法中设置了Transition就可以了。在默认没有设置对应Transition的情况下，Material-theme应用的exitTransition为null，enterTransition为Fade，如果reenterTransition和returnTransition未设定，则分别对应exitTransition和enterTransition。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>在style中添加<code>android:windowContentTransitions</code> 属性启用窗口内容转换(Material-theme应用默认为true)，指定该Activity的Transition</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Base application theme. --&gt;</div><div class="line">&lt;style name=&quot;AppTheme&quot; parent=&quot;Theme.AppCompat.Light.DarkActionBar&quot;&gt;</div><div class="line">    &lt;!-- enable window content transitions --&gt;</div><div class="line">    &lt;item name=&quot;android:windowContentTransitions&quot;&gt;true&lt;/item&gt;</div><div class="line"></div><div class="line">    &lt;!-- specify enter and exit transitions --&gt;</div><div class="line">    &lt;!-- options are: explode, slide, fade --&gt;</div><div class="line">    &lt;item name=&quot;android:windowEnterTransition&quot;&gt;@transition/change_image_transform&lt;/item&gt;</div><div class="line">    &lt;item name=&quot;android:windowExitTransition&quot;&gt;@transition/change_image_transform&lt;/item&gt;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure>
<p>也可以在代码中指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// inside your activity (if you did not enable transitions in your theme)</div><div class="line">getWindow().requestFeature(Window.FEATURE_CONTENT_TRANSITIONS);</div><div class="line">// set an enter transition</div><div class="line">getWindow().setEnterTransition(new Explode());</div><div class="line">// set an exit transition</div><div class="line">getWindow().setExitTransition(new Explode());</div></pre></td></tr></table></figure>
<p>然后启动Acticity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">startActivity(intent,</div><div class="line">              ActivityOptions.makeSceneTransitionAnimation(this).toBundle());</div></pre></td></tr></table></figure>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>这里在代码中指定ActivityA的exitTransition:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private void setupTransition() &#123;</div><div class="line">        Slide slide = new Slide(Gravity.LEFT);</div><div class="line">        slide.setDuration(1000);</div><div class="line">        slide.setInterpolator(new FastOutSlowInInterpolator());</div><div class="line">        getWindow().setExitTransition(slide);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>使用xml方式指定ActivityB的enterTransition：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;transitionSet xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</div><div class="line">    &lt;slide</div><div class="line">        android:duration=&quot;1000&quot;</div><div class="line">        android:interpolator=&quot;@android:interpolator/fast_out_slow_in&quot;</div><div class="line">        android:slideEdge=&quot;bottom&quot;&gt;</div><div class="line">        &lt;targets&gt;</div><div class="line">            &lt;target android:targetId=&quot;@id/content_container&quot;/&gt;</div><div class="line">        &lt;/targets&gt;</div><div class="line">    &lt;/slide&gt;</div><div class="line">    &lt;slide</div><div class="line">        android:duration=&quot;1000&quot;</div><div class="line">        android:interpolator=&quot;@android:interpolator/fast_out_slow_in&quot;</div><div class="line">        android:slideEdge=&quot;top&quot;&gt;</div><div class="line">        &lt;targets&gt;</div><div class="line">            &lt;target android:targetId=&quot;@id/image_container&quot;/&gt;</div><div class="line">        &lt;/targets&gt;</div><div class="line">    &lt;/slide&gt;</div><div class="line">&lt;/transitionSet&gt;</div></pre></td></tr></table></figure>
<p>运行效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition2_3.gif" style="zoom:50%"></p>
<p>上图动画有两个问题:</p>
<p>1.ActivityA的exitTransition还没完全走完ActivityB的enterTransition就执行了，ActivityB的returnTransition还没完全走完ActivityA的reenterTransition就执行了；</p>
<p>2.状态栏和导航栏的动画不太协调;</p>
<p>问题1是因为默认情况下enter/return transition会比exit/reenter transition完全结束前稍微快一点运行，如果想让前者完全运行完后者再进来，可以在代码中调用<code>Window</code>的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">setWindowAllowEnterTransitionOverlap(false)</div><div class="line">setWindowAllowReturnTransitionOverlap(false)</div></pre></td></tr></table></figure>
<p>或者在xml中设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;item name=&quot;android:windowAllowEnterTransitionOverlap&quot;&gt;false&lt;/item&gt; </div><div class="line">&lt;item name=&quot;android:windowAllowReturnTransitionOverlap&quot;&gt;false&lt;/item&gt;</div></pre></td></tr></table></figure>
<p>运行如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition2_2.gif" style="zoom:50%"></p>
<p>再看下问题2，默认情况下状态栏和标题栏也会参与动画(如果有导航栏也会，测试机默认木有导航栏)，当我们把xxxoverlap属性设为false后就看得比较明显了，如果不想让它们参与动画通过<code>excludeTarget()</code>将其排除，在代码中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private void setupTransition() &#123;</div><div class="line">    Slide slide = new Slide(Gravity.LEFT);</div><div class="line">    slide.setDuration(1000);</div><div class="line">    slide.setInterpolator(new FastOutSlowInInterpolator());</div><div class="line">    slide.excludeTarget(android.R.id.statusBarBackground, true);</div><div class="line">    slide.excludeTarget(android.R.id.navigationBarBackground, true);</div><div class="line">    slide.excludeTarget(R.id.appbar,true);</div><div class="line">    getWindow().setExitTransition(slide);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>或者在xml中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;slide xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:slideEdge=&quot;left&quot;</div><div class="line">    android:interpolator=&quot;@android:interpolator/fast_out_slow_in&quot;</div><div class="line">    android:duration=&quot;1000&quot;&gt;</div><div class="line"></div><div class="line">    &lt;targets&gt;</div><div class="line">        &lt;!-- if using a custom Toolbar container, specify the ID of the AppBarLayout --&gt;</div><div class="line">        &lt;target android:excludeId=&quot;@id/appbar&quot; /&gt;</div><div class="line">        &lt;target android:excludeId=&quot;@android:id/statusBarBackground&quot;/&gt;</div><div class="line">        &lt;target android:excludeId=&quot;@android:id/navigationBarBackground&quot;/&gt;</div><div class="line">    &lt;/targets&gt;</div><div class="line"></div><div class="line">&lt;/slide&gt;</div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition2_4.gif" style="zoom:50%"></p>
<h4 id="具体流程"><a href="#具体流程" class="headerlink" title="具体流程"></a>具体流程</h4><p>ActivityA startActivity()<br>1.确定需要执行exit Transition的target View<br>2.Transition的captureStartValues()获取target View Visibility的值(此时为VISIBLE)<br>3.将target View Visibility的值设为INVISIBLE<br>4.Transition的captureEndValues()获取target View Visibility的值(此时为INVISIBLE)<br>5.Transition的createAnimator()根据前后Visibility的属性值变化创建动画</p>
<p>ActivityB Activity 开始<br>1.确定需要执行enter Transition的target View<br>2.Transition的captureStartValues()获取获取target View Visibility的，初始化为INVISIBLE<br>3.将target View Visibility的值设为VISIBLE<br>4.Transition的captureEndValues()获取target View Visibility的值(此时为VISIBLE)<br>5.Transition的createAnimator()根据前后Visibility的属性值变化创建动画</p>
<h3 id="ShareElement-Transition"><a href="#ShareElement-Transition" class="headerlink" title="ShareElement Transition"></a>ShareElement Transition</h3><p>shareElement Transition的例子</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition_app1.gif" style="zoom:75%"></p>
<p>shareElement Transition指的是共享元素从activity/fragment到其他activity/fragment时的动画</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/shared_element.png"></p>
<p>有了上面的分析看名字应该也猜得出方法对应的功能了，如果没有设置exit/enter shared element transitions，默认为 <a href="https://github.com/android/platform_frameworks_base/blob/lollipop-release/core/res/res/transition/move.xml" target="_blank" rel="external"><code>@android:transition/move</code></a>，上面的Content Transition是根据Visibility的变化创建动画，而shareElement Transition是根据大小，位置，和外观的变化创建动画，如chanageBounds、changeTransform、ChangeClipBounds、 ChangeImageTransform等，具体API使用和效果可以参考<a href="http://rkhcy.github.io/2017/09/21/TransitionNote/">上篇</a>。指定shareElement Transition可以通过代码形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">getWindow().setSharedElementEnterTransition();</div><div class="line">getWindow().setSharedElementExitTransition();</div><div class="line">getWindow().setSharedElementReturnTransition();</div><div class="line">getWindow().setSharedElementReenterTransition();</div></pre></td></tr></table></figure>
<p>也可以通过xml形式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Base application theme. --&gt;</div><div class="line">&lt;style name=&quot;AppTheme&quot; parent=&quot;Theme.AppCompat.Light.DarkActionBar&quot;&gt;</div><div class="line">    &lt;!-- specify shared element transitions --&gt;</div><div class="line">    &lt;item name=&quot;android:windowSharedElementEnterTransition&quot;&gt;</div><div class="line">      @transition/change_image_transform&lt;/item&gt;</div><div class="line">    &lt;item name=&quot;android:windowSharedElementExitTransition&quot;&gt;</div><div class="line">      @transition/change_image_transform&lt;/item&gt;</div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure>
<p>然后启动Acticity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Intent intent = new Intent(this, DetailsActivity.class);</div><div class="line">// Pass data object in the bundle and populate details activity.</div><div class="line">intent.putExtra(DetailsActivity.EXTRA_CONTACT, contact);</div><div class="line">ActivityOptionsCompat options = ActivityOptionsCompat.</div><div class="line">    makeSceneTransitionAnimation(this, (View)ivProfile, &quot;profile&quot;);</div><div class="line">startActivity(intent, options.toBundle());</div></pre></td></tr></table></figure>
<p>在布局文件中对于要共享的View添加<code>android:transitionName</code>且保持一致，如果要共享的View有点多，可以通过Pair，Pair&lt;View,String&gt; 存储着共享View和View的名称，使用如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Intent intent = new Intent(context, DetailsActivity.class);</div><div class="line">intent.putExtra(DetailsActivity.EXTRA_CONTACT, contact);</div><div class="line">Pair&lt;View, String&gt; p1 = Pair.create((View)ivProfile, &quot;profile&quot;);</div><div class="line">Pair&lt;View, String&gt; p2 = Pair.create(vPalette, &quot;palette&quot;);</div><div class="line">Pair&lt;View, String&gt; p3 = Pair.create((View)tvName, &quot;text&quot;);</div><div class="line">ActivityOptionsCompat options = ActivityOptionsCompat.</div><div class="line">    makeSceneTransitionAnimation(this, p1, p2, p3);</div><div class="line">startActivity(intent, options.toBundle());</div></pre></td></tr></table></figure>
<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><p>在ActivityB的theme中添加SharedElementEnterTransition </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;item name=&quot;android:windowSharedElementEnterTransition&quot;&gt;</div><div class="line">@transition/change_image_transform</div><div class="line">&lt;/item&gt;</div></pre></td></tr></table></figure>
<p>change_image_transform.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;transitionSet xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</div><div class="line">    &lt;changeBounds</div><div class="line">        android:duration=&quot;1000&quot;</div><div class="line">        android:interpolator=&quot;@android:interpolator/fast_out_slow_in&quot;/&gt;</div><div class="line">    &lt;changeImageTransform</div><div class="line">        android:duration=&quot;1000&quot;</div><div class="line">        android:interpolator=&quot;@android:interpolator/fast_out_slow_in&quot;/&gt;</div><div class="line">&lt;/transitionSet&gt;</div></pre></td></tr></table></figure>
<p>执行效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition2_6.gif" style="zoom:50%"></p>
<h4 id="具体流程-1"><a href="#具体流程-1" class="headerlink" title="具体流程"></a>具体流程</h4><p>从图上看，好像图片是从一个ActivityA”传递”到另一个ActivityB，实际上真正负责绘制都发生在ActivityB上：</p>
<p>1.ActivityA调用startActivity()后ActivityB处于透明状态</p>
<p>2.Transition收集ActivityA中共享View的初识状态，并传递给ActivityB</p>
<p>3.Transition收集ActivityB中共享View的最终状态</p>
<p>4.Transition根据状态改变创建动画</p>
<p>5.Transition隐藏ActivityA，随着ActivityB的共享View运动到指定位置，ActivityB的背景在ActivityA上淡入，并随着动画完成而完全可见。</p>
<p>我们可以通过修改Activity背景淡入淡出时间来验证，在ActivityB中加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getWindow().setTransitionBackgroundFadeDuration(2000);</div></pre></td></tr></table></figure>
<p>为了更直观，把ActivityA的exitTransition先注释掉，运行效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition2_7.gif" style="zoom:50%"></p>
<p>可以看到，ActivityB确实像盖在ActivityA上，这里用到了 <a href="https://developer.android.com/reference/android/view/ViewOverlay.html" target="_blank" rel="external">ViewOverlay</a>，原理简单来说就是在其他View上draw，共享View利用该技术可以实现画在其他View上。我们可以通过<code>Window</code>的<code>setSharedElementsUseOverlay(false)</code>来关闭该功能，不过这样一来会使最终结果和你预想的不一致，默认该值为true。</p>
<h4 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h4><p>上面分析Transition会获取共享视图前后的状态值来创建动画，如果我们的图片是网上下载的，那么很有可能图片的准确大小需要下载下来才能确定，Activity Transitions API提供了一对方法暂时推迟过渡，直到我们确切地知道共享元素已经被适当的渲染和放置。在onCreate中调用postponeEnterTransition()(API &gt;= 21)或者supportPostponeEnterTransition()（API &lt; 21）延迟过渡；当图片的状态确定后，调用startPostponedEnterTransition()（API &gt;= 21）或supportStartPostponedEnterTransition()（API &lt; 21）恢复过渡，常见处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// ... load remote image with Glide/Picasso here</div><div class="line"></div><div class="line">supportPostponeEnterTransition();</div><div class="line">ivBackdrop.getViewTreeObserver().addOnPreDrawListener(</div><div class="line">    new ViewTreeObserver.OnPreDrawListener() &#123;</div><div class="line">        @Override</div><div class="line">        public boolean onPreDraw() &#123;</div><div class="line">            ivBackdrop.getViewTreeObserver().removeOnPreDrawListener(this);</div><div class="line">            supportStartPostponedEnterTransition();</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<h3 id="Thanks-to"><a href="#Thanks-to" class="headerlink" title="Thanks to"></a>Thanks to</h3><ul>
<li><a href="https://github.com/lgvalle/Material-Animations" target="_blank" rel="external">Material-Animations</a></li>
<li><a href="http://www.androiddesignpatterns.com/2014/12/activity-fragment-transitions-in-android-lollipop-part1.html" target="_blank" rel="external">Getting Started with Activity &amp; Fragment Transitions (part 1-4)</a></li>
<li><a href="https://halfthought.wordpress.com/2014/12/08/what-are-all-these-dang-transitions/" target="_blank" rel="external">What are all these dang Transitions</a></li>
<li><a href="https://github.com/codepath/android_guides/wiki/Shared-Element-Activity-Transition" target="_blank" rel="external">Shared Element Activity Transition</a></li>
<li><a href="https://developer.android.com/training/material/animations.html#Transitions" target="_blank" rel="external">Define custom animations</a></li>
<li><a href="https://github.com/atoennis/Presentation-ContentTransition" target="_blank" rel="external">Presentation-ContentTransition</a></li>
</ul>
<p><a href="https://github.com/Rkhcy/TransitionNote2" target="_blank" rel="external">本文代码</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/09/21/TransitionNote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/21/TransitionNote/" itemprop="url">Transition学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-21T00:00:00+08:00">
                2017-09-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/21/TransitionNote/" class="leancloud_visitors" data-flag-title="Transition学习笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Android 4.4.2 (API level 19)引入Transition框架，之后很多APP上都使用该框架做出很酷炫的效果，如 Google Play Newsstand app</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition_app1.gif" style="zoom:75%"></p>
<p>还有github上很火的<a href="https://github.com/nickbutcher/plaid" target="_blank" rel="external">plaid</a></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/plaid_demo.gif" style="zoom:75%"></p>
<p>在app中适当得使用上Transition能带来较好的用户体验，<a href="https://www.youtube.com/watch?time_continue=1007&amp;v=S3H7nJ4QaD8" target="_blank" rel="external">视频</a>中介绍了该框架的基本使用以及其中核心的一些类和方法，只有学会这些基本的API才能在之后的Activity/Fragment过渡定制一些自己想要的效果。</p>
<p>先看官网的一张关系图</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transitions_1.0.png"></p>
<p>图中有三个核心的类，分别是Scene、Transition和TransitionManager，下面对这个三个核心类展开分析。</p>
<h3 id="Scene"><a href="#Scene" class="headerlink" title="Scene"></a>Scene</h3><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-21%20%E4%B8%8B%E5%8D%885.50.13.png"></p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/transitions_1.0.png" target="_blank" rel="external">Scene</a>场景，用于保存布局中所有View的属性值，创建Scene的方式可以通过getSceneForLayout方法</p>
<p>getSceneForLayout(ViewGroup sceneRoot, int layoutId, Context context)</p>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mScene0 = Scene.getSceneForLayout(mSceneRoot, R.layout.scene0, getContext());</div><div class="line">mScene1 = Scene.getSceneForLayout(mSceneRoot, R.layout.scene1, getContext());</div></pre></td></tr></table></figure>
<p>也可以直接new Scene(ViewGroup sceneRoot, View layout)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">View view0 = inflater.inflate(R.layout.scene0, container, false);</div><div class="line">View view1 = inflater.inflate(R.layout.scene1, container, false);</div><div class="line">mScene0 = new Scene(mSceneRoot, view0);</div><div class="line">mScene1 = new Scene(mSceneRoot, view1);</div></pre></td></tr></table></figure>
<p>两种方式都需要传SceneRoot，即该场景的根节点。</p>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transitions_1.2.png"></p>
<p><a href="https://developer.android.com/training/transitions/transitions.html" target="_blank" rel="external">Transition</a>过渡动画，前面创建了两个场景，分别保存了视图的一些属性，比如Visibility、position等，Transition就是对于这些属性值的改变定义过渡的效果。从上图可以看到系统内置了一些常用的Transition，Transition的创建可以通过加载xml，如：</p>
<p>res/transition/fade_transition.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;fade xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; /&gt;</div></pre></td></tr></table></figure>
<p>然后在代码中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Transition mFadeTransition =</div><div class="line">        TransitionInflater.from(this).</div><div class="line">        inflateTransition(R.transition.fade_transition);</div></pre></td></tr></table></figure>
<p>或者直接在代码中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Transition mFadeTransition = new Fade();</div></pre></td></tr></table></figure>
<h3 id="TransitionManager"><a href="#TransitionManager" class="headerlink" title="TransitionManager"></a>TransitionManager</h3><p><a href="https://developer.android.com/reference/android/support/transition/TransitionManager.html" target="_blank" rel="external">TransitionManeger</a>用于将Scene和Transition联系起来，它提供了一系列的方法如setTransition(Scene fromScene, Scene toScene, Transition transition)指明起始场景和结束场景、他们的过渡动画是什么，go(Scene scene, Transition transition)，到指定的场景所使用的过渡动画是什么，beginDelayedTransition(ViewGroup sceneRoot, Transition transition)，在当前场景到下一帧的过渡效果是什么。比如这里使用go()方法，效果:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.3.gif" style="zoom:50%"></p>
<p>注意这里两个Scene中红绿两个方块除了位置和大小不一样，id是一致的，transition记录下两个Scene前后属性值，根据属性值的改变执行过渡动画，默认情况下对SceneRoot下的所有View执行动画效果，我们可以通过Transition.addTarget和removeTarget方法选择性添加或移除执行动画的View。</p>
<h3 id="常用API"><a href="#常用API" class="headerlink" title="常用API"></a>常用API</h3><p>有时候我们只想改变当前已展示的视图层级中View的状态，可以通过beginDelayedTransition实现，下面列举系统内置的Transition的使用。</p>
<h4 id="AutoTransition"><a href="#AutoTransition" class="headerlink" title="AutoTransition"></a>AutoTransition</h4><p><a href="https://developer.android.com/reference/android/support/transition/AutoTransition.html" target="_blank" rel="external">AutoTransition</a>默认的动画效果，对应xml tag为<code>autoTransition</code></p>
<p>其实是以下几个动画组合顺序执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;transitionSet xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:transitionOrdering=&quot;sequential&quot;&gt;</div><div class="line">    &lt;fade android:fadingMode=&quot;fade_out&quot; /&gt;</div><div class="line">    &lt;changeBounds /&gt;</div><div class="line">    &lt;fade android:fadingMode=&quot;fade_in&quot; /&gt;</div><div class="line">&lt;/transitionSet&gt;</div></pre></td></tr></table></figure>
<p>在代码中使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new AutoTransition());</div><div class="line">        if (mTextView.getVisibility() != View.VISIBLE) &#123;</div><div class="line">            mTextView.setVisibility(View.VISIBLE);</div><div class="line">        &#125; else &#123;</div><div class="line">            mTextView.setVisibility(View.GONE);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.4.gif" style="zoom:50%"></p>
<h4 id="ChangeBounds"><a href="#ChangeBounds" class="headerlink" title="ChangeBounds"></a>ChangeBounds</h4><p><a href="https://developer.android.com/reference/android/support/transition/ChangeBounds.html" target="_blank" rel="external">ChangeBounds</a>对应xml tag为<code>changeBounds</code>，根据前后布局界限的变化执行动画</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new ChangeBounds());</div><div class="line">FrameLayout.LayoutParams lp = (FrameLayout.LayoutParams) mTarget.getLayoutParams();</div><div class="line">if ((lp.gravity &amp; Gravity.START) == Gravity.START) &#123;</div><div class="line">    lp.gravity = Gravity.BOTTOM | Gravity.END;</div><div class="line">&#125; else &#123;</div><div class="line">    lp.gravity = Gravity.TOP | Gravity.START;</div><div class="line">&#125;</div><div class="line">mTarget.setLayoutParams(lp);</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.6.gif" style="zoom:50%"></p>
<h4 id="ChangeClipBounds"><a href="#ChangeClipBounds" class="headerlink" title="ChangeClipBounds"></a>ChangeClipBounds</h4><p><a href="https://developer.android.com/reference/android/support/transition/ChangeClipBounds.html" target="_blank" rel="external">ChangeClipBounds</a>对应xml tag为<code>changeClipBounds</code>，作用对象：View的getClipBounds()值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Rect BOUNDS = new Rect(20, 20, 100, 100);</div><div class="line">TransitionManager.beginDelayedTransition(mRoot, new ChangeClipBounds());</div><div class="line">if (BOUNDS.equals(ViewCompat.getClipBounds(mImageView))) &#123;</div><div class="line">    ViewCompat.setClipBounds(mImageView, null);</div><div class="line">&#125; else &#123;</div><div class="line">    ViewCompat.setClipBounds(mImageView, BOUNDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.5.gif" style="zoom:50%"></p>
<h4 id="ChangeImageTransform"><a href="#ChangeImageTransform" class="headerlink" title="ChangeImageTransform"></a>ChangeImageTransform</h4><p>对应xml tag为<code>changeImageTransform</code>，作用对象：ImageView的matrix</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new ChangeImageTransform());</div><div class="line">mImageView.setScaleType(ImageView.ScaleType.XXX);</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.7.gif" style="zoom:50%"></p>
<h4 id="ChangeScroll"><a href="#ChangeScroll" class="headerlink" title="ChangeScroll"></a>ChangeScroll</h4><p>对应xml tag为<code>changeScroll</code>，作用对象：View的scroll属性值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new ChangeScroll());</div><div class="line">mTarget.scrollBy(-100, -100);</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.8.gif" style="zoom:50%"></p>
<h4 id="ChangeTransform"><a href="#ChangeTransform" class="headerlink" title="ChangeTransform"></a>ChangeTransform</h4><p>对应xml tag 为changeTransform，作用对象：View的scale和rotation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new ChangeTransform());</div><div class="line">if (mContainer2.getChildCount() &gt; 0) &#123;</div><div class="line">    mContainer2.removeAllViews();</div><div class="line">    showRedSquare(mContainer1);</div><div class="line">&#125; else &#123;</div><div class="line">    mContainer1.removeAllViews();</div><div class="line">    showRedSquare(mContainer2);</div><div class="line">    mContainer2.getChildAt(0).setRotation(45);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void showRedSquare(FrameLayout container) &#123;</div><div class="line">        final View view = LayoutInflater.from(getContext())</div><div class="line">                .inflate(R.layout.red_square, container, false);</div><div class="line">        container.addView(view);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.9.gif" style="zoom:50%"></p>
<h4 id="Explode"><a href="#Explode" class="headerlink" title="Explode"></a>Explode</h4><p>对应xml tag为<code>explode</code>，作用对象：View的Visibility</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new Explode());</div><div class="line">int vis = mViews.get(0).getVisibility() == View.VISIBLE ? View.GONE : View.VISIBLE;</div><div class="line">for (View view : mViews) &#123;</div><div class="line">    view.setVisibility(vis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_10.gif" style="zoom:50%"></p>
<h4 id="Fade"><a href="#Fade" class="headerlink" title="Fade"></a>Fade</h4><p>对应xml tag为<code>fade</code>，作用对象：View的Visibility</p>
<p>可以在初始化时指定IN或者OUT分别对应淡入和淡出，也可以通过fade.setMode方法设置，若不指定默认为淡入淡出效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new Fade());</div><div class="line">int vis = mViews.get(0).getVisibility() == View.VISIBLE ? View.GONE : View.VISIBLE;</div><div class="line">for (View view : mViews) &#123;</div><div class="line">    view.setVisibility(vis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.11.gif" style="zoom:50%"></p>
<h4 id="Slide"><a href="#Slide" class="headerlink" title="Slide"></a>Slide</h4><p>对应xml tag为<code>slide</code>，作用对象：View的Visibility</p>
<p>可以初始化时传入Gravity.XX，也可以通过slide.setSlideEdge方法设置，默认方向为Gravity.BOTTOM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TransitionManager.beginDelayedTransition(mRoot, new Slide());</div><div class="line">int vis = mViews.get(0).getVisibility() == View.VISIBLE ? View.GONE : View.VISIBLE;</div><div class="line">for (View view : mViews) &#123;</div><div class="line">    view.setVisibility(vis);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.12.gif" style="zoom:50%"></p>
<h4 id="TransitionSet"><a href="#TransitionSet" class="headerlink" title="TransitionSet"></a>TransitionSet</h4><p>对应xml tag为<code>transitionSet</code></p>
<p>可以在代码中创建transitionSet如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mTransition = new TransitionSet();</div><div class="line">mTransition.addTransition(new ChangeImageTransform());</div><div class="line">mTransition.addTransition(new ChangeTransform());</div><div class="line">TransitionManager.beginDelayedTransition(mOuterFrame, mTransition);</div><div class="line">        if (mInnerFrame.getChildCount() &gt; 0) &#123;</div><div class="line">            mInnerFrame.removeAllViews();</div><div class="line">            addImageView(mOuterFrame, ImageView.ScaleType.CENTER_CROP, mPhotoSize);</div><div class="line">        &#125; else &#123;</div><div class="line">            mOuterFrame.removeViewAt(1);</div><div class="line">            addImageView(mInnerFrame, ImageView.ScaleType.FIT_XY,</div><div class="line">                    FrameLayout.LayoutParams.MATCH_PARENT);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>也可以通过加载xml布局创建transitionSet：</p>
<p>xml布局长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;transitionSet xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:transitionOrdering=&quot;together&quot;&gt;</div><div class="line">    &lt;changeImageTransform/&gt;</div><div class="line">    &lt;changeTransform/&gt;</div><div class="line">&lt;/transitionSet&gt;</div></pre></td></tr></table></figure>
<p>通过transitionOrdering属性设置动画执行的顺序，together表示同时执行，sequential表示顺序执行，在代码中可以调用TransitionSet的setOrdering(int)方法，属性值传<a href="https://developer.android.com/reference/android/transition/TransitionSet.html#ORDERING_SEQUENTIAL" target="_blank" rel="external">ORDERING_SEQUENTIAL</a>或者<a href="https://developer.android.com/reference/android/transition/TransitionSet.html#ORDERING_TOGETHER" target="_blank" rel="external">ORDERING_TOGETHER</a></p>
<p>在代码中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mTransition = (TransitionSet) TransitionInflater.from(getContext()).inflateTransition(R.transition.transition);</div><div class="line">TransitionManager.beginDelayedTransition(mOuterFrame, mTransition);</div><div class="line">        if (mInnerFrame.getChildCount() &gt; 0) &#123;</div><div class="line">            mInnerFrame.removeAllViews();</div><div class="line">            addImageView(mOuterFrame, ImageView.ScaleType.CENTER_CROP, mPhotoSize);</div><div class="line">        &#125; else &#123;</div><div class="line">            mOuterFrame.removeViewAt(1);</div><div class="line">            addImageView(mInnerFrame, ImageView.ScaleType.FIT_XY,</div><div class="line">                    FrameLayout.LayoutParams.MATCH_PARENT);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>这里结合changeImageTransform和changeTransform，效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.13.gif" style="zoom:50%"></p>
<h4 id="PathMotion"><a href="#PathMotion" class="headerlink" title="PathMotion"></a>PathMotion</h4><p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_17.png" style="zoom:50%"></p>
<p>Transition的辅助工具，以path的方式指定过渡效果，两个具体实现类ArcMotion和PatternPathMotion，看下ArcMotion的效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mTransition = new AutoTransition();</div><div class="line">mTransition.setPathMotion(new ArcMotion());</div><div class="line">TransitionManager.beginDelayedTransition(mRoot, mTransition);</div><div class="line">        FrameLayout.LayoutParams lp = (FrameLayout.LayoutParams) mTarget.getLayoutParams();</div><div class="line">        if ((lp.gravity &amp; Gravity.START) == Gravity.START) &#123;</div><div class="line">            lp.gravity = Gravity.END | Gravity.BOTTOM;</div><div class="line">        &#125; else &#123;</div><div class="line">            lp.gravity = Gravity.START | Gravity.TOP;</div><div class="line">        &#125;</div><div class="line">        mTarget.setLayoutParams(lp);</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.14.gif" style="zoom:50%"></p>
<p>它的运动轨迹是条曲线，有兴趣的可以研究下它的实现算法，在源码中有个很萌的图如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-09-21%20%E4%B8%8B%E5%8D%8810.40.12.png" style="zoom:50%"></p>
<h4 id="自定义Transition"><a href="#自定义Transition" class="headerlink" title="自定义Transition"></a>自定义Transition</h4><p>除了系统内置的Transition，我们还可以自定义Transition效果，需要继承Transition</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class CustomTransition extends Transition &#123;</div><div class="line">    @Override</div><div class="line">    public void captureStartValues(TransitionValues values) &#123;&#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void captureEndValues(TransitionValues values) &#123;&#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Animator createAnimator(ViewGroup sceneRoot,</div><div class="line">                                   TransitionValues startValues,</div><div class="line">                                   TransitionValues endValues) &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其工作原理是在captureStartValues和captureEndValues中分别记录View的属性值，官网建议确保属性值不冲突，属性值的命名格式参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">package_name:transition_name:property_name</div></pre></td></tr></table></figure>
<p>在createAnimator中创建动画，对比属性值的改变执行动画效果，如自定义修改颜色动画效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_1.15.gif" style="zoom:50%"></p>
<p>在两个Scene中使用自定义过渡动画，效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/transition1_16.gif" style="zoom:50%"></p>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>1.Android 版本在4.0(API Level 14)到4.4.2(API Level 19)使用Android Support Library’s </p>
<p>2.对于 SurfaceView可能不起效果，因为SurfaceView的实例是在非UI线程更新的，因此会造成和其他视图动画不同步。</p>
<p>3.某些特定的转换类型在应用到TextureView时可能不会产生所需的动画效果。</p>
<p>4.继承自AdapterView的如ListView，与该框架不兼容。</p>
<p>5.不要对包含文本的视图的大小进行动画</p>
<h2 id="Thanks-to"><a href="#Thanks-to" class="headerlink" title="Thanks to"></a>Thanks to</h2><p><a href="https://github.com/android/platform_frameworks_support" target="_blank" rel="external">Google Demo</a></p>
<p><a href="https://github.com/Rkhcy/TransitionNote" target="_blank" rel="external">Github Demo传送门</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/09/18/TomatoView实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/18/TomatoView实现/" itemprop="url">TomatoView实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-18T00:00:00+08:00">
                2017-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/18/TomatoView实现/" class="leancloud_visitors" data-flag-title="TomatoView实现">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>最近跟着<a href="http://hencoder.com/" target="_blank" rel="external">扔物线</a>的自定义View教程重新复习了一波基础，但是API这种东西如果不用很容易就忘了，趁大脑还没触发GC之前，最好的记忆方式就是撸个Demo出来。iOS上有一款个人很喜欢的简约TODO应用叫极简待办，其中它的番茄时钟交互很适合用来练手。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>先看下iOS的效果图长啥样</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/tomato.gif" style="zoom:50%"></p>
<p>功能</p>
<ul>
<li>一个默认黑色的圆，一个灰色的圆，随着倒计时减少，灰色圆的弧度越来越大</li>
<li>手指在圆圈内滑动可以调整时间</li>
</ul>
<h2 id="心路历程"><a href="#心路历程" class="headerlink" title="心路历程"></a>心路历程</h2><p>一步步来，先画一个黑圆以及显示时间文本，传入一个时间值后，可以实现倒计时功能。实现倒计时需要用到CountDownTimer，因此只要在该类的onTick中不断重绘就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public void start()&#123;</div><div class="line">        new CountDownTimer(time * 1000 + 1000, 1000) &#123;</div><div class="line">            @Override</div><div class="line">            public void onTick(long millisUntilFinished) &#123;</div><div class="line">                time = (time * 1000 - 1000) / 1000;</div><div class="line">                textTime = time + &quot;&quot;;</div><div class="line">                invalidate();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public void onFinish() &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过setTime方法提前设置一分钟，运行后可以看到界面开始倒计时，</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/tomato2.gif" style="zoom:50%"></p>
<p>接着，开始倒计时后，画灰色的圆弧，这里需要用到动画ValueAnimator，通过ValueAnimator的getAnimatedValue()方法获取实时的动画值，计算灰色圆弧扫过的区域，修改start()方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public void start()&#123;</div><div class="line">    ValueAnimator valueAnimator = ValueAnimator.ofFloat(0, 1.0f);</div><div class="line">    valueAnimator.setDuration(time * 1000);</div><div class="line">    valueAnimator.setInterpolator(new LinearInterpolator());</div><div class="line">    valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() &#123;</div><div class="line">        @Override</div><div class="line">        public void onAnimationUpdate(ValueAnimator animation) &#123;</div><div class="line">            sweepVelocity = (float) animation.getAnimatedValue();</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    valueAnimator.start();</div><div class="line"></div><div class="line">    new CountDownTimer(time * 1000 + 1000, 1000) &#123;</div><div class="line">        @Override</div><div class="line">        public void onTick(long millisUntilFinished) &#123;</div><div class="line">            time = (time * 1000 - 1000) / 1000;</div><div class="line">            textTime = time + &quot;&quot;;</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onFinish() &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>onDraw中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mRectF.set(centerX - radius, centerY - radius, centerX + radius, centerY + radius);</div><div class="line">canvas.drawArc(mRectF, START_ANGLE, 360 * sweepVelocity, false, mPaint);</div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/tomato3.gif" style="zoom:50%"></p>
<p>时间显示的有点挫，格式化下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">private String formatCountdownTime(int countdownTime) &#123;</div><div class="line">    StringBuilder sb = new StringBuilder();</div><div class="line">    int minute = countdownTime / 60;</div><div class="line">    int second = countdownTime - 60 * minute;</div><div class="line">    if (minute &lt; 10) &#123;</div><div class="line">        sb.append(&quot;0&quot; + minute + &quot;:&quot;);</div><div class="line">    &#125; else &#123;</div><div class="line">        sb.append(minute + &quot;:&quot;);</div><div class="line">    &#125;</div><div class="line">    if (second &lt; 10) &#123;</div><div class="line">        sb.append(&quot;0&quot; + second);</div><div class="line">    &#125; else &#123;</div><div class="line">        sb.append(second);</div><div class="line">    &#125;</div><div class="line">    return sb.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/tomato4.gif" style="zoom:50%"></p>
<p>接下来就是实现上下滑动调整时间了，思路如下：</p>
<p>先确定一个最大值，这里取60分钟，我们可以获取到手指按下和滑动的坐标，如果这两个点的纵坐标差值刚好等于直径，那么显示的时间取最大值，其余的就在0-60的区间内，在滑动过程中执行重绘。</p>
<p>重写onTouchEvent方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public boolean onTouchEvent(MotionEvent event) &#123;</div><div class="line">    float x = event.getX();</div><div class="line">    float y = event.getY();</div><div class="line">    switch (event.getActionMasked()) &#123;</div><div class="line">        case MotionEvent.ACTION_DOWN:</div><div class="line">            touchX = x;</div><div class="line">            touchY = y;</div><div class="line">            break;</div><div class="line">        case MotionEvent.ACTION_MOVE:</div><div class="line">            offsetX = x - touchX;</div><div class="line">            offsetY = y - touchY;</div><div class="line">            time = (int) (offsetY / 2 / radius * MAX_TIME);</div><div class="line">            if (time &lt;= 0) &#123;</div><div class="line">                time = 0;</div><div class="line">            &#125;</div><div class="line">            textTime = formatTime(time);</div><div class="line">            countdownTime = time * 60;</div><div class="line">            invalidate();</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/tomato5.gif" style="zoom:50%"></p>
<p>时间是可以调整了，但是当前没有对滑动范围限制，看到最大时间超出60分钟，处理的思路很简单，就是判断点是否在圆内，那怎么判断触摸点是否在圆内呢？平面内两点间距离公式和半径比较即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private boolean isContained(float x, float y) &#123;</div><div class="line">    if (Math.sqrt((x - centerX) * (x - centerX) + (y - centerY) * (y - centerY)) &gt; radius) &#123;</div><div class="line">        return false;</div><div class="line">    &#125; else &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/tomato7.gif" style="zoom:50%"></p>
<p><a href="https://github.com/Rkhcy/TomatoClockView" target="_blank" rel="external">github传送门</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/09/12/ViewStub学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/12/ViewStub学习/" itemprop="url">ViewStub学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-12T00:00:00+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/09/12/ViewStub学习/" class="leancloud_visitors" data-flag-title="ViewStub学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>一提到ViewStub，可能很多人就会想到布局性能优化，那么它具体是怎么实现的呢？先看下<a href="https://developer.android.com/reference/android/view/ViewStub.html" target="_blank" rel="external">官方</a>的介绍</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub.png"></p>
<blockquote>
<p>A ViewStub is an invisible, zero-sized View that can be used to lazily inflate layout resources at runtime. When a ViewStub is made visible, or when inflate() is invoked, the layout resource is inflated. The ViewStub then replaces itself in its parent with the inflated View or Views. Therefore, the ViewStub exists in the view hierarchy until setVisibility(int) or inflate() is invoked. The inflated View is added to the ViewStub’s parent with the ViewStub’s layout parameters. Similarly, you can define/override the inflate View’s id by using the ViewStub’s inflatedId property</p>
</blockquote>
<p>翻译如下：</p>
<ul>
<li>ViewStub是个不可见的、大小为0的View，用于在运行过程中延迟加载布局。</li>
<li>当ViewStub被设置为可见或者inflate()方法被调用，该布局才会被加载，之后ViewStub自身会被所加载的布局替换掉，ViewStub就不再存在于视图层级中。</li>
<li>被加载布局会使用ViewStub的布局参数，我们可以定义或者重写被加载的布局id通过ViewStub的inflatedId属性。</li>
</ul>
<p>还是比较好理解的，官方比较推崇的用于获取加载的布局的写法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ViewStub stub = findViewById(R.id.stub);</div><div class="line">View inflated = stub.inflate();</div></pre></td></tr></table></figure>
<p>下面通过一个例子来验证上面这些概念。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends Activity &#123;</div><div class="line"></div><div class="line">    Button button;</div><div class="line">    ViewStub viewStub;</div><div class="line">    View inflateView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        button = (Button) findViewById(R.id.button);</div><div class="line">        viewStub = (ViewStub) findViewById(R.id.stub);</div><div class="line">        button.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                inflateView = viewStub.inflate();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>view_stub.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:orientation=&quot;vertical&quot; android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/imageView&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:background=&quot;@mipmap/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button2&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button1&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button3&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button2&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;</div><div class="line">    tools:context=&quot;com.example.huchengyang.viewstub.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;button1&quot; /&gt;</div><div class="line">    &lt;ViewStub</div><div class="line">        android:id=&quot;@+id/stub&quot;</div><div class="line">        android:inflatedId=&quot;@+id/subTree&quot;</div><div class="line">        android:layout=&quot;@layout/view_stub&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>代码很简单，运行效果如下：</p>
<p> <img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub1.png" style="zoom:25%"></p>
<p>通过Hierarchy View查看此时的布局层级如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub2.png" style="zoom:50%"></p>
<p>点击Button1后：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub3.png" style="zoom:25%"></p>
<p>Hierarchy View查看布局层级如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub4.png" style="zoom:50%"></p>
<p>根据布局层级的显示确实符合官网的描述，当调用inflate()方法后，在布局层级中ViewStub就被代替了。在接触ViewStub之前我一直有个疑问，要想控制布局显示与否，通过设置Visibility属性不就好了么？我们改下activity_main的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;</div><div class="line">    tools:context=&quot;com.example.huchengyang.viewstub.MainActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;button1&quot; /&gt;</div><div class="line">&lt;!--    &lt;ViewStub</div><div class="line">        android:id=&quot;@+id/stub&quot;</div><div class="line">        android:inflatedId=&quot;@+id/subTree&quot;</div><div class="line">        android:layout=&quot;@layout/view_stub&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot; /&gt;--&gt;</div><div class="line">    &lt;LinearLayout</div><div class="line">        android:id=&quot;@+id/linear&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:orientation=&quot;vertical&quot;</div><div class="line">        android:visibility=&quot;gone&quot;&gt;</div><div class="line"></div><div class="line">        &lt;ImageView</div><div class="line">            android:id=&quot;@+id/imageView&quot;</div><div class="line">            android:layout_width=&quot;wrap_content&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:background=&quot;@mipmap/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">        &lt;Button</div><div class="line">            android:id=&quot;@+id/button2&quot;</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;Button1&quot; /&gt;</div><div class="line"></div><div class="line">        &lt;Button</div><div class="line">            android:id=&quot;@+id/button3&quot;</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:text=&quot;Button2&quot; /&gt;</div><div class="line">    &lt;/LinearLayout&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>运行如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub1.png" style="zoom:25%"></p>
<p>再看下布局层级：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewStub5.png" style="zoom:50%"></p>
<p>View的visibility属性设置成gone虽然在界面上看不到，但是布局却已经被加载进去了，如果该布局内容很复杂，那么整体的布局性能就会下降，而使用ViewStub就能延迟加载，提高布局性能。</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p><a href="https://developer.android.com/training/improving-layouts/loading-ondemand.html#ViewStub" target="_blank" rel="external">官网</a>的提醒：</p>
<blockquote>
<p><strong>Note:</strong> One drawback of <code>ViewStub</code> is that it doesn’t currently support the <code>&lt;merge&gt;</code> tag in the layouts to be inflated.</p>
</blockquote>
<p>指出当前ViewStub不支持<merge>标签。修改下view_stub.xml</merge></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;merge&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:orientation=&quot;vertical&quot; android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line"></div><div class="line">    &lt;ImageView</div><div class="line">        android:id=&quot;@+id/imageView&quot;</div><div class="line">        android:layout_width=&quot;wrap_content&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:background=&quot;@mipmap/ic_launcher&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button2&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button1&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/button3&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;Button2&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div><div class="line">&lt;/merge&gt;</div></pre></td></tr></table></figure>
<p>点击button1后得到如下崩溃：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">FATAL EXCEPTION: main</div><div class="line">                    Process: com.example.huchengyang.viewstub, PID: 6174</div><div class="line">                    android.view.InflateException: Binary XML file line #2: &lt;merge /&gt; can be used only with a valid ViewGroup root and attachToRoot=true</div><div class="line">                    at android.view.LayoutInflater.inflate(LayoutInflater.java:539)</div><div class="line">                    at android.view.LayoutInflater.inflate(LayoutInflater.java:423)</div><div class="line">                    at android.view.ViewStub.inflate(ViewStub.java:259)</div><div class="line">                    at com.example.huchengyang.viewstub.MainActivity$1.onClick(MainActivity.java:23)</div><div class="line">                    at android.view.View.performClick(View.java:5198)</div><div class="line">                    at android.view.View$PerformClick.run(View.java:21147)</div><div class="line">                    at android.os.Handler.handleCallback(Handler.java:739)</div><div class="line">                    at android.os.Handler.dispatchMessage(Handler.java:95)</div><div class="line">                    at android.os.Looper.loop(Looper.java:148)</div><div class="line">                    at android.app.ActivityThread.main(ActivityThread.java:5417)</div><div class="line">                    at java.lang.reflect.Method.invoke(Native Method)</div><div class="line">                    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:726)</div><div class="line">                    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:616)</div></pre></td></tr></table></figure>
<p>可见，ViewStub确实不支持merge标签。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>前面说过通过setVisibility()和inflate()方法可以实现延迟加载，那么它具体是怎么实现的呢，有必要看下源码（以下代码分析基于android-25）。不看不知道，一看吓一跳！整个ViewStub的源码一共才321行，而且绿油油的注释就占了一半，所以我们完全可以自己撸一个XXXViewStub！</p>
<p>首先看下ViewStub的构造函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public ViewStub(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes) &#123;</div><div class="line">        super(context);</div><div class="line"></div><div class="line">        final TypedArray a = context.obtainStyledAttributes(attrs,</div><div class="line">                R.styleable.ViewStub, defStyleAttr, defStyleRes);</div><div class="line">        mInflatedId = a.getResourceId(R.styleable.ViewStub_inflatedId, NO_ID);</div><div class="line">        mLayoutResource = a.getResourceId(R.styleable.ViewStub_layout, 0);</div><div class="line">        mID = a.getResourceId(R.styleable.ViewStub_id, NO_ID);</div><div class="line">        a.recycle();</div><div class="line">        setVisibility(GONE);</div><div class="line">        setWillNotDraw(true);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到初始化的时候执行了setVisibility(GONE)，ViewStub重写了该方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * When visibility is set to &#123;@link #VISIBLE&#125; or &#123;@link #INVISIBLE&#125;,</div><div class="line"> * &#123;@link #inflate()&#125; is invoked and this StubbedView is replaced in its parent</div><div class="line"> * by the inflated layout resource. After that calls to this function are passed</div><div class="line"> * through to the inflated view.</div><div class="line"> *</div><div class="line"> * @param visibility One of &#123;@link #VISIBLE&#125;, &#123;@link #INVISIBLE&#125;, or &#123;@link #GONE&#125;.</div><div class="line"> *</div><div class="line"> * @see #inflate() </div><div class="line"> */</div><div class="line">@Override</div><div class="line">@android.view.RemotableViewMethod</div><div class="line">public void setVisibility(int visibility) &#123;</div><div class="line">    if (mInflatedViewRef != null) &#123;</div><div class="line">        View view = mInflatedViewRef.get();</div><div class="line">        if (view != null) &#123;</div><div class="line">            view.setVisibility(visibility);</div><div class="line">        &#125; else &#123;</div><div class="line">            throw new IllegalStateException(&quot;setVisibility called on un-referenced view&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        super.setVisibility(visibility);</div><div class="line">        if (visibility == VISIBLE || visibility == INVISIBLE) &#123;</div><div class="line">            inflate();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的mInflatedViewRef是个弱引用的View，它的初始化在inflate()中，所以当visibility为GONE时，调用View的setVisibility就结束了；当我们设置该属性为VISIBLE时，执行inflate()，看下该方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * Inflates the layout resource identified by &#123;@link #getLayoutResource()&#125;</div><div class="line"> * and replaces this StubbedView in its parent by the inflated layout resource.</div><div class="line"> *</div><div class="line"> * @return The inflated layout resource.</div><div class="line"> *</div><div class="line"> */</div><div class="line">public View inflate() &#123;</div><div class="line">    final ViewParent viewParent = getParent();</div><div class="line"></div><div class="line">    if (viewParent != null &amp;&amp; viewParent instanceof ViewGroup) &#123;</div><div class="line">        if (mLayoutResource != 0) &#123;</div><div class="line">            final ViewGroup parent = (ViewGroup) viewParent;</div><div class="line">            final LayoutInflater factory;</div><div class="line">            if (mInflater != null) &#123;</div><div class="line">                factory = mInflater;</div><div class="line">            &#125; else &#123;</div><div class="line">                factory = LayoutInflater.from(mContext);</div><div class="line">            &#125;</div><div class="line">            final View view = factory.inflate(mLayoutResource, parent,</div><div class="line">                    false);</div><div class="line"></div><div class="line">            if (mInflatedId != NO_ID) &#123;</div><div class="line">                view.setId(mInflatedId);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int index = parent.indexOfChild(this);</div><div class="line">            parent.removeViewInLayout(this);</div><div class="line"></div><div class="line">            final ViewGroup.LayoutParams layoutParams = getLayoutParams();</div><div class="line">            if (layoutParams != null) &#123;</div><div class="line">                parent.addView(view, index, layoutParams);</div><div class="line">            &#125; else &#123;</div><div class="line">                parent.addView(view, index);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mInflatedViewRef = new WeakReference&lt;View&gt;(view);</div><div class="line"></div><div class="line">            if (mInflateListener != null) &#123;</div><div class="line">                mInflateListener.onInflate(this, view);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return view;</div><div class="line">        &#125; else &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;ViewStub must have a valid layoutResource&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new IllegalStateException(&quot;ViewStub must have a non-null ViewGroup viewParent&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码也很好懂，首先获取ViewStub所在的父布局，父布局必须不为空且所要加载的布局是个ViewGroup类型才往下走，mLayoutResource就是我们在xml里指定的android:layout，如果没配置也会报错，这些都满足后就会通过LayoutInflater去加载布局，设置布局id，也就是我们在xml里指定的android:inflatedId，然后找到ViewStub，并把它从布局里删掉，再根据ViewStub的布局参数，将所以加载的布局加到父布局中，并且对弱引用初始化。因此，如果重复调用ViewStub的inflate()会报错，但是重复调用setVisibility()不会。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/08/23/Java适配器模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/23/Java适配器模式/" itemprop="url">Java适配器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-23T00:00:00+08:00">
                2017-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/08/23/Java适配器模式/" class="leancloud_visitors" data-flag-title="Java适配器模式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>维基百科上的描述：</p>
<blockquote>
<p>In software engineering, the adapter pattern is a software design pattern that allows the interface of an existing class to be used as another interface. It is often used to make existing classes work with others without modifying their source code.</p>
</blockquote>
<p>简单理解就是适配器模式可以将一个对象进行包装，使得该对象与其他类兼容。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>比如现实生活中如果想将存储卡上的一些资料传输到电脑中，需要用到和电脑端口兼容的适配器，读卡器就是适配器；再比如电源适配器，三角插头不能连接两脚插头，需要使用电源适配器，使其与两个插脚插座兼容。</p>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><p>有一个快艇接口<code>SpeedBoat</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 快艇</div><div class="line"> */</div><div class="line"></div><div class="line">public interface SpeedBoat &#123;</div><div class="line">    void speed();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有个船长，他只会开快艇</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 船长</div><div class="line"> */</div><div class="line"></div><div class="line">public class Captain implements SpeedBoat &#123;</div><div class="line">    SpeedBoat speedBoat;</div><div class="line"></div><div class="line">    public Captain(SpeedBoat speedBoat) &#123;</div><div class="line">        this.speedBoat = speedBoat;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void speed() &#123;</div><div class="line">        speedBoat.speed();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有一天船长惹事被人追着砍，准备跑路，刚好看到一艘国产快艇</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 国产快艇</div><div class="line"> */</div><div class="line"></div><div class="line">public class ChinaSpeedBoat implements SpeedBoat &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void speed() &#123;</div><div class="line">        System.out.println(&quot;船长开中国快艇&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>于是一顿操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Captain captain1 = new Captain(new ChinaSpeedBoat());</div><div class="line">        captain1.speed();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">打印：船长开中国快艇</div></pre></td></tr></table></figure>
<p>跑路成功没毛病，这天船长又惹事被人追着砍，准备跑路，结果附近只有一艘渔船</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> * 渔船</div><div class="line"> */</div><div class="line"></div><div class="line">public class FishingBoat &#123;</div><div class="line">    public void fishing() &#123;</div><div class="line">        System.out.print(&quot;船长开渔船&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了不被砍，船长可以管渔船叫爹(extends FishingBoat)，这样他就有开渔船的功能了，但是显然这很不符合逻辑，况且下次如果被砍的时候遇到的是冲锋艇或者航母，还是不能解决问题，因此需要创建一个适配器，让船长用开快艇的技能来开渔船</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by Robert on 2017/8/23.</div><div class="line"> */</div><div class="line"></div><div class="line">public class FinishingBoatAdapter implements SpeedBoat &#123;</div><div class="line">    private FishingBoat boat;</div><div class="line"></div><div class="line">    public FinishingBoatAdapter() &#123;</div><div class="line">        boat = new FishingBoat();</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public void speed() &#123;</div><div class="line">        boat.fishing();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一顿操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Captain captain2 = new Captain(new FinishingBoatAdapter());</div><div class="line">        captain2.speed();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">打印：船长开渔船</div></pre></td></tr></table></figure>
<p>不管下次遇到什么船，用适配器的方法都能跑路成功。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/07/07/PhysicsBasedAnimation学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/07/PhysicsBasedAnimation学习/" itemprop="url">PhysicsBasedAnimation学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-07T00:00:00+08:00">
                2017-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/07/07/PhysicsBasedAnimation学习/" class="leancloud_visitors" data-flag-title="PhysicsBasedAnimation学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Google I/O ‘17推出了许多新的特性，在动画这一块又有新的API供开发者使用，具体视频请见<a href="https://www.youtube.com/watch?v=BNcODK-Ju0g" target="_blank" rel="external">Android Animations Spring to Life (Google I/O ‘17)</a>，主要介绍了Physics-based Animations，在动画API中引入了<code>DynamicAnimation</code>，并介绍了它的两个子类<code>FlingAnimation</code>和<code>SpringAnimation</code>的使用，开发者可以使用新的API创建更加动态化的动画。</p>
<h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><p>Physics-based Animations，翻译过来就是基于物理的动画，<a href="https://developer.android.com/topic/libraries/support-library/preview/physics-based-animation.html" target="_blank" rel="external">官网</a>上有很详细的介绍，在日常生活中当一个事物发生变化的时候，物理性的过渡或者说符合自然性的过渡，更容易让我们感知察觉，同样，更自然、不间断、有良好发展趋势的动画会给我们带来更好的用户体验。Physics-based Animations是根据物理学的基本原理构建的动画，动画由力产生，当力趋于平衡时动画处于静止。让我们重新捡起高中半吊子水平的物理知识，比如给物体在某个方向上施加一个力，物体有了速度，会在该方向上运动，如果停止施力，最后物体会由于摩擦力的影响，速度逐渐减小，运动一段时间后处于静止状态。Physics-based Animations概括起来就是下面几点：</p>
<ul>
<li>动画由力驱动</li>
<li>力决定了动画的加速和减速</li>
<li>在每一帧中动画值和速度都会更新</li>
<li>当受力达到平衡时动画停止</li>
</ul>
<h2 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h2><p>使用Physics-based Animations api创建的动画可以追踪速度，在运动过程中动态地改变动画的目标值，正确规划路线，使动画看起来更加自然。看下两组动画</p>
<p>​    <img src="http://7xjvg5.com1.z0.glb.clouddn.com/targetchange_oa.gif" style="zoom:50%"></p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/targetchange_pba.gif" style="zoom:50%"></p>
<p>对比了两组动画的差别，图1动画无法追踪速度，在进行下一帧的时候它的速度几乎还是从0开始的，速度值突然的变化给用户不连贯的视觉体验。图2动画可以追踪速度，在第二阶段力的方向改变，导致原先的速度发生变化，图片看起来很自然地移动到新的位置</p>
<p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/oa_chart.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/oa_chart.png" alt="动画1的速度曲线图">动画1的速度曲线图</a><br><a href="http://7xjvg5.com1.z0.glb.clouddn.com/pba_chart.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/pba_chart.png" alt="动画2的速度曲线图">动画2的速度曲线图</a></p>
<h2 id="怎么用"><a href="#怎么用" class="headerlink" title="怎么用"></a>怎么用</h2><ul>
<li>Android Studio 3.0 Canary 4</li>
<li>在Android Studio的build.gradle中添加依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    ...</div><div class="line">    implementation &apos;com.android.support:support-dynamic-animation:26.0.0-beta2&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Fling-Animation"><a href="#Fling-Animation" class="headerlink" title="Fling Animation"></a>Fling Animation</h2><p>看下怎样创建FlingAnimation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ImageView img = root.findViewById(R.id.img_simple_fling);</div><div class="line">FlingAnimation flingAnimation = new FlingAnimation(img, DynamicAnimation.X);</div><div class="line">flingAnimation.setStartVelocity(500f);</div><div class="line">flingAnimation.setFriction(0.5f);</div><div class="line">flingAnimation.start();</div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/fling.gif" style="zoom:50%"></p>
<p>解释下上面的代码:<br>创建一个FlingAnimation实例，默认情况下该实例的初速度是0pixels/s，因此我们需要调用<code>setStartVelocity()</code>方法给它赋予一个大于0的初速度，否则它是不会动的；另外这里介绍下<code>Friction</code>，翻译过来就是摩擦力的意思，在现实生活中如果一个物体保持一个速度在无摩擦力的情况下会一直运动下去，这里也是(比如这里设置Fraction为0.01f，发现小球滚到屏幕外了)，我们需要给该实例设置一个摩擦系数，设置的值越大，说明摩擦力越大，动画越快停下来，默认该值为1；最后调用start()方法开始动画。</p>
<h2 id="Spring-Animation"><a href="#Spring-Animation" class="headerlink" title="Spring Animation"></a>Spring Animation</h2><p>看下怎样创建SpringAnimation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ImageView img = root.findViewById(R.id.img_simple_spring);</div><div class="line">SpringAnimation springAnimation = new SpringAnimation(img, DynamicAnimation.X);</div><div class="line">springAnimation.setStartVelocity(2000);</div><div class="line"></div><div class="line">SpringForce springForce = new SpringForce();   </div><div class="line">springForce.setDampingRatio(SpringForce.DAMPING_RATIO_HIGH_BOUNCY);</div><div class="line">springForce.setStiffness(SpringForce.STIFFNESS_LOW);</div><div class="line">springForce.setFinalPosition(img.getX());</div><div class="line"></div><div class="line">springAnimation.setSpring(springForce);</div><div class="line">springAnimation.start();</div></pre></td></tr></table></figure>
<p>效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/spring.gif" style="zoom:50%"></p>
<p>解释下上面的代码:<br>和FlingAnimation一样，创建完SpringAnimation后我们需要设置初速度，接着创建了一个<br><code>SpringForce</code>实例，并设置了<code>DampingRatio</code>(弹性阻尼)和<code>Stiffness</code>(生硬度)，<br><code>DampingRatio</code>可以理解成反弹次数，系统中有以下几个可选，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public static final float DAMPING_RATIO_HIGH_BOUNCY = 0.2F;</div><div class="line">public static final float DAMPING_RATIO_MEDIUM_BOUNCY = 0.5F;</div><div class="line">public static final float DAMPING_RATIO_LOW_BOUNCY = 0.75F;</div><div class="line">public static final float DAMPING_RATIO_NO_BOUNCY = 1.0F;</div></pre></td></tr></table></figure>
<p>默认设置为<code>DAMPING_RATIO_MEDIUM_BOUNCY</code>，在<a href="https://developer.android.com/topic/libraries/support-library/preview/spring-animation.html" target="_blank" rel="external">官网</a>上贴了四张很Q弹的图片，分别对应不同值的效果，该值越大，反弹次数越少，值为1时不反弹。<br><code>Stiffness</code>可以理解成要恢复成未拉伸状态所需的时间，系统中有以下几个可选，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public static final float STIFFNESS_HIGH = 10000.0F;</div><div class="line">public static final float STIFFNESS_MEDIUM = 1500.0F;</div><div class="line">public static final float STIFFNESS_LOW = 200.0F;</div><div class="line">public static final float STIFFNESS_VERY_LOW = 50.0F;</div></pre></td></tr></table></figure>
<p>默认设置为<code>STIFFNESS_MEDIUM</code>，在<a href="https://developer.android.com/topic/libraries/support-library/preview/spring-animation.html" target="_blank" rel="external">官网</a>同样贴了四张对应不同值得对比图，该值越大，恢复到之前状态的时间就越短。可以修改<code>DampingRatio</code>或<code>Stiffness</code>查看效果</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/physics2.gif" style="zoom:50%"></p>
<p>setFinalPosition()方法指定最后静止时的位置。</p>
<h2 id="创建自定义的动画属性"><a href="#创建自定义的动画属性" class="headerlink" title="创建自定义的动画属性"></a>创建自定义的动画属性</h2><p>SpringAniamtion和FlingAnimation的构造函数只能接收一个可动画属性参数，如<code>ALPHA</code>、<code>ROTATION</code>、<code>SCALE</code>等，如果要同时为多个属性生成动画，一种方法是创建多个对应类的实例，然后传入要改变的动画值，这种做法比较麻烦，我们可以创建一个新的属性，该属性封装了我们想改变的其他动画属性值，做法如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">FloatPropertyCompat&lt;View&gt; scale = </div><div class="line">        new FloatPropertyCompat&lt;View&gt;(&quot;scale&quot;) &#123;</div><div class="line">            @Override</div><div class="line">            public float getValue(View view) &#123;</div><div class="line">                // return the value of any one property</div><div class="line">                return view.getScaleX();</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            @Override</div><div class="line">            public void setValue(View view, float value) &#123;</div><div class="line">                // Apply the same value to two properties</div><div class="line">                view.setScaleX(value);</div><div class="line">                view.setScaleY(value);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>创建<code>FloatPropertyCompat</code>实例，在<code>setValue()</code>方法中更新要修改的动画属性，在<code>getValue()</code>方法中返回当前属性值，示例代码统一改变了<code>SCALE_X</code>和<code>SCALE_Y</code>属性，自定义属性创建好之后可以像其他动画属性一样使用它，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SpringAnimation stretchAnimation =</div><div class="line">            new SpringAnimation(emoji, scale);</div></pre></td></tr></table></figure>
<p>在创建使用自定义属性的动画时，最好也调用<code>setMinimumVisibleChange()</code>方法并传递一个有意义的值，以确保动画不会消耗太多的CPU性能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stretchAnimation.setMinimumVisibleChange(</div><div class="line">                DynamicAnimation.MIN_VISIBLE_CHANGE_SCALE);</div></pre></td></tr></table></figure>
<p>效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/stretch.gif" style="zoom:50%"></p>
<h2 id="动画监听"><a href="#动画监听" class="headerlink" title="动画监听"></a>动画监听</h2><p><code>DynamicAnimation</code>提供了两个动画监听器<code>OnAnimationUpdateListener</code>和 <code>OnAnimationEndListener</code>，从名字也可以猜到前者监听动画值改变，后者监听动画结束状态。添加动画变化监听需要调用<code>addUpdateListener()</code>方法，重写<code>onAnimationUpdate()</code>方法执行具体操作；添加动画结束监听需要调用<code>addEndListener()</code>方法，重写<code>onAnimationEnd()</code>方法执行具体操作；若要移除动画监听，则需要调用<code>removeUpdateListener()</code>和<code>removeEndListener()</code>。监听动画结束的使用场景:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// Change icon before animation starts</div><div class="line">emoji.setImageResource(</div><div class="line">        R.drawable.ic_sentiment_very_satisfied_black_56dp);</div><div class="line"> </div><div class="line">// Start animation</div><div class="line">springAnimation.start();</div><div class="line"> </div><div class="line">springAnimation.addEndListener(</div><div class="line">    new DynamicAnimation.OnAnimationEndListener() &#123;</div><div class="line">        @Override</div><div class="line">        public void onAnimationEnd(DynamicAnimation animation, </div><div class="line">                                boolean canceled,</div><div class="line">                                float value, float velocity) &#123;</div><div class="line">            // Change icon after animation ends</div><div class="line">            emoji.setImageResource(</div><div class="line">                    R.drawable.ic_sentiment_neutral_black_56dp);</div><div class="line">        &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当动画结束时变换表情，效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/bounce.gif" style="zoom:50%"></p>
<p>监听动画变化的使用场景:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">// Creating two views to demonstrate the registration of the update listener.</div><div class="line">final View view1 = findViewById(R.id.view1);</div><div class="line">final View view2 = findViewById(R.id.view2);</div><div class="line"></div><div class="line">// Setting up a spring animation to animate the view1 and view2 translationX and translationY properties</div><div class="line">final SpringAnimation anim1X = new SpringAnimation(view1,</div><div class="line">        DynamicAnimation.TRANSLATION_X);</div><div class="line">final SpringAnimation anim1Y = new SpringAnimation(view1,</div><div class="line">    DynamicAnimation.TRANSLATION_Y);</div><div class="line">final SpringAnimation anim2X = new SpringAnimation(view2,</div><div class="line">        DynamicAnimation.TRANSLATION_X);</div><div class="line">final SpringAnimation anim2Y = new SpringAnimation(view2,</div><div class="line">        DynamicAnimation.TRANSLATION_Y);</div><div class="line"></div><div class="line">// Registering the update listener</div><div class="line">anim1X.addUpdateListener(new DynamicAnimation.OnAnimationUpdateListener() &#123;</div><div class="line"></div><div class="line">// Overriding the method to notify view2 about the change in the view1’s property.</div><div class="line">    @Override</div><div class="line">    public void onAnimationUpdate(DynamicAnimation dynamicAnimation, float value,</div><div class="line">                                  float velocity) &#123;</div><div class="line">        anim2X.animateToFinalPosition(value);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">anim1Y.addUpdateListener(new DynamicAnimation.OnAnimationUpdateListener() &#123;</div><div class="line"></div><div class="line">  @Override</div><div class="line">    public void onAnimationUpdate(DynamicAnimation dynamicAnimation, float value,</div><div class="line">                                  float velocity) &#123;</div><div class="line">        anim2Y.animateToFinalPosition(value);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们可以结合<code>animateToFinalPosition()</code>方法实现链式弹力动画效果，即一个View的动画依赖于另一个，效果如下:</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/spring_chain.gif" style="zoom:50%"></p>
<h2 id="Thanks-to"><a href="#Thanks-to" class="headerlink" title="Thanks to"></a>Thanks to</h2><ul>
<li><a href="https://code.tutsplus.com/tutorials/adding-physics-based-animations-to-android-apps--cms-29053" target="_blank" rel="external">Adding Physics-Based Animations to Android Apps</a></li>
<li><a href="https://developer.android.com/topic/libraries/support-library/preview/physics-based-animation.html" target="_blank" rel="external">Physics-based Animations</a></li>
<li><a href="https://developer.android.com/topic/libraries/support-library/preview/spring-animation.html" target="_blank" rel="external">Spring Animation</a></li>
<li><a href="https://developer.android.com/topic/libraries/support-library/preview/fling-animation.html" target="_blank" rel="external">Fling Animation</a></li>
<li><a href="https://github.com/android/platform_frameworks_support/tree/master/samples/SupportAnimationDemos" target="_blank" rel="external">官方Demo</a></li>
</ul>
<p><a href="https://github.com/Rkhcy/PhysicsBasedAnimation/tree/master" target="_blank" rel="external">GitHub Demo传送门</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/31/Android View绘制源码分析--Draw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/31/Android View绘制源码分析--Draw/" itemprop="url">Android View绘制源码分析--Draw</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-31T00:00:00+08:00">
                2017-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/31/Android View绘制源码分析--Draw/" class="leancloud_visitors" data-flag-title="Android View绘制源码分析--Draw">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>上篇文章分析DecorView的绘制的layout流程，这篇文章继续分析DecorView绘制的第三个阶段，draw流程。</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>先看ViewRootImpl的performDraw方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void performDraw() &#123;</div><div class="line">        if (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final boolean fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">        mFullRedrawNeeded = false;</div><div class="line"></div><div class="line">        mIsDrawing = true;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;draw&quot;);</div><div class="line">        try &#123;</div><div class="line">            draw(fullRedrawNeeded);</div><div class="line">        &#125; finally &#123;</div><div class="line">            mIsDrawing = false;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // For whatever reason we didn&apos;t create a HardwareRenderer, end any</div><div class="line">        // hardware animations that are now dangling</div><div class="line">        if (mAttachInfo.mPendingAnimatingRenderNodes != null) &#123;</div><div class="line">            final int count = mAttachInfo.mPendingAnimatingRenderNodes.size();</div><div class="line">            for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">                mAttachInfo.mPendingAnimatingRenderNodes.get(i).endAllAnimators();</div><div class="line">            &#125;</div><div class="line">            mAttachInfo.mPendingAnimatingRenderNodes.clear();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (mReportNextDraw) &#123;</div><div class="line">            mReportNextDraw = false;</div><div class="line"></div><div class="line">            // if we&apos;re using multi-thread renderer, wait for the window frame draws</div><div class="line">            if (mWindowDrawCountDown != null) &#123;</div><div class="line">                try &#123;</div><div class="line">                    mWindowDrawCountDown.await();</div><div class="line">                &#125; catch (InterruptedException e) &#123;</div><div class="line">                    Log.e(mTag, &quot;Window redraw count down interruped!&quot;);</div><div class="line">                &#125;</div><div class="line">                mWindowDrawCountDown = null;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (mAttachInfo.mHardwareRenderer != null) &#123;</div><div class="line">                mAttachInfo.mHardwareRenderer.fence();</div><div class="line">                mAttachInfo.mHardwareRenderer.setStopped(mStopped);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (mSurfaceHolder != null &amp;&amp; mSurface.isValid()) &#123;</div><div class="line">                mSurfaceHolderCallback.surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">                SurfaceHolder.Callback callbacks[] = mSurfaceHolder.getCallbacks();</div><div class="line">                if (callbacks != null) &#123;</div><div class="line">                    for (SurfaceHolder.Callback c : callbacks) &#123;</div><div class="line">                        if (c instanceof SurfaceHolder.Callback2) &#123;</div><div class="line">                            ((SurfaceHolder.Callback2)c).surfaceRedrawNeeded(mSurfaceHolder);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            try &#123;</div><div class="line">                mWindowSession.finishDrawing(mWindow);</div><div class="line">            &#125; catch (RemoteException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在13行执行了draw方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void draw(boolean fullRedrawNeeded) &#123;</div><div class="line">        Surface surface = mSurface;</div><div class="line">        if (!surface.isValid()) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!sFirstDrawComplete) &#123;</div><div class="line">            synchronized (sFirstDrawHandlers) &#123;</div><div class="line">                sFirstDrawComplete = true;</div><div class="line">                final int count = sFirstDrawHandlers.size();</div><div class="line">                for (int i = 0; i&lt; count; i++) &#123;</div><div class="line">                    mHandler.post(sFirstDrawHandlers.get(i));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        scrollToRectOrFocus(null, false);</div><div class="line"></div><div class="line">        if (mAttachInfo.mViewScrollChanged) &#123;</div><div class="line">            mAttachInfo.mViewScrollChanged = false;</div><div class="line">            mAttachInfo.mTreeObserver.dispatchOnScrollChanged();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean animating = mScroller != null &amp;&amp; mScroller.computeScrollOffset();</div><div class="line">        final int curScrollY;</div><div class="line">        if (animating) &#123;</div><div class="line">            curScrollY = mScroller.getCurrY();</div><div class="line">        &#125; else &#123;</div><div class="line">            curScrollY = mScrollY;</div><div class="line">        &#125;</div><div class="line">        if (mCurScrollY != curScrollY) &#123;</div><div class="line">            mCurScrollY = curScrollY;</div><div class="line">            fullRedrawNeeded = true;</div><div class="line">            if (mView instanceof RootViewSurfaceTaker) &#123;</div><div class="line">                ((RootViewSurfaceTaker) mView).onRootViewScrollYChanged(mCurScrollY);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final float appScale = mAttachInfo.mApplicationScale;</div><div class="line">        final boolean scalingRequired = mAttachInfo.mScalingRequired;</div><div class="line"></div><div class="line">        int resizeAlpha = 0;</div><div class="line"></div><div class="line">        final Rect dirty = mDirty;</div><div class="line">        if (mSurfaceHolder != null) &#123;</div><div class="line">            // The app owns the surface, we won&apos;t draw.</div><div class="line">            dirty.setEmpty();</div><div class="line">            if (animating &amp;&amp; mScroller != null) &#123;</div><div class="line">                mScroller.abortAnimation();</div><div class="line">            &#125;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (fullRedrawNeeded) &#123;</div><div class="line">            mAttachInfo.mIgnoreDirtyState = true;</div><div class="line">            dirty.set(0, 0, (int) (mWidth * appScale + 0.5f), (int) (mHeight * appScale + 0.5f));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mAttachInfo.mTreeObserver.dispatchOnDraw();</div><div class="line"></div><div class="line">        int xOffset = -mCanvasOffsetX;</div><div class="line">        int yOffset = -mCanvasOffsetY + curScrollY;</div><div class="line">        final WindowManager.LayoutParams params = mWindowAttributes;</div><div class="line">        final Rect surfaceInsets = params != null ? params.surfaceInsets : null;</div><div class="line">        if (surfaceInsets != null) &#123;</div><div class="line">            xOffset -= surfaceInsets.left;</div><div class="line">            yOffset -= surfaceInsets.top;</div><div class="line"></div><div class="line">            // Offset dirty rect for surface insets.</div><div class="line">            dirty.offset(surfaceInsets.left, surfaceInsets.right);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean accessibilityFocusDirty = false;</div><div class="line">        final Drawable drawable = mAttachInfo.mAccessibilityFocusDrawable;</div><div class="line">        if (drawable != null) &#123;</div><div class="line">            final Rect bounds = mAttachInfo.mTmpInvalRect;</div><div class="line">            final boolean hasFocus = getAccessibilityFocusedRect(bounds);</div><div class="line">            if (!hasFocus) &#123;</div><div class="line">                bounds.setEmpty();</div><div class="line">            &#125;</div><div class="line">            if (!bounds.equals(drawable.getBounds())) &#123;</div><div class="line">                accessibilityFocusDirty = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mAttachInfo.mDrawingTime =</div><div class="line">                mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS;</div><div class="line"></div><div class="line">        if (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;</div><div class="line">            if (mAttachInfo.mHardwareRenderer != null &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) &#123;</div><div class="line">                // If accessibility focus moved, always invalidate the root.</div><div class="line">                boolean invalidateRoot = accessibilityFocusDirty || mInvalidateRootRequested;</div><div class="line">                mInvalidateRootRequested = false;</div><div class="line"></div><div class="line">                // Draw with hardware renderer.</div><div class="line">                mIsAnimating = false;</div><div class="line"></div><div class="line">                if (mHardwareYOffset != yOffset || mHardwareXOffset != xOffset) &#123;</div><div class="line">                    mHardwareYOffset = yOffset;</div><div class="line">                    mHardwareXOffset = xOffset;</div><div class="line">                    invalidateRoot = true;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (invalidateRoot) &#123;</div><div class="line">                    mAttachInfo.mHardwareRenderer.invalidateRoot();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                dirty.setEmpty();</div><div class="line"></div><div class="line">                // Stage the content drawn size now. It will be transferred to the renderer</div><div class="line">                // shortly before the draw commands get send to the renderer.</div><div class="line">                final boolean updated = updateContentDrawBounds();</div><div class="line"></div><div class="line">                if (mReportNextDraw) &#123;</div><div class="line">                    // report next draw overrides setStopped()</div><div class="line">                    // This value is re-sync&apos;d to the value of mStopped</div><div class="line">                    // in the handling of mReportNextDraw post-draw.</div><div class="line">                    mAttachInfo.mHardwareRenderer.setStopped(false);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (updated) &#123;</div><div class="line">                    requestDrawWindow();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, this);</div><div class="line">            &#125; else &#123;</div><div class="line">                // If we get here with a disabled &amp; requested hardware renderer, something went</div><div class="line">                // wrong (an invalidate posted right before we destroyed the hardware surface</div><div class="line">                // for instance) so we should just bail out. Locking the surface with software</div><div class="line">                // rendering at this point would lock it forever and prevent hardware renderer</div><div class="line">                // from doing its job when it comes back.</div><div class="line">                // Before we request a new frame we must however attempt to reinitiliaze the</div><div class="line">                // hardware renderer if it&apos;s in requested state. This would happen after an</div><div class="line">                // eglTerminate() for instance.</div><div class="line">                if (mAttachInfo.mHardwareRenderer != null &amp;&amp;</div><div class="line">                        !mAttachInfo.mHardwareRenderer.isEnabled() &amp;&amp;</div><div class="line">                        mAttachInfo.mHardwareRenderer.isRequested()) &#123;</div><div class="line"></div><div class="line">                    try &#123;</div><div class="line">                        mAttachInfo.mHardwareRenderer.initializeIfNeeded(</div><div class="line">                                mWidth, mHeight, mAttachInfo, mSurface, surfaceInsets);</div><div class="line">                    &#125; catch (OutOfResourcesException e) &#123;</div><div class="line">                        handleOutOfResourcesException(e);</div><div class="line">                        return;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    mFullRedrawNeeded = true;</div><div class="line">                    scheduleTraversals();</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line">                    return;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (animating) &#123;</div><div class="line">            mFullRedrawNeeded = true;</div><div class="line">            scheduleTraversals();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在153行执行了drawSoftware方法，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    /**</div><div class="line">     * @return true if drawing was successful, false if an error occurred</div><div class="line">     */</div><div class="line">    private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff,</div><div class="line">            boolean scalingRequired, Rect dirty) &#123;</div><div class="line"></div><div class="line">        // Draw with software renderer.</div><div class="line">        final Canvas canvas;</div><div class="line">        try &#123;</div><div class="line">            final int left = dirty.left;</div><div class="line">            final int top = dirty.top;</div><div class="line">            final int right = dirty.right;</div><div class="line">            final int bottom = dirty.bottom;</div><div class="line">            //获取canvas</div><div class="line">            canvas = mSurface.lockCanvas(dirty);</div><div class="line"></div><div class="line">            // The dirty rectangle can be modified by Surface.lockCanvas()</div><div class="line">            //noinspection ConstantConditions</div><div class="line">            if (left != dirty.left || top != dirty.top || right != dirty.right</div><div class="line">                    || bottom != dirty.bottom) &#123;</div><div class="line">                attachInfo.mIgnoreDirtyState = true;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // TODO: Do this in native</div><div class="line">            canvas.setDensity(mDensity);</div><div class="line">        &#125; catch (Surface.OutOfResourcesException e) &#123;</div><div class="line">            handleOutOfResourcesException(e);</div><div class="line">            return false;</div><div class="line">        &#125; catch (IllegalArgumentException e) &#123;</div><div class="line">            // Don&apos;t assume this is due to out of memory, it could be</div><div class="line">            // something else, and if it is something else then we could</div><div class="line">            // kill stuff (or ourself) for no reason.</div><div class="line">            mLayoutRequested = true;    // ask wm for a new surface next time.</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            // If this bitmap&apos;s format includes an alpha channel, we</div><div class="line">            // need to clear it before drawing so that the child will</div><div class="line">            // properly re-composite its drawing on a transparent</div><div class="line">            // background. This automatically respects the clip/dirty region</div><div class="line">            // or</div><div class="line">            // If we are applying an offset, we need to clear the area</div><div class="line">            // where the offset doesn&apos;t appear to avoid having garbage</div><div class="line">            // left in the blank areas.</div><div class="line">            if (!canvas.isOpaque() || yoff != 0 || xoff != 0) &#123;</div><div class="line">                canvas.drawColor(0, PorterDuff.Mode.CLEAR);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dirty.setEmpty();</div><div class="line">            mIsAnimating = false;</div><div class="line">            mView.mPrivateFlags |= View.PFLAG_DRAWN;</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                canvas.translate(-xoff, -yoff);</div><div class="line">                if (mTranslator != null) &#123;</div><div class="line">                    mTranslator.translateCanvas(canvas);</div><div class="line">                &#125;</div><div class="line">                canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : 0);</div><div class="line">                attachInfo.mSetIgnoreDirtyState = false;</div><div class="line">                //传入canvas,调用指定View的draw方法开始绘制</div><div class="line">                mView.draw(canvas);</div><div class="line"></div><div class="line">                drawAccessibilityFocusedDrawableIfNeeded(canvas);</div><div class="line">            &#125; finally &#123;</div><div class="line">                if (!attachInfo.mSetIgnoreDirtyState) &#123;</div><div class="line">                    // Only clear the flag if it was not set during the mView.draw() call</div><div class="line">                    attachInfo.mIgnoreDirtyState = false;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            try &#123;</div><div class="line">                surface.unlockCanvasAndPost(canvas);</div><div class="line">            &#125; catch (IllegalArgumentException e) &#123;</div><div class="line">                mLayoutRequested = true;    // ask wm for a new surface next time.</div><div class="line">                //noinspection ReturnInsideFinallyBlock</div><div class="line">                return false;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在16行获取了canvas，在63行将canvas作为参数传递给View的draw方法，从前几篇分析可知，这里的mView是根节点DecorView，因此看下DecorView中的draw方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">源码路径：/SDK/sources/android-24/com/android/internal/policy/DecorView.java</div><div class="line">    public void draw(Canvas canvas) &#123;</div><div class="line">        super.draw(canvas);</div><div class="line"></div><div class="line">        if (mMenuBackground != null) &#123;</div><div class="line">            mMenuBackground.draw(canvas);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>回调了父类的draw方法，在父类FrameLayout和ViewGroup中均未复写draw，因此看下View中的draw方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Manually render this view (and all of its children) to the given Canvas.</div><div class="line">     * The view must have already done a full layout before this function is</div><div class="line">     * called.  When implementing a view, implement</div><div class="line">     * &#123;@link #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line">     * If you do need to override this method, call the superclass version.</div><div class="line">     *</div><div class="line">     * @param canvas The Canvas to which the View is rendered.</div><div class="line">     */</div><div class="line">    @CallSuper</div><div class="line">    public void draw(Canvas canvas) &#123;</div><div class="line">        final int privateFlags = mPrivateFlags;</div><div class="line">        final boolean dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">                (mAttachInfo == null || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">        mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Draw traversal performs several drawing steps which must be executed</div><div class="line">         * in the appropriate order:</div><div class="line">         *</div><div class="line">         *      1. Draw the background</div><div class="line">         *      2. If necessary, save the canvas&apos; layers to prepare for fading</div><div class="line">         *      3. Draw view&apos;s content</div><div class="line">         *      4. Draw children</div><div class="line">         *      5. If necessary, draw the fading edges and restore layers</div><div class="line">         *      6. Draw decorations (scrollbars for instance)</div><div class="line">         */</div><div class="line"></div><div class="line">        // Step 1, draw the background, if needed</div><div class="line">        int saveCount;</div><div class="line"></div><div class="line">        if (!dirtyOpaque) &#123;</div><div class="line">            drawBackground(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // skip step 2 &amp; 5 if possible (common case)</div><div class="line">        final int viewFlags = mViewFlags;</div><div class="line">        boolean horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != 0;</div><div class="line">        boolean verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != 0;</div><div class="line">        if (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">            // Step 3, draw the content</div><div class="line">            if (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">            // Step 4, draw the children</div><div class="line">            dispatchDraw(canvas);</div><div class="line"></div><div class="line">            // Overlay is part of the content and draws beneath Foreground</div><div class="line">            if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">                mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // Step 6, draw decorations (foreground, scrollbars)</div><div class="line">            onDrawForeground(canvas);</div><div class="line"></div><div class="line">            // we&apos;re done...</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Here we do the full fledged routine...</div><div class="line">         * (this is an uncommon case where speed matters less,</div><div class="line">         * this is why we repeat some of the tests that have been</div><div class="line">         * done above)</div><div class="line">         */</div><div class="line"></div><div class="line">        boolean drawTop = false;</div><div class="line">        boolean drawBottom = false;</div><div class="line">        boolean drawLeft = false;</div><div class="line">        boolean drawRight = false;</div><div class="line"></div><div class="line">        float topFadeStrength = 0.0f;</div><div class="line">        float bottomFadeStrength = 0.0f;</div><div class="line">        float leftFadeStrength = 0.0f;</div><div class="line">        float rightFadeStrength = 0.0f;</div><div class="line"></div><div class="line">        // Step 2, save the canvas&apos; layers</div><div class="line">        int paddingLeft = mPaddingLeft;</div><div class="line"></div><div class="line">        final boolean offsetRequired = isPaddingOffsetRequired();</div><div class="line">        if (offsetRequired) &#123;</div><div class="line">            paddingLeft += getLeftPaddingOffset();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        int left = mScrollX + paddingLeft;</div><div class="line">        int right = left + mRight - mLeft - mPaddingRight - paddingLeft;</div><div class="line">        int top = mScrollY + getFadeTop(offsetRequired);</div><div class="line">        int bottom = top + getFadeHeight(offsetRequired);</div><div class="line"></div><div class="line">        if (offsetRequired) &#123;</div><div class="line">            right += getRightPaddingOffset();</div><div class="line">            bottom += getBottomPaddingOffset();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final ScrollabilityCache scrollabilityCache = mScrollCache;</div><div class="line">        final float fadeHeight = scrollabilityCache.fadingEdgeLength;</div><div class="line">        int length = (int) fadeHeight;</div><div class="line"></div><div class="line">        // clip the fade length if top and bottom fades overlap</div><div class="line">        // overlapping fades produce odd-looking artifacts</div><div class="line">        if (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) &#123;</div><div class="line">            length = (bottom - top) / 2;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // also clip horizontal fades if necessary</div><div class="line">        if (horizontalEdges &amp;&amp; (left + length &gt; right - length)) &#123;</div><div class="line">            length = (right - left) / 2;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (verticalEdges) &#123;</div><div class="line">            topFadeStrength = Math.max(0.0f, Math.min(1.0f, getTopFadingEdgeStrength()));</div><div class="line">            drawTop = topFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">            bottomFadeStrength = Math.max(0.0f, Math.min(1.0f, getBottomFadingEdgeStrength()));</div><div class="line">            drawBottom = bottomFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (horizontalEdges) &#123;</div><div class="line">            leftFadeStrength = Math.max(0.0f, Math.min(1.0f, getLeftFadingEdgeStrength()));</div><div class="line">            drawLeft = leftFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">            rightFadeStrength = Math.max(0.0f, Math.min(1.0f, getRightFadingEdgeStrength()));</div><div class="line">            drawRight = rightFadeStrength * fadeHeight &gt; 1.0f;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        saveCount = canvas.getSaveCount();</div><div class="line"></div><div class="line">        int solidColor = getSolidColor();</div><div class="line">        if (solidColor == 0) &#123;</div><div class="line">            final int flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;</div><div class="line"></div><div class="line">            if (drawTop) &#123;</div><div class="line">                canvas.saveLayer(left, top, right, top + length, null, flags);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (drawBottom) &#123;</div><div class="line">                canvas.saveLayer(left, bottom - length, right, bottom, null, flags);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (drawLeft) &#123;</div><div class="line">                canvas.saveLayer(left, top, left + length, bottom, null, flags);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (drawRight) &#123;</div><div class="line">                canvas.saveLayer(right - length, top, right, bottom, null, flags);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            scrollabilityCache.setFadeColor(solidColor);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Step 3, draw the content</div><div class="line">        if (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">        // Step 4, draw the children</div><div class="line">        dispatchDraw(canvas);</div><div class="line"></div><div class="line">        // Step 5, draw the fade effect and restore layers</div><div class="line">        final Paint p = scrollabilityCache.paint;</div><div class="line">        final Matrix matrix = scrollabilityCache.matrix;</div><div class="line">        final Shader fade = scrollabilityCache.shader;</div><div class="line"></div><div class="line">        if (drawTop) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * topFadeStrength);</div><div class="line">            matrix.postTranslate(left, top);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(left, top, right, top + length, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (drawBottom) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * bottomFadeStrength);</div><div class="line">            matrix.postRotate(180);</div><div class="line">            matrix.postTranslate(left, bottom);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(left, bottom - length, right, bottom, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (drawLeft) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * leftFadeStrength);</div><div class="line">            matrix.postRotate(-90);</div><div class="line">            matrix.postTranslate(left, top);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(left, top, left + length, bottom, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (drawRight) &#123;</div><div class="line">            matrix.setScale(1, fadeHeight * rightFadeStrength);</div><div class="line">            matrix.postRotate(90);</div><div class="line">            matrix.postTranslate(right, top);</div><div class="line">            fade.setLocalMatrix(matrix);</div><div class="line">            p.setShader(fade);</div><div class="line">            canvas.drawRect(right - length, top, right, bottom, p);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        canvas.restoreToCount(saveCount);</div><div class="line"></div><div class="line">        // Overlay is part of the content and draws beneath Foreground</div><div class="line">        if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Step 6, draw decorations (foreground, scrollbars)</div><div class="line">        onDrawForeground(canvas);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过该方法的注释可知，当自定义View需要绘制时，应该重写onDraw方法而不是draw方法，如果要重写draw方法，需要先调用父类的draw方法。另外根据18-28行的注释代码可知，draw的流程分为以下6步：</p>
<p>1.背景绘制<br>2.保存画布图层，为渐变效果做准备(可跳过)<br>3.绘制视图内容<br>4.绘制子视图<br>5.绘制渐变效果(可跳过)<br>6.绘制其他装饰物(前景和滚动条)</p>
<p>逐步分析以上流程，先看背景绘制</p>
<h2 id="Step1背景绘制"><a href="#Step1背景绘制" class="headerlink" title="Step1背景绘制"></a>Step1背景绘制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Draws the background onto the specified canvas.</div><div class="line">     *</div><div class="line">     * @param canvas Canvas on which to draw the background</div><div class="line">     */</div><div class="line">    private void drawBackground(Canvas canvas) &#123;</div><div class="line">        final Drawable background = mBackground;</div><div class="line">        if (background == null) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setBackgroundBounds();</div><div class="line"></div><div class="line">        // Attempt to use a display list if requested.</div><div class="line">        if (canvas.isHardwareAccelerated() &amp;&amp; mAttachInfo != null</div><div class="line">                &amp;&amp; mAttachInfo.mHardwareRenderer != null) &#123;</div><div class="line">            mBackgroundRenderNode = getDrawableRenderNode(background, mBackgroundRenderNode);</div><div class="line"></div><div class="line">            final RenderNode renderNode = mBackgroundRenderNode;</div><div class="line">            if (renderNode != null &amp;&amp; renderNode.isValid()) &#123;</div><div class="line">                setBackgroundRenderNodeProperties(renderNode);</div><div class="line">                ((DisplayListCanvas) canvas).drawRenderNode(renderNode);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final int scrollX = mScrollX;</div><div class="line">        final int scrollY = mScrollY;</div><div class="line">        if ((scrollX | scrollY) == 0) &#123;</div><div class="line">            background.draw(canvas);</div><div class="line">        &#125; else &#123;</div><div class="line">            canvas.translate(scrollX, scrollY);</div><div class="line">            background.draw(canvas);</div><div class="line">            canvas.translate(-scrollX, -scrollY);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在第8行首先获取background，这里的background是xml中android:background属性或者在代码中调用setBackground()、setBackgroundResource()赋值的Drawable，如果background为null就返回，接着执行setBackgroundBounds确定背景的范围，最后调用Drawable的draw方法完成背景的绘制。</p>
<h2 id="Step2保存画布图层"><a href="#Step2保存画布图层" class="headerlink" title="Step2保存画布图层"></a>Step2保存画布图层</h2><p>在View中的draw方法的37-58行判断在水平和垂直方向是否需要渐变效果，若不需要则跳过2、5步骤，只执行3、4、6步，如果需要，77-147行调用canvas的saveLayer保存画布图层。</p>
<h2 id="Step3绘制视图内容"><a href="#Step3绘制视图内容" class="headerlink" title="Step3绘制视图内容"></a>Step3绘制视图内容</h2><p>第三步会执行onDraw，查看View中的onDraw</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Implement this to do your drawing.</div><div class="line">     *</div><div class="line">     * @param canvas the canvas on which the background will be drawn</div><div class="line">     */</div><div class="line">    protected void onDraw(Canvas canvas) &#123;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>View中的onDraw是个空方法，说明具体实现在子类中，那么查看下DecorView的onDraw方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">源码路径：/SDK/sources/android-24/com/android/internal/policy/DecorView.java</div><div class="line">    public void onDraw(Canvas c) &#123;</div><div class="line">        super.onDraw(c);</div><div class="line">        mBackgroundFallback.draw(mContentRoot, c, mWindow.mContentParent);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到这里有调用了父类的onDraw，但是在父类FrameLayout和ViewGroup中都没有重写onDraw，View中又是个空方法，所以只能是在mBackgroundFallback的draw方法，这里的mBackgroundFallback是个BackgroundFallback实例，draw方法具体如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/com/android/internal/widget/BackgroundFallback.java</div><div class="line">    private Drawable mBackgroundFallback;</div><div class="line">    public void draw(ViewGroup root, Canvas c, View content) &#123;</div><div class="line">        if (!hasFallback()) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Draw the fallback in the padding.</div><div class="line">        final int width = root.getWidth();</div><div class="line">        final int height = root.getHeight();</div><div class="line">        int left = width;</div><div class="line">        int top = height;</div><div class="line">        int right = 0;</div><div class="line">        int bottom = 0;</div><div class="line"></div><div class="line">        final int childCount = root.getChildCount();</div><div class="line">        for (int i = 0; i &lt; childCount; i++) &#123;</div><div class="line">            final View child = root.getChildAt(i);</div><div class="line">            final Drawable childBg = child.getBackground();</div><div class="line">            if (child == content) &#123;</div><div class="line">                // We always count the content view container unless it has no background</div><div class="line">                // and no children.</div><div class="line">                if (childBg == null &amp;&amp; child instanceof ViewGroup &amp;&amp;</div><div class="line">                        ((ViewGroup) child).getChildCount() == 0) &#123;</div><div class="line">                    continue;</div><div class="line">                &#125;</div><div class="line">            &#125; else if (child.getVisibility() != View.VISIBLE || childBg == null ||</div><div class="line">                    childBg.getOpacity() != PixelFormat.OPAQUE) &#123;</div><div class="line">                // Potentially translucent or invisible children don&apos;t count, and we assume</div><div class="line">                // the content view will cover the whole area if we&apos;re in a background</div><div class="line">                // fallback situation.</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            left = Math.min(left, child.getLeft());</div><div class="line">            top = Math.min(top, child.getTop());</div><div class="line">            right = Math.max(right, child.getRight());</div><div class="line">            bottom = Math.max(bottom, child.getBottom());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (left &gt;= right || top &gt;= bottom) &#123;</div><div class="line">            // No valid area to draw in.</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (top &gt; 0) &#123;</div><div class="line">            mBackgroundFallback.setBounds(0, 0, width, top);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">        if (left &gt; 0) &#123;</div><div class="line">            mBackgroundFallback.setBounds(0, top, left, height);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">        if (right &lt; width) &#123;</div><div class="line">            mBackgroundFallback.setBounds(right, top, width, height);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">        if (bottom &lt; height) &#123;</div><div class="line">            mBackgroundFallback.setBounds(left, bottom, right, height);</div><div class="line">            mBackgroundFallback.draw(c);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后是通过Drawable的draw方法绘制。</p>
<h2 id="Step4绘制子视图"><a href="#Step4绘制子视图" class="headerlink" title="Step4绘制子视图"></a>Step4绘制子视图</h2><p>第四步绘制子视图会调用View的dispatchDraw方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Called by draw to draw the child views. This may be overridden</div><div class="line"> * by derived classes to gain control just before its children are drawn</div><div class="line"> * (but after its own view has been drawn).</div><div class="line"> * @param canvas the canvas on which to draw the view</div><div class="line"> */</div><div class="line">protected void dispatchDraw(Canvas canvas) &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>View中的dispatchDraw也是个空方法，说明实现在子类，在DecorView和FrameLayout中都没有复写该方法，ViewGroup中该方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    protected void dispatchDraw(Canvas canvas) &#123;</div><div class="line">        boolean usingRenderNodeProperties = canvas.isRecordingFor(mRenderNode);</div><div class="line">        final int childrenCount = mChildrenCount;</div><div class="line">        final View[] children = mChildren;</div><div class="line">        int flags = mGroupFlags;</div><div class="line">        //该ViewGroup是否设置布局动画</div><div class="line">        if ((flags &amp; FLAG_RUN_ANIMATION) != 0 &amp;&amp; canAnimate()) &#123;</div><div class="line">            final boolean buildCache = !isHardwareAccelerated();</div><div class="line">            for (int i = 0; i &lt; childrenCount; i++) &#123;</div><div class="line">                final View child = children[i];</div><div class="line">                if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</div><div class="line">                    //如果子View可见,设置动画</div><div class="line">                    final LayoutParams params = child.getLayoutParams();</div><div class="line">                    attachLayoutAnimationParameters(child, params, i, childrenCount);</div><div class="line">                    bindLayoutAnimation(child);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //获取动画控制器</div><div class="line">            final LayoutAnimationController controller = mLayoutAnimationController;</div><div class="line">            if (controller.willOverlap()) &#123;</div><div class="line">                mGroupFlags |= FLAG_OPTIMIZE_INVALIDATE;</div><div class="line">            &#125;</div><div class="line">            //开始布局动画</div><div class="line">            controller.start();</div><div class="line"></div><div class="line">            mGroupFlags &amp;= ~FLAG_RUN_ANIMATION;</div><div class="line">            mGroupFlags &amp;= ~FLAG_ANIMATION_DONE;</div><div class="line"></div><div class="line">            if (mAnimationListener != null) &#123;</div><div class="line">                mAnimationListener.onAnimationStart(controller.getAnimation());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        int clipSaveCount = 0;</div><div class="line">        //是否需要剪裁边距</div><div class="line">        final boolean clipToPadding = (flags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK;</div><div class="line">        if (clipToPadding) &#123;</div><div class="line">            clipSaveCount = canvas.save();</div><div class="line">            //裁剪边距</div><div class="line">            canvas.clipRect(mScrollX + mPaddingLeft, mScrollY + mPaddingTop,</div><div class="line">                    mScrollX + mRight - mLeft - mPaddingRight,</div><div class="line">                    mScrollY + mBottom - mTop - mPaddingBottom);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // We will draw our child&apos;s animation, let&apos;s reset the flag</div><div class="line">        mPrivateFlags &amp;= ~PFLAG_DRAW_ANIMATION;</div><div class="line">        mGroupFlags &amp;= ~FLAG_INVALIDATE_REQUIRED;</div><div class="line"></div><div class="line">        boolean more = false;</div><div class="line">        final long drawingTime = getDrawingTime();</div><div class="line"></div><div class="line">        if (usingRenderNodeProperties) canvas.insertReorderBarrier();</div><div class="line">        final int transientCount = mTransientIndices == null ? 0 : mTransientIndices.size();</div><div class="line">        int transientIndex = transientCount != 0 ? 0 : -1;</div><div class="line">        // Only use the preordered list if not HW accelerated, since the HW pipeline will do the</div><div class="line">        // draw reordering internally</div><div class="line">        final ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</div><div class="line">                ? null : buildOrderedChildList();</div><div class="line">        final boolean customOrder = preorderedList == null</div><div class="line">                &amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">        for (int i = 0; i &lt; childrenCount; i++) &#123;</div><div class="line">            while (transientIndex &gt;= 0 &amp;&amp; mTransientIndices.get(transientIndex) == i) &#123;</div><div class="line">                final View transientChild = mTransientViews.get(transientIndex);</div><div class="line">                if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE ||</div><div class="line">                        transientChild.getAnimation() != null) &#123;</div><div class="line">                        //调用drawChild绘制子视图</div><div class="line">                    more |= drawChild(canvas, transientChild, drawingTime);</div><div class="line">                &#125;</div><div class="line">                transientIndex++;</div><div class="line">                if (transientIndex &gt;= transientCount) &#123;</div><div class="line">                    transientIndex = -1;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder);</div><div class="line">            final View child = getAndVerifyPreorderedView(preorderedList, children, childIndex);</div><div class="line">            if ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != null) &#123;</div><div class="line">                more |= drawChild(canvas, child, drawingTime);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        while (transientIndex &gt;= 0) &#123;</div><div class="line">            // there may be additional transient views after the normal views</div><div class="line">            final View transientChild = mTransientViews.get(transientIndex);</div><div class="line">            if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE ||</div><div class="line">                    transientChild.getAnimation() != null) &#123;</div><div class="line">                more |= drawChild(canvas, transientChild, drawingTime);</div><div class="line">            &#125;</div><div class="line">            transientIndex++;</div><div class="line">            if (transientIndex &gt;= transientCount) &#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (preorderedList != null) preorderedList.clear();</div><div class="line"></div><div class="line">        // Draw any disappearing views that have animations</div><div class="line">        //绘制设置了消失动画的子视图</div><div class="line">        if (mDisappearingChildren != null) &#123;</div><div class="line">            final ArrayList&lt;View&gt; disappearingChildren = mDisappearingChildren;</div><div class="line">            final int disappearingCount = disappearingChildren.size() - 1;</div><div class="line">            // Go backwards -- we may delete as animations finish</div><div class="line">            for (int i = disappearingCount; i &gt;= 0; i--) &#123;</div><div class="line">                final View child = disappearingChildren.get(i);</div><div class="line">                more |= drawChild(canvas, child, drawingTime);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (usingRenderNodeProperties) canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">        if (debugDraw()) &#123;</div><div class="line">            onDebugDraw(canvas);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (clipToPadding) &#123;</div><div class="line">            canvas.restoreToCount(clipSaveCount);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // mGroupFlags might have been updated by drawChild()</div><div class="line">        flags = mGroupFlags;</div><div class="line"></div><div class="line">        if ((flags &amp; FLAG_INVALIDATE_REQUIRED) == FLAG_INVALIDATE_REQUIRED) &#123;</div><div class="line">            invalidate(true);</div><div class="line">        &#125;</div><div class="line">        //更新布局动画的监听事件</div><div class="line">        if ((flags &amp; FLAG_ANIMATION_DONE) == 0 &amp;&amp; (flags &amp; FLAG_NOTIFY_ANIMATION_LISTENER) == 0 &amp;&amp;</div><div class="line">                mLayoutAnimationController.isDone() &amp;&amp; !more) &#123;</div><div class="line">            // We want to erase the drawing cache and notify the listener after the</div><div class="line">            // next frame is drawn because one extra invalidate() is caused by</div><div class="line">            // drawChild() after the animation is over</div><div class="line">            mGroupFlags |= FLAG_NOTIFY_ANIMATION_LISTENER;</div><div class="line">            final Runnable end = new Runnable() &#123;</div><div class="line">               @Override</div><div class="line">               public void run() &#123;</div><div class="line">                   notifyAnimationListener();</div><div class="line">               &#125;</div><div class="line">            &#125;;</div><div class="line">            post(end);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>分析上面的代码，7-33行，如果该ViewGroup的xml属性设置android:animateLayoutChanges=“true”，则满足该部分条件，在子View出现的时候会有默认的动画效果；该方法会遍历ViewGroup下的子View，调用drawChild方法完成子View的绘制，drawChild方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    /**</div><div class="line">     * Draw one child of this View Group. This method is responsible for getting</div><div class="line">     * the canvas in the right state. This includes clipping, translating so</div><div class="line">     * that the child&apos;s scrolled origin is at 0, 0, and applying any animation</div><div class="line">     * transformations.</div><div class="line">     *</div><div class="line">     * @param canvas The canvas on which to draw the child</div><div class="line">     * @param child Who to draw</div><div class="line">     * @param drawingTime The time at which draw is occurring</div><div class="line">     * @return True if an invalidate() was issued</div><div class="line">     */</div><div class="line">    protected boolean drawChild(Canvas canvas, View child, long drawingTime) &#123;</div><div class="line">        return child.draw(canvas, this, drawingTime);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里又调用了View的draw方法，直到具体的子View被绘制为止。</p>
<h2 id="Step5绘制渐变效果"><a href="#Step5绘制渐变效果" class="headerlink" title="Step5绘制渐变效果"></a>Step5绘制渐变效果</h2><p>在View的draw方法155-200行完成ViewGroup渐变效果的绘制</p>
<h2 id="Step6绘制其他装饰物"><a href="#Step6绘制其他装饰物" class="headerlink" title="Step6绘制其他装饰物"></a>Step6绘制其他装饰物</h2><p>在View的draw方法203行负责绘制其他装饰，包括前景、滚动条，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Draw any foreground content for this view.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Foreground content may consist of scroll bars, a &#123;@link #setForeground foreground&#125;</div><div class="line"> * drawable or other view-specific decorations. The foreground is drawn on top of the</div><div class="line"> * primary view content.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param canvas canvas to draw into</div><div class="line"> */</div><div class="line">public void onDrawForeground(Canvas canvas) &#123;</div><div class="line">    onDrawScrollIndicators(canvas);</div><div class="line">    onDrawScrollBars(canvas);</div><div class="line"></div><div class="line">    final Drawable foreground = mForegroundInfo != null ? mForegroundInfo.mDrawable : null;</div><div class="line">    if (foreground != null) &#123;</div><div class="line">        if (mForegroundInfo.mBoundsChanged) &#123;</div><div class="line">            mForegroundInfo.mBoundsChanged = false;</div><div class="line">            final Rect selfBounds = mForegroundInfo.mSelfBounds;</div><div class="line">            final Rect overlayBounds = mForegroundInfo.mOverlayBounds;</div><div class="line"></div><div class="line">            if (mForegroundInfo.mInsidePadding) &#123;</div><div class="line">                selfBounds.set(0, 0, getWidth(), getHeight());</div><div class="line">            &#125; else &#123;</div><div class="line">                selfBounds.set(getPaddingLeft(), getPaddingTop(),</div><div class="line">                        getWidth() - getPaddingRight(), getHeight() - getPaddingBottom());</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int ld = getLayoutDirection();</div><div class="line">            Gravity.apply(mForegroundInfo.mGravity, foreground.getIntrinsicWidth(),</div><div class="line">                    foreground.getIntrinsicHeight(), selfBounds, overlayBounds, ld);</div><div class="line">            foreground.setBounds(overlayBounds);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        foreground.draw(canvas);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码用户绘制滚动条和前景，如果当前布局设置了foreground，则调用foreground的draw方法进行绘制，看下绘制滚动条的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &lt;p&gt;Request the drawing of the horizontal and the vertical scrollbar. The</div><div class="line"> * scrollbars are painted only if they have been awakened first.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param canvas the canvas on which to draw the scrollbars</div><div class="line"> *</div><div class="line"> * @see #awakenScrollBars(int)</div><div class="line"> */</div><div class="line">protected final void onDrawScrollBars(Canvas canvas) &#123;</div><div class="line">    // scrollbars are drawn only when the animation is running</div><div class="line">    final ScrollabilityCache cache = mScrollCache;</div><div class="line">    if (cache != null) &#123;</div><div class="line"></div><div class="line">        int state = cache.state;</div><div class="line"></div><div class="line">        if (state == ScrollabilityCache.OFF) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean invalidate = false;</div><div class="line"></div><div class="line">        if (state == ScrollabilityCache.FADING) &#123;</div><div class="line">            // We&apos;re fading -- get our fade interpolation</div><div class="line">            if (cache.interpolatorValues == null) &#123;</div><div class="line">                cache.interpolatorValues = new float[1];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            float[] values = cache.interpolatorValues;</div><div class="line"></div><div class="line">            // Stops the animation if we&apos;re done</div><div class="line">            if (cache.scrollBarInterpolator.timeToValues(values) ==</div><div class="line">                    Interpolator.Result.FREEZE_END) &#123;</div><div class="line">                cache.state = ScrollabilityCache.OFF;</div><div class="line">            &#125; else &#123;</div><div class="line">                cache.scrollBar.mutate().setAlpha(Math.round(values[0]));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // This will make the scroll bars inval themselves after</div><div class="line">            // drawing. We only want this when we&apos;re fading so that</div><div class="line">            // we prevent excessive redraws</div><div class="line">            invalidate = true;</div><div class="line">        &#125; else &#123;</div><div class="line">            // We&apos;re just on -- but we may have been fading before so</div><div class="line">            // reset alpha</div><div class="line">            cache.scrollBar.mutate().setAlpha(255);</div><div class="line">        &#125;</div><div class="line">        //是否绘制水平和竖直方向上的滚动条，默认为false</div><div class="line">        final boolean drawHorizontalScrollBar = isHorizontalScrollBarEnabled();</div><div class="line">        final boolean drawVerticalScrollBar = isVerticalScrollBarEnabled()</div><div class="line">                &amp;&amp; !isVerticalScrollBarHidden();</div><div class="line"></div><div class="line">        if (drawVerticalScrollBar || drawHorizontalScrollBar) &#123;</div><div class="line">            final ScrollBarDrawable scrollBar = cache.scrollBar;</div><div class="line">            //绘制水平方向上的滚动条</div><div class="line">            if (drawHorizontalScrollBar) &#123;</div><div class="line">                scrollBar.setParameters(computeHorizontalScrollRange(),</div><div class="line">                                        computeHorizontalScrollOffset(),</div><div class="line">                                        computeHorizontalScrollExtent(), false);</div><div class="line">                final Rect bounds = cache.mScrollBarBounds;</div><div class="line">                getHorizontalScrollBarBounds(bounds);</div><div class="line">                onDrawHorizontalScrollBar(canvas, scrollBar, bounds.left, bounds.top,</div><div class="line">                        bounds.right, bounds.bottom);</div><div class="line">                if (invalidate) &#123;</div><div class="line">                    invalidate(bounds);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            //绘制垂直方向上的滚动条</div><div class="line">            if (drawVerticalScrollBar) &#123;</div><div class="line">                scrollBar.setParameters(computeVerticalScrollRange(),</div><div class="line">                                        computeVerticalScrollOffset(),</div><div class="line">                                        computeVerticalScrollExtent(), true);</div><div class="line">                final Rect bounds = cache.mScrollBarBounds;</div><div class="line">                getVerticalScrollBarBounds(bounds);</div><div class="line">                onDrawVerticalScrollBar(canvas, scrollBar, bounds.left, bounds.top,</div><div class="line">                        bounds.right, bounds.bottom);</div><div class="line">                if (invalidate) &#123;</div><div class="line">                    invalidate(bounds);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>16行，判断是否需要绘制滚动条，如果当前布局设置了android:scrollbars=“none”属性，不绘制滚动条；<br>22行，判断滚动条是否可消失，如果当前布局设置了android:fadeScrollbars=“true”属性，当滑动时，滚动条显示，不滑动时，滚动条消失，这里是通过setAlpha来改变Alpha值完成；<br>45行，如果当前布局设置了android:fadeScrollbars=“false”属性，则不管滑动与否，滚动条一直显示。<br>从上面的代码也可以看出所有的View都会绘制滚动条，只是有些没有显示出来。</p>
<h2 id="draw总结"><a href="#draw总结" class="headerlink" title="draw总结"></a>draw总结</h2><p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/draw.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/draw.png" alt="img"></a></p>
<p>View的具体绘制在子View中实现，父View主要绘制背景以及渐变效果，自定义View时重写onDraw方法实现具体绘制，所有的View都会绘制滚动条，该操作在父View中完成。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/26/Android View绘制源码分析--Layout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/26/Android View绘制源码分析--Layout/" itemprop="url">Android View绘制源码分析--Layout</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-26T00:00:00+08:00">
                2017-05-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/26/Android View绘制源码分析--Layout/" class="leancloud_visitors" data-flag-title="Android View绘制源码分析--Layout">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>上篇文章分析DecorView的绘制的measure流程，这篇文章继续分析DecorView绘制的第二个阶段，layout流程。</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>先看ViewRootImpl的performLayout方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth,</div><div class="line">            int desiredWindowHeight) &#123;</div><div class="line">        mLayoutRequested = false;</div><div class="line">        mScrollMayChange = true;</div><div class="line">        //布局开始</div><div class="line">        mInLayout = true;</div><div class="line">        //host就是DecorView</div><div class="line">        final View host = mView;</div><div class="line"></div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;layout&quot;);</div><div class="line">        try &#123;</div><div class="line">            //DecorView开始布局,以左上角为原点</div><div class="line">            host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">            //布局结束</div><div class="line">            mInLayout = false;</div><div class="line">            //这里mLayoutRequesters的size值在requestLayoutDuringLayout方法中会改变，requestLayoutDuringLayout会在View的requestLayout中被调用</div><div class="line">            int numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">            if (numViewsRequestingLayout &gt; 0) &#123;</div><div class="line">                // requestLayout() was called during layout.</div><div class="line">                // If no layout-request flags are set on the requesting views, there is no problem.</div><div class="line">                // If some requests are still pending, then we need to clear those flags and do</div><div class="line">                // a full request/measure/layout pass to handle this situation.</div><div class="line">                ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">                        false);</div><div class="line">                if (validLayoutRequesters != null) &#123;</div><div class="line">                    // Set this flag to indicate that any further requests are happening during</div><div class="line">                    // the second pass, which may result in posting those requests to the next</div><div class="line">                    // frame instead</div><div class="line">                    mHandlingLayoutInLayoutRequest = true;</div><div class="line"></div><div class="line">                    // Process fresh layout requests, then measure and layout</div><div class="line">                    int numValidRequests = validLayoutRequesters.size();</div><div class="line">                    for (int i = 0; i &lt; numValidRequests; ++i) &#123;</div><div class="line">                        final View view = validLayoutRequesters.get(i);</div><div class="line">                        Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">                                &quot; during layout: running second layout pass&quot;);</div><div class="line">                        view.requestLayout();</div><div class="line">                    &#125;</div><div class="line">                    measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">                            desiredWindowWidth, desiredWindowHeight);</div><div class="line">                    mInLayout = true;</div><div class="line">                    host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">                    mHandlingLayoutInLayoutRequest = false;</div><div class="line"></div><div class="line">                    // Check the valid requests again, this time without checking/clearing the</div><div class="line">                    // layout flags, since requests happening during the second pass get noop&apos;d</div><div class="line">                    validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, true);</div><div class="line">                    if (validLayoutRequesters != null) &#123;</div><div class="line">                        final ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">                        // Post second-pass requests to the next frame</div><div class="line">                        getRunQueue().post(new Runnable() &#123;</div><div class="line">                            @Override</div><div class="line">                            public void run() &#123;</div><div class="line">                                int numValidRequests = finalRequesters.size();</div><div class="line">                                for (int i = 0; i &lt; numValidRequests; ++i) &#123;</div><div class="line">                                    final View view = finalRequesters.get(i);</div><div class="line">                                    Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">                                            &quot; during second layout pass: posting in next frame&quot;);</div><div class="line">                                    view.requestLayout();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125; finally &#123;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">        &#125;</div><div class="line">        mInLayout = false;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在13行调用DecorView的layout方法，传入的位置参数左0，上0，右为设备的宽度，下为设备的高度；在DecorView和FrameLayout中都没找到layout方法，继续往上查看ViewGroup，layout方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    public final void layout(int l, int t, int r, int b) &#123;</div><div class="line">        if (!mSuppressLayout &amp;&amp; (mTransition == null || !mTransition.isChangingLayout())) &#123;</div><div class="line">            if (mTransition != null) &#123;</div><div class="line">                mTransition.layoutChange(this);</div><div class="line">            &#125;</div><div class="line">            super.layout(l, t, r, b);</div><div class="line">        &#125; else &#123;</div><div class="line">            // record the fact that we noop&apos;d it; request layout when transition finishes</div><div class="line">            mLayoutCalledWhileSuppressed = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>注意到这里的layout的修饰是final，说明ViewGroup的子类无法复写该方法，该方法又回调了父类的layout方法，所以看下View中的layout:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Assign a size and position to a view and all of its</div><div class="line">     * descendants</div><div class="line">     *</div><div class="line">     * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line">     * (The first is measuring). In this phase, each parent calls</div><div class="line">     * layout on all of its children to position them.</div><div class="line">     * This is typically done using the child measurements</div><div class="line">     * that were stored in the measure pass().&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Derived classes should not override this method.</div><div class="line">     * Derived classes with children should override</div><div class="line">     * onLayout. In that method, they should</div><div class="line">     * call layout on each of their children.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * @param l Left position, relative to parent</div><div class="line">     * @param t Top position, relative to parent</div><div class="line">     * @param r Right position, relative to parent</div><div class="line">     * @param b Bottom position, relative to parent</div><div class="line">     */</div><div class="line">    @SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</div><div class="line">    public void layout(int l, int t, int r, int b) &#123;</div><div class="line">        //是否需要重新测量</div><div class="line">        if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) &#123;</div><div class="line">            onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">        &#125;</div><div class="line">        //保存之前View的位置</div><div class="line">        int oldL = mLeft;</div><div class="line">        int oldT = mTop;</div><div class="line">        int oldB = mBottom;</div><div class="line">        int oldR = mRight;</div><div class="line">        //与之前相比位置是否发生改变，通过setFrame方法设置最新的位置</div><div class="line">        boolean changed = isLayoutModeOptical(mParent) ?</div><div class="line">                setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">        if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">            //若发生了改变，具体的布局实现</div><div class="line">            onLayout(changed, l, t, r, b);</div><div class="line">            mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line"></div><div class="line">            ListenerInfo li = mListenerInfo;</div><div class="line">            if (li != null &amp;&amp; li.mOnLayoutChangeListeners != null) &#123;</div><div class="line">                ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">                        (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">                int numListeners = listenersCopy.size();</div><div class="line">                for (int i = 0; i &lt; numListeners; ++i) &#123;</div><div class="line">                    //若设置了布局变化的监听事件，当布局发生变化时触发</div><div class="line">                    listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">        mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过注释我们了解到，这是绘制机制的第二部分，在这部分父布局会调用layout方法确定子布局的位置，并且子类不应该复写layout而应该复写onLayout。查看这里的setFrame方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Assign a size and position to this view.</div><div class="line"> *</div><div class="line"> * This is called from layout.</div><div class="line"> *</div><div class="line"> * @param left Left position, relative to parent</div><div class="line"> * @param top Top position, relative to parent</div><div class="line"> * @param right Right position, relative to parent</div><div class="line"> * @param bottom Bottom position, relative to parent</div><div class="line"> * @return true if the new size and position are different than the</div><div class="line"> *         previous ones</div><div class="line"> * &#123;@hide&#125;</div><div class="line"> */</div><div class="line">protected boolean setFrame(int left, int top, int right, int bottom) &#123;</div><div class="line">    boolean changed = false;</div><div class="line"></div><div class="line">    if (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;</div><div class="line">        //与之前相比上下左右只要有一个改变就为true</div><div class="line">        changed = true;</div><div class="line"></div><div class="line">        // Remember our drawn bit</div><div class="line">        int drawn = mPrivateFlags &amp; PFLAG_DRAWN;</div><div class="line">        //之前的宽度</div><div class="line">        int oldWidth = mRight - mLeft;</div><div class="line">        //之前的高度</div><div class="line">        int oldHeight = mBottom - mTop;</div><div class="line">        //新的宽度</div><div class="line">        int newWidth = right - left;</div><div class="line">        //新的高度</div><div class="line">        int newHeight = bottom - top;</div><div class="line">        //大小是否改变</div><div class="line">        boolean sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);</div><div class="line"></div><div class="line">        // Invalidate our old position</div><div class="line">        //清除之前的位置</div><div class="line">        invalidate(sizeChanged);</div><div class="line">        //最新的位置赋值，View的位置就确定了</div><div class="line">        mLeft = left;</div><div class="line">        mTop = top;</div><div class="line">        mRight = right;</div><div class="line">        mBottom = bottom;</div><div class="line">        mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</div><div class="line"></div><div class="line">        mPrivateFlags |= PFLAG_HAS_BOUNDS;</div><div class="line"></div><div class="line"></div><div class="line">        if (sizeChanged) &#123;</div><div class="line">            sizeChange(newWidth, newHeight, oldWidth, oldHeight);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if ((mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || mGhostView != null) &#123;</div><div class="line">            // If we are visible, force the DRAWN bit to on so that</div><div class="line">            // this invalidate will go through (at least to our parent).</div><div class="line">            // This is because someone may have invalidated this view</div><div class="line">            // before this call to setFrame came in, thereby clearing</div><div class="line">            // the DRAWN bit.</div><div class="line">            mPrivateFlags |= PFLAG_DRAWN;</div><div class="line">            invalidate(sizeChanged);</div><div class="line">            // parent display list may need to be recreated based on a change in the bounds</div><div class="line">            // of any child</div><div class="line">            invalidateParentCaches();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Reset drawn bit to original value (invalidate turns it off)</div><div class="line">        mPrivateFlags |= drawn;</div><div class="line"></div><div class="line">        mBackgroundSizeChanged = true;</div><div class="line">        if (mForegroundInfo != null) &#123;</div><div class="line">            mForegroundInfo.mBoundsChanged = true;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        notifySubtreeAccessibilityStateChangedIfNeeded();</div><div class="line">    &#125;</div><div class="line">    return changed;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从该方法可以知道，如果位置发生了变化，则会保存最新的位置值，而这里也是四个位置值初始化的地方，我们平时调用getWidth/getHeight如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Return the width of the your view.</div><div class="line"> *</div><div class="line"> * @return The width of your view, in pixels.</div><div class="line"> */</div><div class="line">@ViewDebug.ExportedProperty(category = &quot;layout&quot;)</div><div class="line">public final int getWidth() &#123;</div><div class="line">    return mRight - mLeft;</div><div class="line">&#125;</div><div class="line">/**</div><div class="line"> * Return the height of your view.</div><div class="line"> *</div><div class="line"> * @return The height of your view, in pixels.</div><div class="line"> */</div><div class="line">@ViewDebug.ExportedProperty(category = &quot;layout&quot;)</div><div class="line">public final int getHeight() &#123;</div><div class="line">    return mBottom - mTop;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此，必须在layout方法执行后调用getWidth、getHeight才有效。回到View的layout方法，既然在setFrame中已经确定了布局的位置，那么onLayout方法又是用来干嘛的呢？DecorView中复写了onLayout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">    protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</div><div class="line">        super.onLayout(changed, left, top, right, bottom);</div><div class="line">        getOutsets(mOutsets);</div><div class="line">        if (mOutsets.left &gt; 0) &#123;</div><div class="line">            offsetLeftAndRight(-mOutsets.left);</div><div class="line">        &#125;</div><div class="line">        if (mOutsets.top &gt; 0) &#123;</div><div class="line">            offsetTopAndBottom(-mOutsets.top);</div><div class="line">        &#125;</div><div class="line">        if (mApplyFloatingVerticalInsets) &#123;</div><div class="line">            offsetTopAndBottom(mFloatingInsets.top);</div><div class="line">        &#125;</div><div class="line">        if (mApplyFloatingHorizontalInsets) &#123;</div><div class="line">            offsetLeftAndRight(mFloatingInsets.left);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // If the application changed its SystemUI metrics, we might also have to adapt</div><div class="line">        // our shadow elevation.</div><div class="line">        updateElevation();</div><div class="line">        mAllowUpdateElevation = true;</div><div class="line"></div><div class="line">        if (changed &amp;&amp; mResizeMode == RESIZE_MODE_DOCKED_DIVIDER) &#123;</div><div class="line">            getViewRootImpl().requestInvalidateRootRenderNode();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这里又调用了父类的onLayout，看下FrameLayout的onLayout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">源码路径：SDK/sources/android-24/android/widget/FrameLayout.java</div><div class="line">    protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</div><div class="line">        layoutChildren(left, top, right, bottom, false /* no force left gravity */);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) &#123;</div><div class="line">        final int count = getChildCount();</div><div class="line">        //获取父布局的位置</div><div class="line">        final int parentLeft = getPaddingLeftWithForeground();</div><div class="line">        final int parentRight = right - left - getPaddingRightWithForeground();</div><div class="line"></div><div class="line">        final int parentTop = getPaddingTopWithForeground();</div><div class="line">        final int parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line">        //遍历子布局</div><div class="line">        for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">            final View child = getChildAt(i);</div><div class="line">            //如果子布局的Visibility属性不为GONE</div><div class="line">            if (child.getVisibility() != GONE) &#123;</div><div class="line">                final LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">                //获取子布局的宽高</div><div class="line">                final int width = child.getMeasuredWidth();</div><div class="line">                final int height = child.getMeasuredHeight();</div><div class="line">                //子布局左、上位置</div><div class="line">                int childLeft;</div><div class="line">                int childTop;</div><div class="line"></div><div class="line">                int gravity = lp.gravity;</div><div class="line">                if (gravity == -1) &#123;</div><div class="line">                    gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                final int layoutDirection = getLayoutDirection();</div><div class="line">                final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">                final int verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line">                //计算子布局的左位置</div><div class="line">                switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">                    case Gravity.CENTER_HORIZONTAL:</div><div class="line">                        childLeft = parentLeft + (parentRight - parentLeft - width) / 2 +</div><div class="line">                        lp.leftMargin - lp.rightMargin;</div><div class="line">                        break;</div><div class="line">                    case Gravity.RIGHT:</div><div class="line">                        if (!forceLeftGravity) &#123;</div><div class="line">                            childLeft = parentRight - width - lp.rightMargin;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line">                    case Gravity.LEFT:</div><div class="line">                    default:</div><div class="line">                        childLeft = parentLeft + lp.leftMargin;</div><div class="line">                &#125;</div><div class="line">                //计算子布局的上位置</div><div class="line">                switch (verticalGravity) &#123;</div><div class="line">                    case Gravity.TOP:</div><div class="line">                        childTop = parentTop + lp.topMargin;</div><div class="line">                        break;</div><div class="line">                    case Gravity.CENTER_VERTICAL:</div><div class="line">                        childTop = parentTop + (parentBottom - parentTop - height) / 2 +</div><div class="line">                        lp.topMargin - lp.bottomMargin;</div><div class="line">                        break;</div><div class="line">                    case Gravity.BOTTOM:</div><div class="line">                        childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">                        break;</div><div class="line">                    default:</div><div class="line">                        childTop = parentTop + lp.topMargin;</div><div class="line">                &#125;</div><div class="line">                //子布局根据位置调用layout自身布局</div><div class="line">                child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>FrameLayout中的onLayout又调用了自身的layoutChildren方法，从名字可以大致判断该方法是为子View确定位置的，layoutChildren中遍历FrameLayout下的所有子View，如果子View的Visibility属性不为GONE，根据父布局的位置计算子View的位置，主要和子View的gravity有关，最后再调用子View的layout方法确定位置，因此这里就解答了上面的疑惑，FrameLayout的位置是在父类View中就确定了的，不像measure流程大小是由子View的大小确定。另外FrameLayout extends ViewGroup extends View，分别再看下ViewGroup 和View中onLayout方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewGroup.java</div><div class="line">    protected abstract void onLayout(boolean changed,</div><div class="line">            int l, int t, int r, int b);</div><div class="line"></div><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Called from layout when this view should</div><div class="line">     * assign a size and position to each of its children.</div><div class="line">     *</div><div class="line">     * Derived classes with children should override</div><div class="line">     * this method and call layout on each of</div><div class="line">     * their children.</div><div class="line">     * @param changed This is a new size or position for this view</div><div class="line">     * @param left Left position, relative to parent</div><div class="line">     * @param top Top position, relative to parent</div><div class="line">     * @param right Right position, relative to parent</div><div class="line">     * @param bottom Bottom position, relative to parent</div><div class="line">     */</div><div class="line">    protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ViewGroup中的onLayout是个抽象方法，所以ViewGroup的子类必须实现onLayout，View中的onLayout是个空方法，所以具体的实现在子类中完成。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/layout.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/layout.png" alt="img"></a></p>
<ul>
<li>FrameLayout的位置是在父类View中就确定了的，不像measure流程大小是由子View的大小确定</li>
<li>自定义ViewGroup必须实现onLayout方法，因为在ViewGroup中该方法是个抽象方法</li>
<li>在layout执行完成后调用View的getWidth、getHeight方法才能返回有效值，因此位置是在layout步骤的setFrame方法中初始化的。</li>
<li>如果布局中的View的Visibility属性设置为GONE，则不对该View进行布局，该View不占据屏幕空间</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/25/Android View绘制源码分析--Measure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/25/Android View绘制源码分析--Measure/" itemprop="url">Android View绘制源码分析--Measure</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-25T00:00:00+08:00">
                2017-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/25/Android View绘制源码分析--Measure/" class="leancloud_visitors" data-flag-title="Android View绘制源码分析--Measure">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在Android中所有布局或者控件都直接或间接继承至View，因此它们拥有相同的绘制机制。以前的学习经验知道View在绘制过程中会经过measure、layout、draw三个流程，measure负责测量View的宽高，layout负责确定View在父容器中的位置，draw负责将View绘制到屏幕上。上篇文章分析到DecorView的绘制从ViewRootImpl类中的performTraversals开始，这篇主要分析View绘制流程中的measure部分。</p>
<h2 id="ViewRootImpl-performTraversals"><a href="#ViewRootImpl-performTraversals" class="headerlink" title="ViewRootImpl performTraversals()"></a>ViewRootImpl performTraversals()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl.java</div><div class="line">    private void performTraversals() &#123;</div><div class="line">        // cache mView since it is used so much below...</div><div class="line">        final View host = mView;</div><div class="line">        ......</div><div class="line">        WindowManager.LayoutParams lp = mWindowAttributes;</div><div class="line">        ......</div><div class="line">        int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);</div><div class="line">        int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);</div><div class="line">        // Ask host how big it wants to be</div><div class="line">        performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">        ......</div><div class="line">        performLayout(lp, mWidth, mHeight);</div><div class="line">        ......</div><div class="line">        performDraw();</div><div class="line">        ......</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>查看这里的getRootMeasureSpec方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/ViewRootImpl .java</div><div class="line">    /**</div><div class="line">     * Figures out the measure spec for the root view in a window based on it&apos;s</div><div class="line">     * layout params.</div><div class="line">     *</div><div class="line">     * @param windowSize</div><div class="line">     *            The available width or height of the window</div><div class="line">     *</div><div class="line">     * @param rootDimension</div><div class="line">     *            The layout params for one dimension (width or height) of the</div><div class="line">     *            window.</div><div class="line">     *</div><div class="line">     * @return The measure spec to use to measure the root view.</div><div class="line">     */</div><div class="line">    private static int getRootMeasureSpec(int windowSize, int rootDimension) &#123;</div><div class="line">        int measureSpec;</div><div class="line">        switch (rootDimension) &#123;</div><div class="line"></div><div class="line">        case ViewGroup.LayoutParams.MATCH_PARENT:</div><div class="line">            // Window can&apos;t resize. Force root view to be windowSize.</div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</div><div class="line">            break;</div><div class="line">        case ViewGroup.LayoutParams.WRAP_CONTENT:</div><div class="line">            // Window can resize. Set max size for root view.</div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            // Window wants to be an exact size. Force root view to be that size.</div><div class="line">            measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        return measureSpec;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>根据注释可知，该方法作用是根据根视图的布局参数推算出的其测量规格，这里的第二个参数传的是DecorView的LayoutParam对应的宽高，由之前的文章分析可知DecorView在生成布局时指定的宽高均为MATCH_PARENT，满足第一个分支，通过MeasureSpec的makeMeasureSpec方法生成测量规格并返回，查看该方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">        /**</div><div class="line">         * Creates a measure specification based on the supplied size and mode.</div><div class="line">         *</div><div class="line">         * The mode must always be one of the following:</div><div class="line">         * &lt;ul&gt;</div><div class="line">         *  &lt;li&gt;&#123;@link android.view.View.MeasureSpec#UNSPECIFIED&#125;&lt;/li&gt;</div><div class="line">         *  &lt;li&gt;&#123;@link android.view.View.MeasureSpec#EXACTLY&#125;&lt;/li&gt;</div><div class="line">         *  &lt;li&gt;&#123;@link android.view.View.MeasureSpec#AT_MOST&#125;&lt;/li&gt;</div><div class="line">         * &lt;/ul&gt;</div><div class="line">         *</div><div class="line">         * &lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; On API level 17 and lower, makeMeasureSpec&apos;s</div><div class="line">         * implementation was such that the order of arguments did not matter</div><div class="line">         * and overflow in either value could impact the resulting MeasureSpec.</div><div class="line">         * &#123;@link android.widget.RelativeLayout&#125; was affected by this bug.</div><div class="line">         * Apps targeting API levels greater than 17 will get the fixed, more strict</div><div class="line">         * behavior.&lt;/p&gt;</div><div class="line">         *</div><div class="line">         * @param size the size of the measure specification</div><div class="line">         * @param mode the mode of the measure specification</div><div class="line">         * @return the measure specification based on size and mode</div><div class="line">         */</div><div class="line">        public static int makeMeasureSpec(@IntRange(from = 0, to = (1 &lt;&lt; MeasureSpec.MODE_SHIFT) - 1) int size,</div><div class="line">                                          @MeasureSpecMode int mode) &#123;</div><div class="line">            if (sUseBrokenMakeMeasureSpec) &#123;</div><div class="line">                return size + mode;</div><div class="line">            &#125; else &#123;</div><div class="line">                return (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>根据注释可知，该方法将传入的大小和模式生成对应的测量规格，这里多说一点MeasureSpec，它是一个由模式和大小组合的32位int整型值，高二位代表mode，低30位代表size，计算中使用了位运算来提高并优化效率，MeasureSpec有三种模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Measure specification mode: The parent has not imposed any constraint</div><div class="line"> * on the child. It can be whatever size it wants.</div><div class="line"> */</div><div class="line">//不确定模式：父布局对子布局没有限制，子布局想要多大就多大，0左移30位</div><div class="line">public static final int UNSPECIFIED = 0 &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Measure specification mode: The parent has determined an exact size</div><div class="line"> * for the child. The child is going to be given those bounds regardless</div><div class="line"> * of how big it wants to be.</div><div class="line"> */</div><div class="line">//确定模式：父布局为子布局规定了一个准确的区域，不管子布局想要多大都不能超过规定范围，1左移30位</div><div class="line">public static final int EXACTLY     = 1 &lt;&lt; MODE_SHIFT;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Measure specification mode: The child can be as large as it wants up</div><div class="line"> * to the specified size.</div><div class="line"> */</div><div class="line">//最大模式：子布局可以和自己想要的一样大，2左移30位</div><div class="line">public static final int AT_MOST     = 2 &lt;&lt; MODE_SHIFT;</div></pre></td></tr></table></figure>
<p>回到上面，在获取到DecorView宽高的测量规格后，调用performMeasure()方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) &#123;</div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;measure&quot;);</div><div class="line">    try &#123;</div><div class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">    &#125; finally &#123;</div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据传入的宽高测量规格调用mView的measure方法，这里的mView就是DecorView，DecorView extends FrameLayout extends ViewGroup extends View，DecorView 、FrameLayout以及ViewGroup都没有重写measure方法，因此在View中查看measure方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * &lt;p&gt;</div><div class="line">     * This is called to find out how big a view should be. The parent</div><div class="line">     * supplies constraint information in the width and height parameters.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * The actual measurement work of a view is performed in</div><div class="line">     * &#123;@link #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line">     * &#123;@link #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     *</div><div class="line">     * @param widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line">     *        parent</div><div class="line">     * @param heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line">     *        parent</div><div class="line">     *</div><div class="line">     * @see #onMeasure(int, int)</div><div class="line">     */</div><div class="line">    public final void measure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">        boolean optical = isLayoutModeOptical(this);</div><div class="line">        if (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">            Insets insets = getOpticalInsets();</div><div class="line">            int oWidth  = insets.left + insets.right;</div><div class="line">            int oHeight = insets.top  + insets.bottom;</div><div class="line">            widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</div><div class="line">            heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Suppress sign extension for the low bytes</div><div class="line">        long key = (long) widthMeasureSpec &lt;&lt; 32 | (long) heightMeasureSpec &amp; 0xffffffffL;</div><div class="line">        if (mMeasureCache == null) mMeasureCache = new LongSparseLongArray(2);</div><div class="line"></div><div class="line">        final boolean forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</div><div class="line"></div><div class="line">        // Optimize layout by avoiding an extra EXACTLY pass when the view is</div><div class="line">        // already measured as the correct size. In API 23 and below, this</div><div class="line">        // extra pass is required to make LinearLayout re-distribute weight.</div><div class="line">        //与上次相比测量规格是否改变</div><div class="line">        final boolean specChanged = widthMeasureSpec != mOldWidthMeasureSpec</div><div class="line">                || heightMeasureSpec != mOldHeightMeasureSpec;</div><div class="line">        final boolean isSpecExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY</div><div class="line">                &amp;&amp; MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY;</div><div class="line">        final boolean matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec)</div><div class="line">                &amp;&amp; getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">        final boolean needsLayout = specChanged</div><div class="line">                &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);</div><div class="line"></div><div class="line">        if (forceLayout || needsLayout) &#123;</div><div class="line">            // first clears the measured dimension flag</div><div class="line">            mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</div><div class="line"></div><div class="line">            resolveRtlPropertiesIfNeeded();</div><div class="line"></div><div class="line">            int cacheIndex = forceLayout ? -1 : mMeasureCache.indexOfKey(key);</div><div class="line">            if (cacheIndex &lt; 0 || sIgnoreMeasureCache) &#123;</div><div class="line">                // measure ourselves, this should set the measured dimension flag back</div><div class="line">                //调用了onMeasure方法测量</div><div class="line">                onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">                mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">            &#125; else &#123;</div><div class="line">                long value = mMeasureCache.valueAt(cacheIndex);</div><div class="line">                // Casting a long to int drops the high 32 bits, no mask needed</div><div class="line">                setMeasuredDimensionRaw((int) (value &gt;&gt; 32), (int) value);</div><div class="line">                mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // flag not set, setMeasuredDimension() was not invoked, we raise</div><div class="line">            // an exception to warn the developer</div><div class="line">            if ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</div><div class="line">                throw new IllegalStateException(&quot;View with id &quot; + getId() + &quot;: &quot;</div><div class="line">                        + getClass().getName() + &quot;#onMeasure() did not set the&quot;</div><div class="line">                        + &quot; measured dimension by calling&quot;</div><div class="line">                        + &quot; setMeasuredDimension()&quot;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;</div><div class="line">        &#125;</div><div class="line">        //保存本次View的测量规格用于下次判断</div><div class="line">        mOldWidthMeasureSpec = widthMeasureSpec;</div><div class="line">        mOldHeightMeasureSpec = heightMeasureSpec;</div><div class="line"></div><div class="line">        mMeasureCache.put(key, ((long) mMeasuredWidth) &lt;&lt; 32 |</div><div class="line">                (long) mMeasuredHeight &amp; 0xffffffffL); // suppress sign extension</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从注释可知，该方法是查明一个View应该有多大，父布局可以在宽高参数中提供约束信息，实际的测量工作是在这个方法的onMeasure中完成的，因此，子类只能重写onMeasure方法。查看View的onMeasure方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Measure the view and its content to determine the measured width and the</div><div class="line"> * measured height. This method is invoked by &#123;@link #measure(int, int)&#125; and</div><div class="line"> * should be overridden by subclasses to provide accurate and efficient</div><div class="line"> * measurement of their contents.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line"> * &lt;em&gt;must&lt;/em&gt; call &#123;@link #setMeasuredDimension(int, int)&#125; to store the</div><div class="line"> * measured width and height of this view. Failure to do so will trigger an</div><div class="line"> * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line"> * &#123;@link #measure(int, int)&#125;. Calling the superclass&apos;</div><div class="line"> * &#123;@link #onMeasure(int, int)&#125; is a valid use.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * The base class implementation of measure defaults to the background size,</div><div class="line"> * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line"> * override &#123;@link #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line"> * their content.</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * &lt;p&gt;</div><div class="line"> * If this method is overridden, it is the subclass&apos;s responsibility to make</div><div class="line"> * sure the measured height and width are at least the view&apos;s minimum height</div><div class="line"> * and width (&#123;@link #getSuggestedMinimumHeight()&#125; and</div><div class="line"> * &#123;@link #getSuggestedMinimumWidth()&#125;).</div><div class="line"> * &lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param widthMeasureSpec horizontal space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;@link android.view.View.MeasureSpec&#125;.</div><div class="line"> * @param heightMeasureSpec vertical space requirements as imposed by the parent.</div><div class="line"> *                         The requirements are encoded with</div><div class="line"> *                         &#123;@link android.view.View.MeasureSpec&#125;.</div><div class="line"> *</div><div class="line"> * @see #getMeasuredWidth()</div><div class="line"> * @see #getMeasuredHeight()</div><div class="line"> * @see #setMeasuredDimension(int, int)</div><div class="line"> * @see #getSuggestedMinimumHeight()</div><div class="line"> * @see #getSuggestedMinimumWidth()</div><div class="line"> * @see android.view.View.MeasureSpec#getMode(int)</div><div class="line"> * @see android.view.View.MeasureSpec#getSize(int)</div><div class="line"> */</div><div class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注释里有一条很重要的介绍，setMeasuredDimension方法必须在onMeasure方法中调用，不然会抛异常。可以看到View的onMeasure内部只是调用了setMeasuredDimension方法，参数一个套一个，先看下setMeasuredDimension</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * &lt;p&gt;This method must be called by &#123;@link #onMeasure(int, int)&#125; to store the</div><div class="line"> * measured width and measured height. Failing to do so will trigger an</div><div class="line"> * exception at measurement time.&lt;/p&gt;</div><div class="line"> *</div><div class="line"> * @param measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * @param measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line">protected final void setMeasuredDimension(int measuredWidth, int measuredHeight) &#123;</div><div class="line">    boolean optical = isLayoutModeOptical(this);</div><div class="line">    if (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">        Insets insets = getOpticalInsets();</div><div class="line">        int opticalWidth  = insets.left + insets.right;</div><div class="line">        int opticalHeight = insets.top  + insets.bottom;</div><div class="line"></div><div class="line">        measuredWidth  += optical ? opticalWidth  : -opticalWidth;</div><div class="line">        measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">    &#125;</div><div class="line">    setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的setMeasuredDimension将传入的宽高值转手又传给了setMeasuredDimensionRaw</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Sets the measured dimension without extra processing for things like optical bounds.</div><div class="line"> * Useful for reapplying consistent values that have already been cooked with adjustments</div><div class="line"> * for optical bounds, etc. such as those from the measurement cache.</div><div class="line"> *</div><div class="line"> * @param measuredWidth The measured width of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> * @param measuredHeight The measured height of this view.  May be a complex</div><div class="line"> * bit mask as defined by &#123;@link #MEASURED_SIZE_MASK&#125; and</div><div class="line"> * &#123;@link #MEASURED_STATE_TOO_SMALL&#125;.</div><div class="line"> */</div><div class="line">private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) &#123;</div><div class="line">    mMeasuredWidth = measuredWidth;</div><div class="line">    mMeasuredHeight = measuredHeight;</div><div class="line"></div><div class="line">    mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个方法中只是将传入的宽高值对View的系统变量赋值，测量流程就走完了。返回看下之前嵌套的里的getDefaultSize方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Utility to return a default size. Uses the supplied size if the</div><div class="line"> * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line"> * by the MeasureSpec.</div><div class="line"> *</div><div class="line"> * @param size Default size for this view</div><div class="line"> * @param measureSpec Constraints imposed by the parent</div><div class="line"> * @return The size this view should be.</div><div class="line"> */</div><div class="line">public static int getDefaultSize(int size, int measureSpec) &#123;</div><div class="line">    int result = size;</div><div class="line">    int specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">    int specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">    switch (specMode) &#123;</div><div class="line">    case MeasureSpec.UNSPECIFIED:</div><div class="line">        result = size;</div><div class="line">        break;</div><div class="line">    case MeasureSpec.AT_MOST:</div><div class="line">    case MeasureSpec.EXACTLY:</div><div class="line">        result = specSize;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注释可知，该方法的作用是根据View布局设置的宽高和父布局传递的测量规格计算View的宽高，第二个参数是父布局的测量规格，因此子View最终大小是由自身布局大小和父布局的测量规格共同决定的。从上面的代码中可以看到，默认情况下，如果父布局指定的测量规格是MeasureSpec.AT_MOST或者MeasureSpec.EXACTLY，那么返回的测量大小是一样的，都是specSize；如果父布局指定的测量规格是MeasureSpec.UNSPECIFIED，那么返回的大小为size，即第一个参数值。specSize通过MeasureSpec.getSize获得，大小由父布局指定；size通过getSuggestedMinimumWidth方法获得：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Returns the suggested minimum width that the view should use. This</div><div class="line"> * returns the maximum of the view&apos;s minimum width</div><div class="line"> * and the background&apos;s minimum width</div><div class="line"> *  (&#123;@link android.graphics.drawable.Drawable#getMinimumWidth()&#125;).</div><div class="line"> * &lt;p&gt;</div><div class="line"> * When being used in &#123;@link #onMeasure(int, int)&#125;, the caller should still</div><div class="line"> * ensure the returned width is within the requirements of the parent.</div><div class="line"> *</div><div class="line"> * @return The suggested minimum width of the view.</div><div class="line"> */</div><div class="line">protected int getSuggestedMinimumWidth() &#123;</div><div class="line">    return (mBackground == null) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从注释可知，该方法返回View建议的最小宽高，也就是xml中设置的android:minWidth和 android:minHeight的值，建议的最小宽高是由View的Background尺寸与通过设置View的minWidth/minHeigh属性共同决定的，如果该View设置了Background，就返回minXXX与Background最小宽高中最大的那个。</p>
<h2 id="DecorView-onMeasure"><a href="#DecorView-onMeasure" class="headerlink" title="DecorView onMeasure"></a>DecorView onMeasure</h2><p>DecorView 、FrameLayout以及View中都有onMeasure方法，在View的measure方法中执行onMeasure时，会先执行DecorView 中onMeasure方法，具体如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line">源码路径：/SDK/sources/android-24/com/android/internal/policy/DecorView.java</div><div class="line">    @Override</div><div class="line">    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">        final DisplayMetrics metrics = getContext().getResources().getDisplayMetrics();</div><div class="line">        //是否竖屏</div><div class="line">        final boolean isPortrait =</div><div class="line">                getResources().getConfiguration().orientation == ORIENTATION_PORTRAIT;</div><div class="line">        //获取宽高Mode,这里获取的widthMode和heightMode都是MeasureSpec.EXACTLY</div><div class="line">        final int widthMode = getMode(widthMeasureSpec);</div><div class="line">        final int heightMode = getMode(heightMeasureSpec);</div><div class="line"></div><div class="line">        boolean fixedWidth = false;</div><div class="line">        mApplyFloatingHorizontalInsets = false;</div><div class="line">        //widthMode是MeasureSpec.EXACTLY所以不走这</div><div class="line">        if (widthMode == AT_MOST) &#123;</div><div class="line">            final TypedValue tvw = isPortrait ? mWindow.mFixedWidthMinor : mWindow.mFixedWidthMajor;</div><div class="line">            if (tvw != null &amp;&amp; tvw.type != TypedValue.TYPE_NULL) &#123;</div><div class="line">                final int w;</div><div class="line">                if (tvw.type == TypedValue.TYPE_DIMENSION) &#123;</div><div class="line">                    w = (int) tvw.getDimension(metrics);</div><div class="line">                &#125; else if (tvw.type == TypedValue.TYPE_FRACTION) &#123;</div><div class="line">                    w = (int) tvw.getFraction(metrics.widthPixels, metrics.widthPixels);</div><div class="line">                &#125; else &#123;</div><div class="line">                    w = 0;</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Fixed width: &quot; + w);</div><div class="line">                final int widthSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">                if (w &gt; 0) &#123;</div><div class="line">                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            Math.min(w, widthSize), EXACTLY);</div><div class="line">                    fixedWidth = true;</div><div class="line">                &#125; else &#123;</div><div class="line">                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            widthSize - mFloatingInsets.left - mFloatingInsets.right,</div><div class="line">                            AT_MOST);</div><div class="line">                    mApplyFloatingHorizontalInsets = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mApplyFloatingVerticalInsets = false;</div><div class="line">        //heightMode是MeasureSpec.EXACTLY所以不走这</div><div class="line">        if (heightMode == AT_MOST) &#123;</div><div class="line">            final TypedValue tvh = isPortrait ? mWindow.mFixedHeightMajor</div><div class="line">                    : mWindow.mFixedHeightMinor;</div><div class="line">            if (tvh != null &amp;&amp; tvh.type != TypedValue.TYPE_NULL) &#123;</div><div class="line">                final int h;</div><div class="line">                if (tvh.type == TypedValue.TYPE_DIMENSION) &#123;</div><div class="line">                    h = (int) tvh.getDimension(metrics);</div><div class="line">                &#125; else if (tvh.type == TypedValue.TYPE_FRACTION) &#123;</div><div class="line">                    h = (int) tvh.getFraction(metrics.heightPixels, metrics.heightPixels);</div><div class="line">                &#125; else &#123;</div><div class="line">                    h = 0;</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Fixed height: &quot; + h);</div><div class="line">                final int heightSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">                if (h &gt; 0) &#123;</div><div class="line">                    heightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            Math.min(h, heightSize), EXACTLY);</div><div class="line">                &#125; else if ((mWindow.getAttributes().flags &amp; FLAG_LAYOUT_IN_SCREEN) == 0) &#123;</div><div class="line">                    heightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                            heightSize - mFloatingInsets.top - mFloatingInsets.bottom, AT_MOST);</div><div class="line">                    mApplyFloatingVerticalInsets = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //获取开端</div><div class="line">        getOutsets(mOutsets);</div><div class="line">        if (mOutsets.top &gt; 0 || mOutsets.bottom &gt; 0) &#123;</div><div class="line">            int mode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">            if (mode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">                int height = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">                //重新计算高度测量规格</div><div class="line">                heightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        height + mOutsets.top + mOutsets.bottom, mode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (mOutsets.left &gt; 0 || mOutsets.right &gt; 0) &#123;</div><div class="line">            int mode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">            if (mode != MeasureSpec.UNSPECIFIED) &#123;</div><div class="line">                int width = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">                //重新计算宽度测量规格</div><div class="line">                widthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        width + mOutsets.left + mOutsets.right, mode);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //调用父类的onMeasure方法，也就是FrameLayout的onMeasure</div><div class="line">        super.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line"></div><div class="line">        int width = getMeasuredWidth();</div><div class="line">        boolean measure = false;</div><div class="line"></div><div class="line">        widthMeasureSpec = MeasureSpec.makeMeasureSpec(width, EXACTLY);</div><div class="line">        //widthMode是MeasureSpec.EXACTLY所以不走这</div><div class="line">        if (!fixedWidth &amp;&amp; widthMode == AT_MOST) &#123;</div><div class="line">            final TypedValue tv = isPortrait ? mWindow.mMinWidthMinor : mWindow.mMinWidthMajor;</div><div class="line">            if (tv.type != TypedValue.TYPE_NULL) &#123;</div><div class="line">                final int min;</div><div class="line">                if (tv.type == TypedValue.TYPE_DIMENSION) &#123;</div><div class="line">                    min = (int)tv.getDimension(metrics);</div><div class="line">                &#125; else if (tv.type == TypedValue.TYPE_FRACTION) &#123;</div><div class="line">                    min = (int)tv.getFraction(mAvailableWidth, mAvailableWidth);</div><div class="line">                &#125; else &#123;</div><div class="line">                    min = 0;</div><div class="line">                &#125;</div><div class="line">                if (DEBUG_MEASURE) Log.d(mLogTag, &quot;Adjust for min width: &quot; + min + &quot;, value::&quot;</div><div class="line">                        + tv.coerceToString() + &quot;, mAvailableWidth=&quot; + mAvailableWidth);</div><div class="line"></div><div class="line">                if (width &lt; min) &#123;</div><div class="line">                    widthMeasureSpec = MeasureSpec.makeMeasureSpec(min, EXACTLY);</div><div class="line">                    measure = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // TODO: Support height?</div><div class="line">        //measure为false所以不走这</div><div class="line">        if (measure) &#123;</div><div class="line">            super.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到，由于DecorView的LayoutParams为MATCH_PARENT，所以在getRootMeasureSpec里返回的测量规格是MeasureSpec.EXACTLY，所以这里的onMeasure并没有满足AT_MOST判断逻辑，看一下68行getOutsets方法，其实现是在View.java中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">源码路径:SDK/sources/android-24/android/view/View.java</div><div class="line">    /**</div><div class="line">     * Returns the outsets, which areas of the device that aren&apos;t a surface, but we would like to</div><div class="line">     * treat them as such.</div><div class="line">     * @hide</div><div class="line">     */</div><div class="line">    public void getOutsets(Rect outOutsetRect) &#123;</div><div class="line">        if (mAttachInfo != null) &#123;</div><div class="line">            outOutsetRect.set(mAttachInfo.mOutsets);</div><div class="line">        &#125; else &#123;</div><div class="line">            outOutsetRect.setEmpty();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">源码路径:SDK/sources/android-24/android/graphics/Rect.java</div><div class="line">    /**</div><div class="line">     * Set the rectangle to (0,0,0,0)</div><div class="line">     */</div><div class="line">    public void setEmpty() &#123;</div><div class="line">        left = right = top = bottom = 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>因此DecorView的onMeasure中判断如果left 、right 、top、bottom、大于0时，则加上这些值重新计算宽高测量规格，调用父类的onMeasure方法，查看FrameLayout的onMeasure</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">    //获取子View个数</div><div class="line">    int count = getChildCount();</div><div class="line">    //widthMeasureSpec和heightMeasureSpec都是MeasureSpec.EXACTLY，所以这里为false</div><div class="line">    final boolean measureMatchParentChildren =</div><div class="line">            MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">            MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">    mMatchParentChildren.clear();</div><div class="line"></div><div class="line">    int maxHeight = 0;</div><div class="line">    int maxWidth = 0;</div><div class="line">    int childState = 0;</div><div class="line"></div><div class="line">    for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">        final View child = getChildAt(i);</div><div class="line">        //遍历子View,只要Visibility不为GONE都会参与测量</div><div class="line">        if (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">            //测量子View的宽高</div><div class="line">            measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);</div><div class="line">            //获取子View的布局参数</div><div class="line">            final LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">            //计算子View的宽度，包括自身宽度加上leftMargin和rightMargin</div><div class="line">            maxWidth = Math.max(maxWidth,</div><div class="line">                    child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">            //计算子View的高度，包括自身高度加上topMargin和bottomMargin</div><div class="line">            maxHeight = Math.max(maxHeight,</div><div class="line">                    child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">            //保存测量状态</div><div class="line">            childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">            //measureMatchParentChildren这里为false</div><div class="line">            if (measureMatchParentChildren) &#123;</div><div class="line">                if (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">                        lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                    //保存那些布局参数声明为MATCH_PARENT的子View</div><div class="line">                    mMatchParentChildren.add(child);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Account for padding too</div><div class="line">    //如果有设置paddingLeft和paddingRight,则宽度值把这两个都算上</div><div class="line">    maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">    //如果有设置paddingTop和paddingBottom,则高度值把这两个都算上</div><div class="line">    maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line"></div><div class="line">    // Check against our minimum height and width</div><div class="line">    //和建议的宽高值中取最大</div><div class="line">    maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">    maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line"></div><div class="line">    // Check against our foreground&apos;s minimum height and width</div><div class="line">    //如果设置了Foreground,取最大值</div><div class="line">    final Drawable drawable = getForeground();</div><div class="line">    if (drawable != null) &#123;</div><div class="line">        maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">        maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">    &#125;</div><div class="line">    //所有的子View都测量完后，根据其中最大子View的宽高设置自己的宽高</div><div class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">            resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">                    childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</div><div class="line"></div><div class="line">    count = mMatchParentChildren.size();</div><div class="line">    //这块在DecorView流程中不走因为count=0</div><div class="line">    if (count &gt; 1) &#123;</div><div class="line">        for (int i = 0; i &lt; count; i++) &#123;</div><div class="line">            final View child = mMatchParentChildren.get(i);</div><div class="line">            final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line"></div><div class="line">            final int childWidthMeasureSpec;</div><div class="line">            if (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                final int width = Math.max(0, getMeasuredWidth()</div><div class="line">                        - getPaddingLeftWithForeground() - getPaddingRightWithForeground()</div><div class="line">                        - lp.leftMargin - lp.rightMargin);</div><div class="line">                childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        width, MeasureSpec.EXACTLY);</div><div class="line">            &#125; else &#123;</div><div class="line">                childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">                        getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">                        lp.leftMargin + lp.rightMargin,</div><div class="line">                        lp.width);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final int childHeightMeasureSpec;</div><div class="line">            if (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                final int height = Math.max(0, getMeasuredHeight()</div><div class="line">                        - getPaddingTopWithForeground() - getPaddingBottomWithForeground()</div><div class="line">                        - lp.topMargin - lp.bottomMargin);</div><div class="line">                childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                        height, MeasureSpec.EXACTLY);</div><div class="line">            &#125; else &#123;</div><div class="line">                childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">                        getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">                        lp.topMargin + lp.bottomMargin,</div><div class="line">                        lp.height);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法主要做了这几件事</p>
<ul>
<li>遍历子View，传入自身的测量规格，调用measureChildWithMargins测量除了Visibility属性设为GONE的子View的宽高</li>
<li>获取子View中最大的那个宽高，计算宽高值包括是否设置margin、padding、foreground，以及和建议的最小宽高比较</li>
<li>调用setMeasuredDimension方法，将最大的子View的宽高值作为自己的宽高值<br>看下这里的measureChildWithMargins方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/** * Ask one of the children of this view to measure itself, taking into</div><div class="line">    * account both the MeasureSpec requirements for this view and its padding </div><div class="line">    * and margins. The child must have MarginLayoutParams The heavy lifting is </div><div class="line">    * done in getChildMeasureSpec. </div><div class="line">    * * @param child The child to measure </div><div class="line">    * @param parentWidthMeasureSpec The width requirements for this view</div><div class="line">    * @param widthUsed Extra space that has been used up by the parent </div><div class="line">    *        horizontally (possibly by other children of the parent) </div><div class="line">    * @param parentHeightMeasureSpec The height requirements for this view</div><div class="line">    * @param heightUsed Extra space that has been used up by the parent </div><div class="line">    *        vertically (possibly by other children of the parent) </div><div class="line">    */</div><div class="line">    protected void measureChildWithMargins(View child,int parentWidthMeasureSpec, int widthUsed,int parentHeightMeasureSpec, int heightUsed) &#123; //获取子View的LayoutParams    final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();    //结合父布局的测量规格和padding，子View的margin和父布局已使用宽度大小widthUsed(前面设置为0)，以及子View自身宽度来获取子View宽度测量规格    </div><div class="line">    final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin                    + widthUsed, lp.width);   </div><div class="line">    //结合父布局的测量规格和padding，子View的margin和父布局已使用高度大小heightUsed(前面设置为0)，以及子View自身高度来获取子View高度测量规格    </div><div class="line">    final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin                    + heightUsed, lp.height);    </div><div class="line">//调用子View的measure方法，如果子View是ViewGroup则递归往下测量    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);&#125;</div></pre></td></tr></table></figure>
<p>该方法对父视图提供的measureSpec参数结合子View的LayoutParams参数，计算出子View的测量规格，再将测量规格传递给子View，最后由子View的measure方法完成测量，看下getChildMeasureSpec方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Does the hard part of measureChildren: figuring out the MeasureSpec to</div><div class="line"> * pass to a particular child. This method figures out the right MeasureSpec</div><div class="line"> * for one dimension (height or width) of one child view.</div><div class="line"> *</div><div class="line"> * The goal is to combine information from our MeasureSpec with the</div><div class="line"> * LayoutParams of the child to get the best possible results. For example,</div><div class="line"> * if the this view knows its size (because its MeasureSpec has a mode of</div><div class="line"> * EXACTLY), and the child has indicated in its LayoutParams that it wants</div><div class="line"> * to be the same size as the parent, the parent should ask the child to</div><div class="line"> * layout given an exact size.</div><div class="line"> *</div><div class="line"> * @param spec The requirements for this view</div><div class="line"> * @param padding The padding of this view for the current dimension and</div><div class="line"> *        margins, if applicable</div><div class="line"> * @param childDimension How big the child wants to be in the current</div><div class="line"> *        dimension</div><div class="line"> * @return a MeasureSpec integer for the child</div><div class="line"> */</div><div class="line">public static int getChildMeasureSpec(int spec, int padding, int childDimension) &#123;</div><div class="line">    //获取父布局测量规格</div><div class="line">    int specMode = MeasureSpec.getMode(spec);</div><div class="line">     //获取父布局大小</div><div class="line">    int specSize = MeasureSpec.getSize(spec);</div><div class="line">    //父布局的大小-父布局的Padding-子布局的Margin，得到值才是子布局的大小。</div><div class="line">    int size = Math.max(0, specSize - padding);</div><div class="line">    //初始化子布局Mode和Size，最后根据这两个值生成子布局的测量规格</div><div class="line">    int resultSize = 0;</div><div class="line">    int resultMode = 0;</div><div class="line"></div><div class="line">    switch (specMode) &#123;</div><div class="line">    // Parent has imposed an exact size on us</div><div class="line">    case MeasureSpec.EXACTLY:</div><div class="line">        if (childDimension &gt;= 0) &#123;</div><div class="line">            resultSize = childDimension;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            // Child wants to be our size. So be it.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">            // Child wants to determine its own size. It can&apos;t be</div><div class="line">            // bigger than us.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line"></div><div class="line">    // Parent has imposed a maximum size on us</div><div class="line">    case MeasureSpec.AT_MOST:</div><div class="line">        if (childDimension &gt;= 0) &#123;</div><div class="line">            // Child wants a specific size... so be it</div><div class="line">            resultSize = childDimension;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            // Child wants to be our size, but our size is not fixed.</div><div class="line">            // Constrain child to not be bigger than us.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">            // Child wants to determine its own size. It can&apos;t be</div><div class="line">            // bigger than us.</div><div class="line">            resultSize = size;</div><div class="line">            resultMode = MeasureSpec.AT_MOST;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line"></div><div class="line">    // Parent asked to see how big we want to be</div><div class="line">    case MeasureSpec.UNSPECIFIED:</div><div class="line">        if (childDimension &gt;= 0) &#123;</div><div class="line">            // Child wants a specific size... let him have it</div><div class="line">            resultSize = childDimension;</div><div class="line">            resultMode = MeasureSpec.EXACTLY;</div><div class="line">        &#125; else if (childDimension == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">            // Child wants to be our size... find out how big it should</div><div class="line">            // be</div><div class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</div><div class="line">            resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">        &#125; else if (childDimension == LayoutParams.WRAP_CONTENT) &#123;</div><div class="line">            // Child wants to determine its own size.... find out how</div><div class="line">            // big it should be</div><div class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</div><div class="line">            resultMode = MeasureSpec.UNSPECIFIED;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    //noinspection ResourceType  </div><div class="line">    //生成子布局的测量规格</div><div class="line">    return MeasureSpec.makeMeasureSpec(resultSize, resultMode);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由前面分析DecorView的specMode为MeasureSpec.EXACTLY，因此走第一个分支，这里分三种情况：</p>
<ul>
<li>如果子布局的width或height是一个精确的值，则测量大小就是这个精确值，测量模式为EXACTLY；</li>
<li>如果子布局的width或height是MATCH_PARENT，则测量大小是父布局-父布局的Padding-子布局的Margin，测量模式为EXACTLY</li>
<li>如果子布局的width或height是WRAP_CONTENT，则测量大小是父布局-父布局的Padding-子布局的Margin，测量模式为AT_MOST<br>最后再根据这里的测量大小和测量模式生成子布局的测量规格并返回，子布局根据计算得来的测量规格调用measure方法进行测量，如果子布局是ViewGroup，则递归往下测量，measureChildWithMargins方法执行完后，回到FrameLayout的onMeasure，在61行调用setMeasuredDimension方法，根据布局中最大的子View设置自己的宽高，测量完成。</li>
</ul>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>MainActivity.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends Activity &#123;</div><div class="line">    private InitView initView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        initView = (InitView) findViewById(R.id.initView);</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onCreate: width is &quot; + initView.getWidth());</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onCreate: measuredWidth is &quot; + initView.getMeasuredWidth());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onResume() &#123;</div><div class="line">        super.onResume();</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onResume: width is &quot; + initView.getWidth());</div><div class="line">        Log.d(&quot;hcy&quot;, &quot;onResume: measuredWidth is &quot; + initView.getMeasuredWidth());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义View</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class InitView extends View &#123;</div><div class="line">    private Paint mPaint;</div><div class="line"></div><div class="line">    public InitView(Context context)&#123;</div><div class="line">        this(context, null);</div><div class="line">    &#125;</div><div class="line">    public InitView(Context context, AttributeSet attrs) &#123;</div><div class="line">        this(context, attrs, 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public InitView(Context context, AttributeSet attrs, int defStyleAttr) &#123;</div><div class="line">        super(context, attrs, defStyleAttr);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void init() &#123;</div><div class="line">        mPaint = new Paint();</div><div class="line">        mPaint.setColor(Color.BLACK);</div><div class="line">        mPaint.setAntiAlias(true);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</div><div class="line">        int specMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">        switch (specMode) &#123;</div><div class="line">            case MeasureSpec.UNSPECIFIED:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;onMeasure: UNSPECIFIED&quot;);</div><div class="line">                break;</div><div class="line">            case MeasureSpec.EXACTLY:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;onMeasure: EXACTLY&quot;);</div><div class="line">                break;</div><div class="line">            case MeasureSpec.AT_MOST:</div><div class="line">                Log.d(&quot;hcy&quot;, &quot;onMeasure: AT_MOST&quot;);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">        super.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onDraw(Canvas canvas) &#123;</div><div class="line">        super.onDraw(canvas);</div><div class="line">        canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f, mPaint);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;com.hu.hcy.initview.InitView</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:id=&quot;@+id/initView&quot;</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;/&gt;</div></pre></td></tr></table></figure>
<ul>
<li><p>设置该View的布局参数为wrap_content，运行效果：</p>
<p>   <img src="http://7xjvg5.com1.z0.glb.clouddn.com/initView1.png" style="zoom:25%"></p>
</li>
</ul>
<p>打印log如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">05-24 10:45:27.359  7026  7026 D hcy     : onCreate: width is 0</div><div class="line">05-24 10:45:27.359  7026  7026 D hcy     : onCreate: measuredWidth is 0</div><div class="line">05-24 10:45:27.362  7026  7026 D hcy     : onResume: width is 0</div><div class="line">05-24 10:45:27.362  7026  7026 D hcy     : onResume: measuredWidth is 0</div><div class="line">05-24 10:45:27.399  7026  7026 D hcy     : onMeasure: AT_MOST</div></pre></td></tr></table></figure>
<ul>
<li><p>设置该View的布局参数为match_parent，运行效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/initView1.png" style="zoom:25%"></p>
<p>打印log如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">05-24 10:57:10.084  8526  8526 D hcy     : onCreate: width is 0</div><div class="line">05-24 10:57:10.084  8526  8526 D hcy     : onCreate: measuredWidth is 0</div><div class="line">05-24 10:57:10.101  8526  8526 D hcy     : onResume: width is 0</div><div class="line">05-24 10:57:10.101  8526  8526 D hcy     : onResume: measuredWidth is 0</div><div class="line">05-24 10:57:10.203  8526  8526 D hcy     : onMeasure: EXACTLY</div></pre></td></tr></table></figure>
</li>
<li><p>设置View的布局参数为精确值(layout_width=”100dp”，layout_height=”100dp”)，运行效果：</p>
<p><img src="http://7xjvg5.com1.z0.glb.clouddn.com/initView2.png" style="zoom:25%"></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">05-24 11:06:34.124 10903 10903 D hcy     : onCreate: width is 0</div><div class="line">05-24 11:06:34.124 10903 10903 D hcy     : onCreate: measuredWidth is 0</div><div class="line">05-24 11:06:34.126 10903 10903 D hcy     : onResume: width is 0</div><div class="line">05-24 11:06:34.126 10903 10903 D hcy     : onResume: measuredWidth is 0</div><div class="line">05-24 11:06:34.187 10903 10903 D hcy     : onMeasure: EXACTLY</div></pre></td></tr></table></figure>
<p>现象：</p>
<ul>
<li>指定View的布局参数为wrap_content，显示却充满整个屏幕，是因为Activity的父布局是id为content的FrameLayout，具体原因在上面getChildMeasureSpec方法中已经分析</li>
<li>在onCreate和onResume方法中无法获取到View的宽高，因为此时View的测量还没开始。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="http://7xjvg5.com1.z0.glb.clouddn.com/ViewMeasure.png" target="_blank" rel="external"><img src="http://7xjvg5.com1.z0.glb.clouddn.com/ViewMeasure.png" alt="img"></a></p>
<ul>
<li>View的measure方法由final修饰，子类无法重写，可以通过重写onMeasure方法来完成测量，重写onMeasure后必须调用setMeasuredDimension，当然也可以不重写，Android提供了一个默认测量视图View大小的实现getDefaultSize。</li>
<li>从流程图来看，measure过程是从顶层父布局向子布局递归调用view.measure方法，实际的测量工作是由onMeasure方法完成，在测量中起关键作用的是测量规格MeasureSpec，最顶层的DecorView的测量规格是通过ViewRootImpl的getRootMeasureSpec方法获得，LayoutParams的宽高均为MATCH_PARENT，specMode为EXACTLY，specSize为屏幕大小，子布局的测量规格由父布局的测量规格和自身的LayoutParams决定，待子布局确定好大小后，父布局再确定自身的大小</li>
<li>因为ActivityThread的performResumeActivity开始之后才会陆续调用到performTraversals()方法开始测量，所以在Activity的onCreate和onResume方法中调用View.getWidth()和View.getMeasuredHeight()返回值为0， 测量还未开始。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://rkhcy.github.io/2017/05/24/Screen Overlay Detected介绍与解决/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuYounger">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuYounger's Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/24/Screen Overlay Detected介绍与解决/" itemprop="url">Screen Overlay Detected介绍与解决</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-24T00:00:00+08:00">
                2017-05-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/05/24/Screen Overlay Detected介绍与解决/" class="leancloud_visitors" data-flag-title="Screen Overlay Detected介绍与解决">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
<div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>前阵子测试报了一个bug，说是在测试机上安装微信后显示Screen Overlay Detected提示框，然后不知道怎么操作。</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p><a href="http://upload-images.jianshu.io/upload_images/989851-8bf178c26e59783f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-8bf178c26e59783f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected.png"></a></p>
<p>如图所示，在第一次安装并打开微信的时候弹出Screen Overlay Detected提示</p>
<h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h2><p>在Android M以上引入了一个新功能，叫”Draw over other apps”，该功能允许一些apps覆盖在其他应用上，这就意味着这些apps可以在其他apps的顶部显示一些信息，例如Facebook Messenger使用该功能使它们的聊天覆盖在其他应用上。然而，当具备该功能的应用在前台或后台运行的时候，如果你安装新的应用，此时你的手机会提示”Screen Overlay Detected”，根据提示，你需要前往Settings–&gt;Apps中关闭screen overlay才能正常使用应用。</p>
<p>那么Screen Overlay Detected是什么呢，它有什么用？实际上它是Android一个额外的安全措施，用来防止一些流氓应用利用Android的默认设置，这些流氓应用可能是用户无意间安装的(不是通过play store)，当overlay功能运行的时候，这些流氓应用会做一些你不希望发生的事情，并请求权限，这些是Android所不允许的，所以会弹出”Screen Overlay Detected”的错误提示。也就是说出现这个提示属于正常现象，是Android在M以上的一个安全措施。那么如何解决这个问题呢？</p>
<h2 id="怎么解决"><a href="#怎么解决" class="headerlink" title="怎么解决"></a>怎么解决</h2><p>方法1：<br>首先进入Settings–&gt;Apps，点击右上角设置图标<br><a href="http://upload-images.jianshu.io/upload_images/989851-5a5076d0d6d18064.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-5a5076d0d6d18064.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected2.jpg"></a></p>
<p>点击”Draw over other apps”<br><a href="http://upload-images.jianshu.io/upload_images/989851-2495f8355f1fb2d6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-2495f8355f1fb2d6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected4.jpg"></a></p>
<p>可以看到一些允许覆盖在其他apps上<br><a href="http://upload-images.jianshu.io/upload_images/989851-60d9bad172b04a68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-60d9bad172b04a68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected5.png"></a></p>
<p>把当前界面中所有apps的”permit drawing over other apps”选项关闭<br><a href="http://upload-images.jianshu.io/upload_images/989851-8a58945b2f0d217a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-8a58945b2f0d217a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected3.jpg"></a><br>在Settings中清除下你要运行的app的数据，再次打开，不出意外的话可以正常运行该app；</p>
<p>方法2：什么，方法1没卵用？！！进入Settings–&gt;Apps，点击你要运行的apps，点击Permissions，</p>
<p><a href="http://upload-images.jianshu.io/upload_images/989851-32ae3a4307790e54.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" target="_blank" rel="external"><img src="http://upload-images.jianshu.io/upload_images/989851-32ae3a4307790e54.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="ScreenOverlayDetected6.jpg"></a></p>
<p>将所有的权限都勾选上，然后重新运行该应用</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>试了方法1之后发现微信仍然不能打开，接着试方案2，没想到刚刚勾选第一项就吃了闭门羹，还是提示”Screen Overlay Detected”，注意到这里截图的360悬浮窗，原来测试在360的悬浮窗设置中关闭了”仅在桌面显示”，因此这里的360悬浮窗可以覆盖在任何apps的上面，所以当新安装一些apps时，会弹出”Screen Overlay Detected”提示，这里把360悬浮窗关了，在Settings中赋予微信权限，然后微信就能正常运行了。感谢万能的Google，<a href="http://www.gadgetraid.com/2016/10/screen-overlay-detected/" target="_blank" rel="external">链接</a>中对于三星、一加、LG、摩托罗拉、HTC手机出现该提示具体怎么解决给了分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
     
     <div>    
      
  </div>
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="http://7xjvg5.com1.z0.glb.clouddn.com/avatar.jpeg"
              alt="HuYounger" />
          
            <p class="site-author-name" itemprop="name">HuYounger</p>
            <p class="site-description motion-element" itemprop="description">Less is more</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Rkhcy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuYounger</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("rcy0CA7vKecGb0eQxcnHdO3i-gzGzoHsz", "N9PBf4dqgEeMJL7klXsAli0a");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
